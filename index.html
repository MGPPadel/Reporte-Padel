import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';

// Global variables provided by the Canvas environment.
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Principal App component
const App = () => {
    // State variables for Firebase, user, data, and UI
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [inputValue, setInputValue] = useState('');
    const [savedData, setSavedData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // useEffect hook to initialize Firebase and handle authentication
    useEffect(() => {
        const initFirebase = async () => {
            try {
                // Initialize Firebase app
                const app = initializeApp(firebaseConfig);
                const firestoreDb = getFirestore(app);
                const firebaseAuth = getAuth(app);

                setDb(firestoreDb);
                setAuth(firebaseAuth);

                // Listen for authentication state changes
                const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                        // Once authenticated, set up real-time listener for data
                        if (firestoreDb) {
                            setupDataListener(firestoreDb, user.uid);
                        }
                    } else {
                        // Sign in anonymously if no user is found
                        await signInAnonymously(firebaseAuth);
                    }
                });

                // Clean up the listener on component unmount
                return () => unsubscribe();

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                setError("Error al inicializar Firebase. Por favor, revisa la consola para m√°s detalles.");
                setLoading(false);
            }
        };

        // Call the initialization function
        initFirebase();
    }, []); // Empty dependency array means this runs once on mount

    // Function to set up the real-time data listener
    const setupDataListener = (firestoreDb, currentUserId) => {
        try {
            // Document path to store user's private data
            const docRef = doc(firestoreDb, `artifacts/${appId}/users/${currentUserId}/mis_datos`, 'datos');
            
            // Set up a real-time listener with onSnapshot
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    setSavedData(docSnap.data().texto);
                } else {
                    setSavedData("No hay datos guardados a√∫n.");
                }
                setLoading(false);
            }, (err) => {
                console.error("Error al escuchar los datos:", err);
                setError("Error al cargar los datos. Por favor, revisa la consola.");
                setLoading(false);
            });

            // Clean up the listener
            return () => unsubscribe();

        } catch (e) {
            console.error("Error setting up data listener:", e);
            setError("Error al configurar el oyente de datos. Revisa la consola.");
            setLoading(false);
        }
    };

    // Function to save data to Firestore
    const saveData = async () => {
        if (!db || !userId) {
            setError('Error: No se ha iniciado sesi√≥n o la base de datos no est√° lista.');
            return;
        }

        try {
            // Document path to store user's private data
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mis_datos`, 'datos');
            await setDoc(docRef, {
                texto: inputValue,
                timestamp: new Date()
            });
            setInputValue(''); // Clear the input after saving
        } catch (e) {
            console.error("Error al guardar el documento:", e);
            setError("Error al guardar los datos. Por favor, int√©ntalo de nuevo.");
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 sm:p-6">
            <div className="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-md space-y-6">
                <h1 className="text-2xl sm:text-3xl font-bold text-center text-gray-800">
                    üíæ Sincronizaci√≥n en la Nube
                </h1>

                {/* Displaying User ID */}
                {userId && (
                    <div className="text-center text-sm text-gray-600 font-mono break-all">
                        <span className="font-bold">ID de Usuario:</span> {userId}
                    </div>
                )}

                {/* Error and Loading messages */}
                {error && (
                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm" role="alert">
                        <p>{error}</p>
                    </div>
                )}

                {loading && (
                    <div className="text-center text-gray-500 flex justify-center items-center">
                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Cargando datos...
                    </div>
                )}

                {/* Main input and button section */}
                {!loading && (
                    <>
                        <div className="flex flex-col space-y-4">
                            <input
                                type="text"
                                value={inputValue}
                                onChange={(e) => setInputValue(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                                placeholder="Escribe algo para guardar..."
                            />
                            <button
                                onClick={saveData}
                                className="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 disabled:bg-gray-400"
                                disabled={!inputValue.trim()}
                            >
                                Guardar en la Nube
                            </button>
                        </div>

                        {/* Display saved data */}
                        <div className="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h2 className="text-lg font-semibold text-gray-700 mb-2">Datos Guardados:</h2>
                            <p className="text-gray-900 break-words">{savedData || 'No hay datos guardados a√∫n.'}</p>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
};

export default App;













































