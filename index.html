<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe de Clases de Padel</title>

    <!-- React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and scrollbar styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #f3f4f6; }
    </style>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- html2canvas and jspdf for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail, browserSessionPersistence, setPersistence, browserLocalPersistence, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, onSnapshot, writeBatch, Timestamp, getDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyAvk1yOsxXfc2w4YwZ1R1tQFrQuM2AbEYk",
            authDomain: "app-de-padel.firebaseapp.com",
            projectId: "app-de-padel",
            storageBucket: "app-de-padel.firebasestorage.app",
            messagingSenderId: "731771747398",
            appId: "1:731771747398:web:ebc8b723fe220869fade47"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            window.firebase = {
                app, auth, db,
                signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword,
                sendPasswordResetEmail, browserSessionPersistence, setPersistence, browserLocalPersistence,
                signInWithCustomToken, signInAnonymously,
                collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, onSnapshot, writeBatch, Timestamp,
                getDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp, where,
                appId, initialAuthToken
            };
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const {
            auth, db, appId, initialAuthToken,
            signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail, setPersistence, browserSessionPersistence, browserLocalPersistence,
            collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, onSnapshot, writeBatch, Timestamp, getDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp, where
        } = window.firebase;

        // Componente aislado para el input con autocompletado (teclado + click + cierre al hacer clic fuera)
        const AutocompleteStudentInput = ({ index, value, newEntry, setNewEntry, students }) => {
            const [activeIndex, setActiveIndex] = React.useState(-1);
            const [open, setOpen] = React.useState(false);
            const containerRef = React.useRef(null);
        
            const filteredStudents = React.useMemo(() => {
                const term = (newEntry.studentNames[index] || "").toLowerCase();
                if (!term) return [];
                return students
                    .filter(stu => (`${stu.firstName} ${stu.lastName}`).toLowerCase().includes(term))
                    .slice(0, 5);
            }, [students, newEntry.studentNames, index]);

            // Cerrar al hacer clic fuera
            React.useEffect(() => {
                const handleClickOutside = (e) => {
                    if (containerRef.current && !containerRef.current.contains(e.target)) {
                        setOpen(false);
                        setActiveIndex(-1);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleKeyDown = (e) => {
                if (!open || filteredStudents.length === 0) return;
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    setActiveIndex((prev) => (prev + 1) % filteredStudents.length);
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    setActiveIndex((prev) => (prev <= 0 ? filteredStudents.length - 1 : prev - 1));
                } else if (e.key === "Enter" && activeIndex >= 0) {
                    e.preventDefault();
                    const stu = filteredStudents[activeIndex];
                    const newNames = [...newEntry.studentNames];
                    newNames[index] = `${stu.firstName} ${stu.lastName}`;
                    const newIds = [...(newEntry.studentIds || [])];
                    newIds[index] = stu.id;
                    setNewEntry((prev) => ({ ...prev, studentNames: newNames, studentIds: newIds }));
                    setActiveIndex(-1);
                    setOpen(false);
                }
            };
            const handleSelect = (stu) => {
                const newNames = [...newEntry.studentNames];
                newNames[index] = `${stu.firstName} ${stu.lastName}`;
                const newIds = [...(newEntry.studentIds || [])];
                newIds[index] = stu.id;
                setNewEntry((prev) => ({ ...prev, studentNames: newNames, studentIds: newIds }));
                setActiveIndex(-1);
                setOpen(false);
            };

            return (
                <div className="relative mb-2" ref={containerRef}>
                    <input
                        type="text"
                        placeholder={`Alumno ${index + 1}`}
                        value={newEntry.studentNames[index] || ""}
                        onChange={(e) => {
                            const val = e.target.value;
                            const newNames = [...newEntry.studentNames];
                            newNames[index] = val;
                            setNewEntry((prev) => ({ ...prev, studentNames: newNames }));
                            setActiveIndex(-1);
                            setOpen(true);
                        }}
                        onFocus={() => setOpen(true)}
                        onKeyDown={handleKeyDown}
                        className="peer p-3 w-full border rounded-lg focus:ring-2 focus:ring-blue-500 transition-shadow"
                    />
                    {/* Contenedor de sugerencias */}
                    {open && newEntry.studentNames[index] && filteredStudents.length > 0 && (
                        <div
                            className="absolute left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto z-50
                                       opacity-0 translate-y-1 scale-95 pointer-events-none
                                       transition-all duration-200 ease-out
                                       peer-focus:opacity-100 peer-focus:translate-y-0 peer-focus:scale-100 peer-focus:pointer-events-auto"
                        >
                            {filteredStudents.map((stu, i) => (
                                <div
                                    key={stu.id}
                                    onMouseDown={(e) => { e.preventDefault(); handleSelect(stu); }}
                                    onTouchStart={(e) => { e.preventDefault(); handleSelect(stu); }}
                                    className={`px-3 py-2 cursor-pointer transition-colors ${i === activeIndex ? "bg-blue-100 text-blue-800 font-semibold" : "hover:bg-gray-100"}`}
                                >
                                    {stu.firstName} {stu.lastName}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        const App = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [userId, setUserId] = useState(null);
            const [userEmail, setUserEmail] = useState('');
            const [loading, setLoading] = useState(true);
            const [classes, setClasses] = useState([]);
            const [students, setStudents] = useState([]);
            const [payments, setPayments] = useState([]);
            const [activityLog, setActivityLog] = useState([]);
            const [customPrices, setCustomPrices] = useState({ 1: 5000, 2: 3000, 3: 2500, 4: 2000 });
            const [currentPage, setCurrentPage] = useState(1);
            const [classesPerPage, setClassesPerPage] = useState(10); 
            const [newEntry, setNewEntry] = useState({
                studentCount: 1,
                studentNames: [''],
                studentIds: [''],
                date: new Date().toISOString().split('T')[0],
                day: new Date().toLocaleDateString('es-ES', { weekday: 'long' }),
                time: '8:00 a. m.',
                price: 5000,
            });
            const [newStudent, setNewStudent] = useState({
                firstName: '',
                lastName: '',
                phone: '',
                description: '',
                status: 'Activo',
            });
            const [isEditingStudent, setIsEditingStudent] = useState(false);
            const [editedStudentId, setEditedStudentId] = useState(null);
            const [filterStatus, setFilterStatus] = useState('Todos');
            const [studentSearch, setStudentSearch] = useState('');
            const filteredStudentsList = useMemo(() => {
                const term = (studentSearch || '').toLowerCase();
                return students.filter(s => {
                    const status = s.status || 'Activo';
                    const matchesStatus = filterStatus === 'Todos' || status === filterStatus;
                    const haystack = `${s.firstName || ''} ${s.lastName || ''} ${s.phone || ''} ${s.description || ''}`.toLowerCase();
                    const matchesSearch = !term || haystack.includes(term);
                    return matchesStatus && matchesSearch;
                });
            }, [students, studentSearch, filterStatus]);
            const [newPayment, setNewPayment] = useState({
                date: new Date().toISOString().split('T')[0],
                amount: 0,
                description: '',
            });
            const [isEditingPayment, setIsEditingPayment] = useState(false);
            const [editedPaymentId, setEditedPaymentId] = useState(null);
            const [monthlyReports, setMonthlyReports] = useState({});
            const [annualPaymentsReport, setAnnualPaymentsReport] = useState({});
            const [selectedMonthYear, setSelectedMonthYear] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [editedClassId, setEditedClassId] = useState(null);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [view, setView] = useState('list');
            const [filterText, setFilterText] = useState('');
            const [isSigningUp, setIsSigningUp] = useState(false);
            const [messageBox, setMessageBox] = useState({
                show: false,
                title: '',
                content: '',
                type: 'confirm',
                onConfirm: null,
            });
            const [tomorrowClasses, setTomorrowClasses] = useState([]);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [selectedClass, setSelectedClass] = useState(null);
            const [isAddingStudentToClass, setIsAddingStudentToClass] = useState(false);

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const fileInputRef = useRef(null);
            const reportTableRef = useRef(null);
            const annualPaymentsReportRef = useRef(null);

            const formatPrice = (price) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(price);
            const formatMonthYear = (monthYearString) => {
                const [year, month] = monthYearString.split('-');
                return new Date(year, month - 1).toLocaleString('es-AR', { month: 'long', year: 'numeric' });
            };
            const formatDate = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp.seconds * 1000);
                return date.toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            };

            const initializeFirebase = async () => {
                if (!window.firebase || !window.firebase.db) {
                    console.error("Firebase no está disponible. Revisa la configuración de los scripts.");
                    setLoading(false);
                    return;
                }
                dbRef.current = window.firebase.db;
                authRef.current = window.firebase.auth;

                if (window.firebase.initialAuthToken) {
                    try {
                        await window.firebase.signInWithCustomToken(authRef.current, window.firebase.initialAuthToken);
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        setMessageBox({ show: true, title: 'Error de autenticación', content: 'No se pudo iniciar sesión automáticamente. Por favor, recargue la página.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    }
                } else {
                    try {
                        await window.firebase.signInAnonymously(authRef.current);
                    } catch (error) {
                         console.error("Authentication failed:", error);
                         setMessageBox({ show: true, title: 'Error de autenticación', content: 'No se pudo iniciar sesión anónimamente. Por favor, recargue la página.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    }
                }

                const unsubscribe = onAuthStateChanged(authRef.current, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setUserEmail(user.email);
                    } else {
                        setUserId(null);
                        setUserEmail('');
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            };

            useEffect(() => {
                initializeFirebase();
            }, []);

            useEffect(() => {
                if (userId && dbRef.current) {
                    // Cargar clases
                    const classesRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/classes`);
                    const unsubscribeClasses = onSnapshot(classesRef, (snapshot) => {
                        const fetchedClasses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setClasses(fetchedClasses);
                    }, (error) => {
                        console.error("Error fetching classes:", error);
                    });

                    // Cargar alumnos
                    const studentsRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/students`);
                    const unsubscribeStudents = onSnapshot(studentsRef, (snapshot) => {
                        const fetchedStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStudents(fetchedStudents);
                    }, (error) => {
                        console.error("Error fetching students:", error);
                    });

                    // Cargar pagos
                    const paymentsRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/payments`);
                    const unsubscribePayments = onSnapshot(paymentsRef, (snapshot) => {
                        const fetchedPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setPayments(fetchedPayments);
                    }, (error) => {
                        console.error("Error fetching payments:", error);
                    });

                    // Cargar precios
                    const configRef = doc(dbRef.current, `artifacts/${appId}/users/${userId}/config/prices`);
                    const unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
                        if (docSnap.exists()) {
                            setCustomPrices(docSnap.data().prices);
                        }
                    }, (error) => {
                        console.error("Error fetching config:", error);
                    });

                    // Cargar log de actividad
                    const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);
                    const unsubscribeLog = onSnapshot(logRef, (snapshot) => {
                        const log = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        log.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                        setActivityLog(log);
                    }, (error) => {
                        console.error("Error fetching log:", error);
                    });
                    
                    // --- Listener para las clases de mañana (NUEVO) ---
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowDateString = tomorrow.toISOString().split('T')[0];
                    const tomorrowClassesRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/clases_programadas`);
                    const qClasses = query(tomorrowClassesRef, where("fecha", "==", tomorrowDateString));
                    const unsubscribeTomorrowClasses = onSnapshot(qClasses, (snapshot) => {
                        const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTomorrowClasses(classes);
                    }, (error) => {
                        console.error("Error fetching tomorrow's classes:", error);
                    });


                    return () => {
                        unsubscribeClasses();
                        unsubscribeStudents();
                        unsubscribePayments();
                        unsubscribeConfig();
                        unsubscribeLog();
                        unsubscribeTomorrowClasses();
                    };
                }
            }, [userId]);


            const signIn = async () => {
                try {
                    setLoading(true);
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                    setMessageBox({ show: true, title: 'Inicio de Sesión Exitoso', content: 'La sesión se mantendrá iniciada en este dispositivo.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error de autenticación', content: 'Usuario o contraseña incorrectos. Por favor, inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error signing in:", error);
                } finally {
                    setLoading(false);
                }
            };

            const signUp = async () => {
                try {
                    setLoading(true);
                    await createUserWithEmailAndPassword(auth, email, password);
                    setMessageBox({ show: true, title: 'Cuenta creada', content: 'Tu cuenta se ha creado exitosamente. ¡Ya puedes iniciar sesión!', type: 'success', onClose: () => { setMessageBox({ ...messageBox, show: false }); setIsSigningUp(false); } });
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error de registro', content: 'Hubo un error al crear la cuenta. Puede que el email ya esté en uso o la contraseña sea demasiado débil.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error signing up:", error);
                } finally {
                    setLoading(false);
                }
            };
            const handlePasswordReset = async () => {
                if (!email) {
                    setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, ingresa tu email para restablecer la contraseña.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    return;
                }
                try {
                    setLoading(true);
                    await sendPasswordResetEmail(auth, email);
                    setMessageBox({ show: true, title: 'Correo enviado', content: 'Se ha enviado un correo para restablecer tu contraseña. Revisa tu bandeja de entrada.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al enviar correo', content: 'Hubo un error al enviar el correo. Asegúrate de que el email sea correcto.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error sending password reset email:", error);
                } finally {
                    setLoading(false);
                }
            };
            const signOutUser = async () => {
                try {
                    await signOut(auth);
                    setUserId(null);
                    setClasses([]);
                    setStudents([]);
                    setPayments([]);
                    setActivityLog([]);
                    setMonthlyReports({});
                    setAnnualPaymentsReport({});
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };

            const saveCustomPrices = async () => {
                if (!dbRef.current || !userId) return;
                try {
                    setLoading(true);
                    const userDocRef = doc(dbRef.current, 'artifacts', appId, 'users', userId, 'config', 'prices');
                    await setDoc(userDocRef, { prices: customPrices });
                    setMessageBox({ show: true, title: 'Precios guardados', content: 'Los precios de las clases se han guardado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    console.error("Error saving custom prices:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al guardar los precios.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };

            const addClass = async () => {
                if (!dbRef.current || !userId) return;
                try {
                    setLoading(true);
                    const classRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/classes`);
                    const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);

                    await addDoc(classRef, {
                        ...newEntry,
                        price: newEntry.price || customPrices[newEntry.studentCount] || 0,
                        studentNames: newEntry.studentNames.filter(name => name.trim() !== ''),
                        timestamp: Timestamp.now(),
                    });

                    await addDoc(logRef, {
                        action: 'Clase Agregada',
                        description: `Se agregó una clase para ${newEntry.studentNames.filter(name => name.trim() !== '').join(', ')}.`,
                        timestamp: serverTimestamp(),
                    });

                    setNewEntry({
                        ...newEntry,
                        studentCount: 1,
                        studentNames: [''],
                        studentIds: [''],
                        price: customPrices[1] || 0,
                    });
                    setMessageBox({ show: true, title: 'Éxito', content: 'Clase agregada exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    console.error("Error adding class:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al agregar la clase.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };

            const addStudent = async () => {
                if (!dbRef.current || !userId) return;
                setLoading(true);
                try {
                    const studentRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/students`);
                    const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);

                    await addDoc(studentRef, {
                        ...newStudent,
                        created: Timestamp.now(),
                    });

                    await addDoc(logRef, {
                        action: 'Alumno Agregado',
                        description: `Se agregó un nuevo alumno: ${newStudent.firstName} ${newStudent.lastName}.`,
                        timestamp: serverTimestamp(),
                    });

                    setNewStudent({
                        firstName: '',
                        lastName: '',
                        phone: '',
                        description: '',
                        status: 'Activo'
                    });
                    setMessageBox({ show: true, title: 'Éxito', content: 'Alumno agregado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    setView('students');
                } catch (error) {
                    console.error("Error adding student:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al agregar el alumno.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };

            const editStudent = (student) => {
                setNewStudent({
                    firstName: student.firstName,
                    lastName: student.lastName,
                    phone: student.phone,
                    description: student.description,
                    status: student.status || 'Activo',
                });
                setEditedStudentId(student.id);
                setIsEditingStudent(true);
                setView('add-student');
            };

            const updateStudent = async () => {
                if (!dbRef.current || !userId || !editedStudentId) return;
                setLoading(true);
                try {
                    const studentDocRef = doc(dbRef.current, `artifacts/${appId}/users/${userId}/students`, editedStudentId);
                    const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);

                    await setDoc(studentDocRef, { ...newStudent, updated: Timestamp.now() }, { merge: true });

                    await addDoc(logRef, {
                        action: 'Alumno Editado',
                        description: `Se editó la información del alumno: ${newStudent.firstName} ${newStudent.lastName}.`,
                        timestamp: serverTimestamp(),
                    });

                    setNewStudent({ firstName: '', lastName: '', phone: '', description: '', status: 'Activo' });
                    setEditedStudentId(null);
                    setIsEditingStudent(false);
                    setMessageBox({ show: true, title: 'Éxito', content: 'Alumno actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    setView('students');
                } catch (error) {
                    console.error("Error updating student:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al actualizar el alumno.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };

            const deleteStudent = (studentId) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar Eliminación',
                    content: '¿Estás seguro de que deseas eliminar a este alumno? Esta acción no se puede deshacer.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        setLoading(true);
                        try {
                            await deleteDoc(doc(dbRef.current, `artifacts/${appId}/users/${userId}/students`, studentId));
                            setMessageBox({ show: true, title: 'Éxito', content: 'Alumno eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } catch (error) {
                            console.error("Error deleting student:", error);
                            setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al eliminar el alumno.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            const addPayment = async () => {
                if (!dbRef.current || !userId) return;
                setLoading(true);
                try {
                    const paymentsRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/payments`);
                    const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);

                    await addDoc(paymentsRef, {
                        ...newPayment,
                        timestamp: Timestamp.now(),
                    });

                    await addDoc(logRef, {
                        action: 'Pago Registrado',
                        description: `Se registró un pago de ${formatPrice(newPayment.amount)} para ${newPayment.description}.`,
                        timestamp: serverTimestamp(),
                    });

                    setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' });
                    setMessageBox({ show: true, title: 'Éxito', content: 'Pago registrado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    console.error("Error adding payment:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al registrar el pago.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };
            const editPayment = (payment) => {
                setNewPayment({
                    date: payment.date,
                    amount: payment.amount,
                    description: payment.description,
                });
                setEditedPaymentId(payment.id);
                setIsEditingPayment(true);
                setView('payments');
            };

            const updatePayment = async () => {
                if (!dbRef.current || !userId || !editedPaymentId) return;
                setLoading(true);
                try {
                    const paymentDocRef = doc(dbRef.current, `artifacts/${appId}/users/${userId}/payments`, editedPaymentId);
                    const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);

                    await setDoc(paymentDocRef, { ...newPayment, updated: Timestamp.now() }, { merge: true });

                    await addDoc(logRef, {
                        action: 'Pago Editado',
                        description: `Se editó un pago para ${newPayment.description}.`,
                        timestamp: serverTimestamp(),
                    });

                    setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' });
                    setEditedPaymentId(null);
                    setIsEditingPayment(false);
                    setMessageBox({ show: true, title: 'Éxito', content: 'Pago actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    console.error("Error updating payment:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al actualizar el pago.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };

            const deletePayment = (paymentId) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar Eliminación',
                    content: '¿Estás seguro de que deseas eliminar este pago? Esta acción no se puede deshacer.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        setLoading(true);
                        try {
                            await deleteDoc(doc(dbRef.current, `artifacts/${appId}/users/${userId}/payments`, paymentId));
                            setMessageBox({ show: true, title: 'Éxito', content: 'Pago eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } catch (error) {
                            console.error("Error deleting payment:", error);
                            setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al eliminar el pago.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            const generateReports = () => {
                const now = new Date();
                const currentMonth = now.toISOString().substring(0, 7);
                const monthly = {};
                const annual = {};

                classes.forEach(cls => {
                    const month = cls.date.substring(0, 7);
                    if (!monthly[month]) monthly[month] = { income: 0, classes: 0, students: new Set() };
                    monthly[month].income += cls.price;
                    monthly[month].classes++;
                    if (cls.studentIds) cls.studentIds.forEach(id => monthly[month].students.add(id));
                });

                payments.forEach(pay => {
                    const year = pay.date.substring(0, 4);
                    if (!annual[year]) annual[year] = { income: 0, payments: 0 };
                    annual[year].income += pay.amount;
                    annual[year].payments++;
                });

                setMonthlyReports(monthly);
                setAnnualPaymentsReport(annual);
                setSelectedMonthYear(currentMonth);
                setView('reports');
            };

            const downloadPDF = async () => {
                setMessageBox({ show: true, title: 'Generando PDF', content: 'Por favor, espere...', type: 'info', onClose: () => {} });
                try {
                    const reportElement = reportTableRef.current;
                    const canvas = await html2canvas(reportElement, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`Reporte_Mensual_${selectedMonthYear}.pdf`);
                    setMessageBox({ show: true, title: 'Descarga completa', content: 'El PDF se ha descargado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al generar el PDF.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                }
            };

            const downloadAnnualPDF = async () => {
                setMessageBox({ show: true, title: 'Generando PDF', content: 'Por favor, espere...', type: 'info', onClose: () => {} });
                try {
                    const reportElement = annualPaymentsReportRef.current;
                    const canvas = await html2canvas(reportElement, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`Reporte_Anual_Pagos.pdf`);
                    setMessageBox({ show: true, title: 'Descarga completa', content: 'El PDF se ha descargado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al generar el PDF.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                }
            };
            const paginatedClasses = useMemo(() => {
                const filtered = classes.filter(cls => {
                    const dateMatch = cls.date.includes(filterText);
                    const studentMatch = cls.studentNames.some(name => name.toLowerCase().includes(filterText.toLowerCase()));
                    return dateMatch || studentMatch;
                }).sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                const startIndex = (currentPage - 1) * classesPerPage;
                return filtered.slice(startIndex, startIndex + classesPerPage);
            }, [classes, currentPage, classesPerPage, filterText]);
            const totalPages = useMemo(() => {
                const filtered = classes.filter(cls => {
                    const dateMatch = cls.date.includes(filterText);
                    const studentMatch = cls.studentNames.some(name => name.toLowerCase().includes(filterText.toLowerCase()));
                    return dateMatch || studentMatch;
                });
                return Math.ceil(filtered.length / classesPerPage);
            }, [classes, classesPerPage, filterText]);
            const handleEdit = (cls) => {
                setNewEntry({
                    studentCount: cls.studentCount,
                    studentNames: cls.studentNames,
                    studentIds: cls.studentIds,
                    date: cls.date,
                    day: cls.day,
                    time: cls.time,
                    price: cls.price,
                });
                setIsEditing(true);
                setEditedClassId(cls.id);
                setView('add');
            };
            const updateClass = async () => {
                if (!dbRef.current || !userId || !editedClassId) return;
                setLoading(true);
                try {
                    const classDocRef = doc(dbRef.current, `artifacts/${appId}/users/${userId}/classes`, editedClassId);
                    const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);

                    await setDoc(classDocRef, {
                        ...newEntry,
                        price: newEntry.price || customPrices[newEntry.studentCount] || 0,
                        studentNames: newEntry.studentNames.filter(name => name.trim() !== ''),
                    }, { merge: true });

                    await addDoc(logRef, {
                        action: 'Clase Editada',
                        description: `Se editó la clase de ${newEntry.studentNames.filter(name => name.trim() !== '').join(', ')}.`,
                        timestamp: serverTimestamp(),
                    });

                    setNewEntry({
                        ...newEntry,
                        studentCount: 1,
                        studentNames: [''],
                        studentIds: [''],
                        price: customPrices[1] || 0,
                    });
                    setIsEditing(false);
                    setEditedClassId(null);
                    setMessageBox({ show: true, title: 'Éxito', content: 'Clase actualizada exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    setView('list');
                } catch (error) {
                    console.error("Error updating class:", error);
                    setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al actualizar la clase.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };
            const handleDelete = (cls) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar Eliminación',
                    content: '¿Estás seguro de que deseas eliminar esta clase?',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        setLoading(true);
                        try {
                            const classDocRef = doc(dbRef.current, `artifacts/${appId}/users/${userId}/classes`, cls.id);
                            const logRef = collection(dbRef.current, `artifacts/${appId}/users/${userId}/activityLog`);
                            await deleteDoc(classDocRef);
                            await addDoc(logRef, {
                                action: 'Clase Eliminada',
                                description: `Se eliminó la clase de ${cls.studentNames.join(', ')}.`,
                                timestamp: serverTimestamp(),
                            });
                            setMessageBox({ show: true, title: 'Éxito', content: 'Clase eliminada exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } catch (error) {
                            console.error("Error deleting class:", error);
                            setMessageBox({ show: true, title: 'Error', content: 'Hubo un error al eliminar la clase.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            if (loading) {
                return (
                    <div className="flex justify-center items-center min-h-screen bg-gray-100">
                        <div className="text-center text-gray-500">
                            <i className="fas fa-spinner fa-spin text-4xl mb-2"></i>
                            <p>Cargando...</p>
                        </div>
                    </div>
                );
            }

            if (!userId) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                            <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                                {isSigningUp ? 'Crear Cuenta' : 'Iniciar Sesión'}
                            </h1>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">Email</label>
                                    <input
                                        id="email"
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="Ingresa tu email"
                                        className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    />
                                </div>
                                <div>
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">Contraseña</label>
                                    <input
                                        id="password"
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="Ingresa tu contraseña"
                                        className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                                    />
                                </div>
                                {isSigningUp ? (
                                    <>
                                        <button onClick={signUp} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:shadow-outline">
                                            Registrarse
                                        </button>
                                        <button onClick={() => setIsSigningUp(false)} className="w-full mt-2 text-sm text-gray-500 hover:text-gray-800">
                                            Ya tengo una cuenta
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={signIn} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:shadow-outline">
                                            Iniciar Sesión
                                        </button>
                                        <button onClick={() => setIsSigningUp(true)} className="w-full mt-2 text-sm text-gray-500 hover:text-gray-800">
                                            Crear una cuenta
                                        </button>
                                        <button onClick={handlePasswordReset} className="w-full mt-2 text-sm text-gray-500 hover:text-gray-800">
                                            ¿Olvidaste tu contraseña?
                                        </button>
                                    </>
                                )}
                            </div>
                            <MessageBox {...messageBox} />
                        </div>
                    </div>
                );
            }

            // Días y horas actualizados según tu solicitud
            const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
            const horasClase = ['08:00', '09:00', '10:00', '11:00', '12:00'];

            const today = new Date().toISOString().split('T')[0];
            const tomorrowInfo = (() => {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dayOfWeek = tomorrow.toLocaleDateString('es-ES', { weekday: 'long' });
                const dateString = tomorrow.toISOString().split('T')[0];
                return { dateString, dayOfWeek: dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) };
            })();

            const ClassForm = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">{isEditing ? 'Editar Clase' : 'Agregar Nueva Clase'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); isEditing ? updateClass() : addClass(); }} className="space-y-4">
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Fecha</label>
                            <input
                                type="date"
                                value={newEntry.date}
                                onChange={(e) => setNewEntry({ ...newEntry, date: e.target.value })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Día de la semana</label>
                            <select
                                value={newEntry.day}
                                onChange={(e) => setNewEntry({ ...newEntry, day: e.target.value })}
                                className="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                required
                            >
                                <option value="">Selecciona un día</option>
                                {diasSemana.map(day => (
                                    <option key={day} value={day}>{day}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Hora</label>
                            <select
                                value={newEntry.time}
                                onChange={(e) => setNewEntry({ ...newEntry, time: e.target.value })}
                                className="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                required
                            >
                                <option value="">Selecciona una hora</option>
                                {horasClase.map(time => (
                                    <option key={time} value={time}>{time}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Número de Alumnos</label>
                            <select
                                value={newEntry.studentCount}
                                onChange={(e) => {
                                    const count = parseInt(e.target.value);
                                    const newNames = Array(count).fill('');
                                    const newIds = Array(count).fill('');
                                    setNewEntry({
                                        ...newEntry,
                                        studentCount: count,
                                        studentNames: newNames,
                                        studentIds: newIds,
                                        price: customPrices[count] || 0
                                    });
                                }}
                                className="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            >
                                {peopleOptions.map(option => (
                                    <option key={option} value={option}>{option}</option>
                                ))}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <label className="block text-gray-700 text-sm font-bold mb-2">Nombres de Alumnos</label>
                            {Array.from({ length: newEntry.studentCount }).map((_, index) => (
                                <AutocompleteStudentInput
                                    key={index}
                                    index={index}
                                    value={newEntry.studentNames[index] || ""}
                                    newEntry={newEntry}
                                    setNewEntry={setNewEntry}
                                    students={students}
                                />
                            ))}
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Precio Total</label>
                            <input
                                type="number"
                                value={newEntry.price}
                                onChange={(e) => setNewEntry({ ...newEntry, price: parseFloat(e.target.value) || 0 })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            {isEditing ? 'Actualizar Clase' : 'Guardar Clase'}
                        </button>
                    </form>
                </div>
            );

            const StudentForm = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">{isEditingStudent ? 'Editar Alumno' : 'Agregar Nuevo Alumno'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); isEditingStudent ? updateStudent() : addStudent(); }} className="space-y-4">
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Nombre</label>
                            <input
                                type="text"
                                value={newStudent.firstName}
                                onChange={(e) => setNewStudent({ ...newStudent, firstName: e.target.value })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Apellido</label>
                            <input
                                type="text"
                                value={newStudent.lastName}
                                onChange={(e) => setNewStudent({ ...newStudent, lastName: e.target.value })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Teléfono</label>
                            <input
                                type="tel"
                                value={newStudent.phone}
                                onChange={(e) => setNewStudent({ ...newStudent, phone: e.target.value })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Descripción</label>
                            <textarea
                                value={newStudent.description}
                                onChange={(e) => setNewStudent({ ...newStudent, description: e.target.value })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                            ></textarea>
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Estado</label>
                            <select
                                value={newStudent.status}
                                onChange={(e) => setNewStudent({ ...newStudent, status: e.target.value })}
                                className="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            >
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            {isEditingStudent ? 'Actualizar Alumno' : 'Guardar Alumno'}
                        </button>
                    </form>
                </div>
            );
            const PaymentForm = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">{isEditingPayment ? 'Editar Pago' : 'Registrar Nuevo Pago'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); isEditingPayment ? updatePayment() : addPayment(); }} className="space-y-4">
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Fecha</label>
                            <input
                                type="date"
                                value={newPayment.date}
                                onChange={(e) => setNewPayment({ ...newPayment, date: e.target.value })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Monto</label>
                            <input
                                type="number"
                                value={newPayment.amount}
                                onChange={(e) => setNewPayment({ ...newPayment, amount: parseFloat(e.target.value) || 0 })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 text-sm font-bold mb-2">Descripción</label>
                            <input
                                type="text"
                                value={newPayment.description}
                                onChange={(e) => setNewPayment({ ...newPayment, description: e.target.value })}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                placeholder="Ej: Pago de cuota de Juan Perez"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            {isEditingPayment ? 'Actualizar Pago' : 'Guardar Pago'}
                        </button>
                    </form>
                </div>
            );
            const classesTable = (
                <div className="overflow-x-auto bg-white p-6 rounded-xl shadow-lg">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Clases Registradas</h2>
                        <div className="flex items-center">
                            <i className="fas fa-search text-gray-400 mr-2"></i>
                            <input
                                type="text"
                                placeholder="Filtrar..."
                                value={filterText}
                                onChange={(e) => {
                                    setFilterText(e.target.value);
                                    setCurrentPage(1);
                                }}
                                className="border rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                    </div>
                    <table className="min-w-full leading-normal">
                        <thead>
                            <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th className="py-3 px-6 text-left">Fecha</th>
                                <th className="py-3 px-6 text-left">Día</th>
                                <th className="py-3 px-6 text-left">Hora</th>
                                <th className="py-3 px-6 text-left">Alumnos</th>
                                <th className="py-3 px-6 text-center">Precio</th>
                                <th className="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody className="text-gray-600 text-sm font-light">
                            {paginatedClasses.length > 0 ? (
                                paginatedClasses.map(cls => (
                                    <tr key={cls.id} className="border-b border-gray-200 hover:bg-gray-100 transition-colors">
                                        <td className="py-3 px-6 text-left whitespace-nowrap">{cls.date}</td>
                                        <td className="py-3 px-6 text-left">{cls.day}</td>
                                        <td className="py-3 px-6 text-left">{cls.time}</td>
                                        <td className="py-3 px-6 text-left">
                                            {cls.studentNames && cls.studentNames.length > 0 ? (
                                                <ul className="list-disc list-inside">
                                                    {cls.studentNames.map((name, i) => <li key={i}>{name}</li>)}
                                                </ul>
                                            ) : 'N/A'}
                                        </td>
                                        <td className="py-3 px-6 text-center">{formatPrice(cls.price)}</td>
                                        <td className="py-3 px-6 text-center">
                                            <div className="flex item-center justify-center space-x-2">
                                                <button onClick={() => handleEdit(cls)} className="w-6 h-6 transform hover:text-blue-500 hover:scale-110 transition-transform">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => handleDelete(cls)} className="w-6 h-6 transform hover:text-red-500 hover:scale-110 transition-transform">
                                                    <i className="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr>
                                    <td colSpan="6" className="text-center py-4 text-gray-500">No hay clases registradas.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                    <div className="flex justify-between items-center mt-4">
                        <div>
                            <span className="text-sm text-gray-700">
                                Mostrando <span className="font-semibold">{Math.min(classesPerPage, paginatedClasses.length)}</span> de <span className="font-semibold">{classes.length}</span> clases
                            </span>
                        </div>
                        <div className="flex space-x-2">
                            <button
                                onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                                disabled={currentPage === 1}
                                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Anterior
                            </button>
                            <button
                                onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                                disabled={currentPage === totalPages}
                                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Siguiente
                            </button>
                        </div>
                    </div>
                </div>
            );
            const studentsTable = (
                <div className="overflow-x-auto bg-white p-6 rounded-xl shadow-lg">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Listado de Alumnos</h2>
                        <div className="flex items-center space-x-2">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Buscar alumno..."
                                    value={studentSearch}
                                    onChange={(e) => setStudentSearch(e.target.value)}
                                    className="border rounded-lg p-2 pl-8 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <select
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                                className="border rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="Todos">Todos</option>
                                <option value="Activo">Activos</option>
                                <option value="Inactivo">Inactivos</option>
                            </select>
                        </div>
                    </div>
                    <table className="min-w-full leading-normal">
                        <thead>
                            <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th className="py-3 px-6 text-left">Nombre</th>
                                <th className="py-3 px-6 text-left">Teléfono</th>
                                <th className="py-3 px-6 text-left">Estado</th>
                                <th className="py-3 px-6 text-left">Descripción</th>
                                <th className="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody className="text-gray-600 text-sm font-light">
                            {filteredStudentsList.length > 0 ? (
                                filteredStudentsList.map(stu => (
                                    <tr key={stu.id} className="border-b border-gray-200 hover:bg-gray-100 transition-colors">
                                        <td className="py-3 px-6 text-left">{stu.firstName} {stu.lastName}</td>
                                        <td className="py-3 px-6 text-left">{stu.phone}</td>
                                        <td className="py-3 px-6 text-left">
                                            <span className={`px-2 py-1 rounded-full text-xs font-semibold ${stu.status === 'Activo' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}`}>
                                                {stu.status || 'Activo'}
                                            </span>
                                        </td>
                                        <td className="py-3 px-6 text-left">{stu.description}</td>
                                        <td className="py-3 px-6 text-center">
                                            <div className="flex item-center justify-center space-x-2">
                                                <button onClick={() => editStudent(stu)} className="w-6 h-6 transform hover:text-blue-500 hover:scale-110 transition-transform">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => deleteStudent(stu.id)} className="w-6 h-6 transform hover:text-red-500 hover:scale-110 transition-transform">
                                                    <i className="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr>
                                    <td colSpan="5" className="text-center py-4 text-gray-500">No hay alumnos registrados.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
            const paymentsTable = (
                <div className="overflow-x-auto bg-white p-6 rounded-xl shadow-lg">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Pagos Registrados</h2>
                        <button onClick={() => setView('add-payment')} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            <i className="fas fa-plus mr-1"></i> Registrar Pago
                        </button>
                    </div>
                    <table className="min-w-full leading-normal">
                        <thead>
                            <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th className="py-3 px-6 text-left">Fecha</th>
                                <th className="py-3 px-6 text-left">Monto</th>
                                <th className="py-3 px-6 text-left">Descripción</th>
                                <th className="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody className="text-gray-600 text-sm font-light">
                            {payments.length > 0 ? (
                                payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(pay => (
                                    <tr key={pay.id} className="border-b border-gray-200 hover:bg-gray-100 transition-colors">
                                        <td className="py-3 px-6 text-left whitespace-nowrap">{pay.date}</td>
                                        <td className="py-3 px-6 text-left">{formatPrice(pay.amount)}</td>
                                        <td className="py-3 px-6 text-left">{pay.description}</td>
                                        <td className="py-3 px-6 text-center">
                                            <div className="flex item-center justify-center space-x-2">
                                                <button onClick={() => editPayment(pay)} className="w-6 h-6 transform hover:text-blue-500 hover:scale-110 transition-transform">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => deletePayment(pay.id)} className="w-6 h-6 transform hover:text-red-500 hover:scale-110 transition-transform">
                                                    <i className="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr>
                                    <td colSpan="4" className="text-center py-4 text-gray-500">No hay pagos registrados.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
            const reports = (
                <div className="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">Informes y Reportes</h2>
                    <div className="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
                        <div className="flex-1">
                            <label className="block text-gray-700 text-sm font-bold mb-2">Seleccionar Mes</label>
                            <select
                                value={selectedMonthYear}
                                onChange={(e) => setSelectedMonthYear(e.target.value)}
                                className="shadow border rounded w-full py-2 px-3 text-gray-700"
                            >
                                {Object.keys(monthlyReports).sort().reverse().map(month => (
                                    <option key={month} value={month}>{formatMonthYear(month)}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex-1">
                            <button
                                onClick={downloadPDF}
                                className="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                            >
                                <i className="fas fa-file-pdf mr-2"></i>Descargar PDF Mensual
                            </button>
                        </div>
                    </div>
                    {selectedMonthYear && monthlyReports[selectedMonthYear] && (
                        <div ref={reportTableRef} className="p-4 bg-gray-50 rounded-lg">
                            <h3 className="text-center text-lg font-bold mb-4">Reporte de {formatMonthYear(selectedMonthYear)}</h3>
                            <div className="grid grid-cols-2 gap-4 text-center text-sm font-semibold mb-4">
                                <div className="bg-blue-100 p-2 rounded-lg">
                                    <p className="text-blue-800">Ingresos Totales</p>
                                    <p className="text-xl font-bold text-blue-900">{formatPrice(monthlyReports[selectedMonthYear].income)}</p>
                                </div>
                                <div className="bg-purple-100 p-2 rounded-lg">
                                    <p className="text-purple-800">Clases Dictadas</p>
                                    <p className="text-xl font-bold text-purple-900">{monthlyReports[selectedMonthYear].classes}</p>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="mt-8">
                        <h3 className="text-xl font-bold mb-4 text-gray-800">Reporte Anual de Pagos</h3>
                        <div ref={annualPaymentsReportRef} className="p-4 bg-gray-50 rounded-lg">
                            <table className="min-w-full leading-normal">
                                <thead>
                                    <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                        <th className="py-3 px-6 text-left">Año</th>
                                        <th className="py-3 px-6 text-left">Pagos</th>
                                        <th className="py-3 px-6 text-left">Ingresos</th>
                                    </tr>
                                </thead>
                                <tbody className="text-gray-600 text-sm font-light">
                                    {Object.keys(annualPaymentsReport).sort().reverse().map(year => (
                                        <tr key={year} className="border-b border-gray-200 hover:bg-gray-100 transition-colors">
                                            <td className="py-3 px-6 text-left">{year}</td>
                                            <td className="py-3 px-6 text-left">{annualPaymentsReport[year].payments}</td>
                                            <td className="py-3 px-6 text-left">{formatPrice(annualPaymentsReport[year].income)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-4">
                            <button
                                onClick={downloadAnnualPDF}
                                className="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                            >
                                <i className="fas fa-file-pdf mr-2"></i>Descargar PDF Anual
                            </button>
                        </div>
                    </div>
                </div>
            );
            const activityLogTable = (
                <div className="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">Registro de Actividad Reciente</h2>
                    <ul className="space-y-4">
                        {activityLog.length > 0 ? (
                            activityLog.map(log => (
                                <li key={log.id} className="p-4 bg-gray-50 rounded-lg shadow-inner flex items-start space-x-4">
                                    <i className="fas fa-clock text-gray-500 mt-1"></i>
                                    <div>
                                        <p className="text-sm font-medium text-gray-900">{log.action}</p>
                                        <p className="text-xs text-gray-600">{log.description}</p>
                                        <span className="text-xs text-gray-400">{formatDate(log.timestamp)}</span>
                                    </div>
                                </li>
                            ))
                        ) : (
                            <p className="text-center text-gray-500 p-8">No hay actividad reciente.</p>
                        )}
                    </ul>
                </div>
            );

            // --- Nuevo Componente: Vista de las Clases de Mañana ---
            const ClasesDeManana = ({ tomorrowClasses, onEditClass }) => {
                const getTomorrowInfo = () => {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const dayOfWeek = tomorrow.toLocaleDateString('es-ES', { weekday: 'long' });
                    const dateString = tomorrow.toISOString().split('T')[0];
                    return { dateString, dayOfWeek: dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) };
                };
                const tomorrowInfo = getTomorrowInfo();
                return (
                    <div className="bg-white rounded-lg p-6 shadow-md border border-gray-200">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-indigo-700">Clases de {tomorrowInfo.dayOfWeek}</h2>
                            <i className="fa-solid fa-calendar-day text-2xl text-indigo-500"></i>
                        </div>
                        {tomorrowClasses.length > 0 ? (
                            <div className="space-y-6">
                                {tomorrowClasses.map((cls) => (
                                    <div key={cls.id} className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-100">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="text-xl font-semibold text-gray-700">
                                                <i className="fa-regular fa-clock mr-2 text-indigo-500"></i>
                                                {cls.horario} hs
                                            </h3>
                                            <button
                                                onClick={() => onEditClass(cls)}
                                                className="px-4 py-2 bg-yellow-400 text-gray-800 rounded-full font-bold text-sm hover:bg-yellow-500 transition-colors"
                                            >
                                                <i className="fa-solid fa-pen-to-square mr-1"></i> Editar
                                            </button>
                                        </div>
                                        <ul className="space-y-2">
                                            {cls.alumnos && cls.alumnos.length > 0 ? (
                                                cls.alumnos.map((alumno, index) => (
                                                    <li key={index} className="flex items-center justify-between p-2 bg-white rounded-md shadow-sm">
                                                        <span className="text-gray-800 font-medium">{alumno.nombre}</span>
                                                        {alumno.telefono && (
                                                            <a
                                                                href={`https://wa.me/${alumno.telefono}?text=${encodeURIComponent(`Hola ${alumno.nombre}, ¡te esperamos para tu clase de pádel mañana a las ${cls.horario}!`)}`}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="text-green-500 hover:text-green-600 transition-colors"
                                                                aria-label={`Enviar mensaje de WhatsApp a ${alumno.nombre}`}
                                                            >
                                                                <i className="fa-brands fa-whatsapp text-2xl"></i>
                                                            </a>
                                                        )}
                                                    </li>
                                                ))
                                            ) : (
                                                <li className="text-gray-500 italic p-2">No hay alumnos asignados a esta clase.</li>
                                            )}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p className="text-center text-gray-500 italic p-8">No hay clases programadas para mañana.</p>
                        )}
                    </div>
                );
            };

            // --- Nuevo Componente: Modal para Editar Clase ---
            const EditClassModal = ({ onClose, selectedClass, allStudents, userId, setMessage }) => {
                const [selectedStudentId, setSelectedStudentId] = useState('');
                const [currentStudents, setCurrentStudents] = useState(selectedClass.alumnos || []);
            
                // Function to add a student to the class
                const handleAddStudent = async () => {
                    if (!selectedStudentId) {
                        setMessage("Por favor, selecciona un alumno.");
                        return;
                    }
                    const studentToAdd = allStudents.find(s => s.id === selectedStudentId);
                    if (studentToAdd) {
                        const classRef = doc(db, `artifacts/${appId}/users/${userId}/clases_programadas`, selectedClass.id);
                        try {
                            await updateDoc(classRef, {
                                alumnos: arrayUnion({ nombre: `${studentToAdd.firstName} ${studentToAdd.lastName}`, telefono: studentToAdd.phone })
                            });
                            setCurrentStudents(prev => [...prev, { nombre: `${studentToAdd.firstName} ${studentToAdd.lastName}`, telefono: studentToAdd.phone }]);
                            setSelectedStudentId('');
                            setMessage("Alumno agregado exitosamente.");
                        } catch (error) {
                            console.error("Error adding student:", error);
                            setMessage("Error al agregar el alumno.");
                        }
                    }
                };
            
                // Function to remove a student from the class
                const handleRemoveStudent = async (student) => {
                    const classRef = doc(db, `artifacts/${appId}/users/${userId}/clases_programadas`, selectedClass.id);
                    try {
                        await updateDoc(classRef, {
                            alumnos: arrayRemove(student)
                        });
                        setCurrentStudents(prev => prev.filter(s => s.nombre !== student.nombre || s.telefono !== student.telefono));
                        setMessage("Alumno eliminado exitosamente.");
                    } catch (error) {
                        console.error("Error removing student:", error);
                        setMessage("Error al eliminar el alumno.");
                    }
                };
            
                const availableStudents = allStudents.filter(s =>
                    !currentStudents.some(cs => cs.nombre === `${s.firstName} ${s.lastName}`)
                );
            
                return (
                    <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                            <div className="flex justify-between items-center border-b pb-3 mb-4">
                                <h3 className="text-2xl font-bold text-indigo-700">Editar Clase de las {selectedClass.horario} hs</h3>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-800 transition-colors">
                                    <i className="fa-solid fa-xmark text-2xl"></i>
                                </button>
                            </div>
            
                            {/* Alumnos Actuales */}
                            <div className="mb-6">
                                <h4 className="text-lg font-semibold mb-2">Alumnos Actuales</h4>
                                {currentStudents.length > 0 ? (
                                    <ul className="space-y-2 max-h-40 overflow-y-auto">
                                        {currentStudents.map((student, index) => (
                                            <li key={index} className="flex justify-between items-center bg-gray-100 p-3 rounded-md">
                                                <span className="text-gray-800">{student.nombre}</span>
                                                <button
                                                    onClick={() => handleRemoveStudent(student)}
                                                    className="text-red-500 hover:text-red-700 transition-colors text-sm"
                                                >
                                                    <i className="fa-solid fa-trash-can mr-1"></i>
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-gray-500 italic">No hay alumnos en esta clase.</p>
                                )}
                            </div>
            
                            {/* Agregar Alumnos */}
                            <div>
                                <h4 className="text-lg font-semibold mb-2">Agregar Alumno</h4>
                                {availableStudents.length > 0 ? (
                                    <div className="flex flex-col sm:flex-row gap-2">
                                        <select
                                            value={selectedStudentId}
                                            onChange={(e) => setSelectedStudentId(e.target.value)}
                                            className="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        >
                                            <option value="" disabled>Seleccionar un alumno...</option>
                                            {availableStudents.map(student => (
                                                <option key={student.id} value={student.id}>{student.firstName} {student.lastName}</option>
                                            ))}
                                        </select>
                                        <button
                                            onClick={handleAddStudent}
                                            className="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                        >
                                            Agregar
                                        </button>
                                    </div>
                                ) : (
                                    <p className="text-gray-500 italic">Todos los alumnos están ya en esta clase.</p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const MainContent = () => {
                if (view === 'list') {
                    return (
                        <>
                            <ClasesDeManana
                                tomorrowClasses={tomorrowClasses}
                                onEditClass={(cls) => {
                                    setSelectedClass(cls);
                                    setIsEditModalOpen(true);
                                }}
                            />
                            <div className="mt-8">
                                {classesTable}
                            </div>
                        </>
                    );
                }
                if (view === 'add') return <ClassForm />;
                if (view === 'students') return studentsTable;
                if (view === 'add-student') return <StudentForm />;
                if (view === 'payments') return paymentsTable;
                if (view === 'add-payment') return <PaymentForm />;
                if (view === 'reports') return reports;
                if (view === 'activity') return activityLogTable;
            };

            return (
                <div className="bg-gray-100 min-h-screen p-4 sm:p-8">
                    <div className="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6 sm:p-10">
                        {/* Header and navigation */}
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
                            <h1 className="text-3xl sm:text-4xl font-bold text-gray-800 mb-4 sm:mb-0">
                                <i className="fas fa-volleyball-ball text-blue-500 mr-2"></i> Informe de Padel
                            </h1>
                            <div className="flex flex-wrap gap-2">
                                <button onClick={() => setView('list')} className={`p-2 rounded-lg text-sm transition-colors ${view === 'list' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    <i className="fas fa-home mr-1"></i> Principal
                                </button>
                                <button onClick={() => setView('add')} className={`p-2 rounded-lg text-sm transition-colors ${view === 'add' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    <i className="fas fa-plus-circle mr-1"></i> Agregar Clase
                                </button>
                                <button onClick={() => { setView('students'); setNewStudent({ firstName: '', lastName: '', phone: '', description: '', status: 'Activo' }); setIsEditingStudent(false); }} className={`p-2 rounded-lg text-sm transition-colors ${['students', 'add-student'].includes(view) ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    <i className="fas fa-users mr-1"></i> Alumnos
                                </button>
                                <button onClick={() => { setView('payments'); setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' }); setIsEditingPayment(false); }} className={`p-2 rounded-lg text-sm transition-colors ${['payments', 'add-payment'].includes(view) ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    <i className="fas fa-money-bill-wave mr-1"></i> Pagos
                                </button>
                                <button onClick={generateReports} className={`p-2 rounded-lg text-sm transition-colors ${view === 'reports' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    <i className="fas fa-chart-bar mr-1"></i> Reportes
                                </button>
                                <button onClick={() => setView('activity')} className={`p-2 rounded-lg text-sm transition-colors ${view === 'activity' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    <i className="fas fa-history mr-1"></i> Actividad
                                </button>
                                {userEmail && (
                                    <div className="flex items-center space-x-2 bg-gray-200 rounded-lg p-2">
                                        <span className="text-gray-700 text-sm font-medium hidden sm:block">{userEmail}</span>
                                        <button onClick={signOutUser} className="p-1 rounded-lg text-xs bg-red-500 text-white hover:bg-red-600 transition-colors">
                                            <i className="fas fa-sign-out-alt"></i>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Conditional rendering based on view state */}
                        <MainContent />
                        
                        {/* New: Modal for editing classes for tomorrow */}
                        {isEditModalOpen && (
                            <EditClassModal
                                onClose={() => setIsEditModalOpen(false)}
                                selectedClass={selectedClass}
                                allStudents={students}
                                userId={userId}
                                setMessage={(msg) => setMessageBox({ show: true, title: 'Mensaje', content: msg, type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) })}
                            />
                        )}

                        {userId && (
                            <div className="mt-8 text-center text-gray-500">
                                ID de Usuario: <span className="font-mono">{userId}</span>
                            </div>
                        )}
                    </div>
                    <MessageBox {...messageBox} onClose={() => setMessageBox({ ...messageBox, show: false })} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

