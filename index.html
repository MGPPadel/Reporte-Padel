<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronización en la Nube</title>
    <!-- Tailwind CSS desde CDN para un estilo rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Contenedor principal de la aplicación -->
    <div class="max-w-md mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-6 mt-10">
        <h1 class="text-3xl font-bold text-center text-gray-800">
            💾 Sincronización en la Nube
        </h1>

        <!-- Contenedor para mensajes de estado y ID de usuario -->
        <div id="message-container" class="space-y-4">
            <!-- El ID de usuario se mostrará aquí -->
            <div id="user-id-display" class="text-center text-sm text-gray-600 font-mono break-all hidden">
                <span class="font-bold">ID de Usuario:</span> <span id="user-id"></span>
            </div>
            <!-- Los mensajes de error se mostrarán aquí -->
            <div id="error-alert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm" role="alert">
                <p id="error-message"></p>
            </div>
            <!-- El indicador de carga se mostrará aquí -->
            <div id="loading-spinner" class="text-center text-gray-500 flex justify-center items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Cargando datos...
            </div>
        </div>

        <!-- Formulario principal para la entrada de datos -->
        <div id="app-content" class="space-y-4 hidden">
            <input
                id="data-input"
                type="text"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                placeholder="Escribe algo para guardar..."
            />
            <button
                id="save-button"
                class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 disabled:bg-gray-400"
                disabled
            >
                Guardar en la Nube
            </button>
        </div>

        <!-- Área para mostrar los datos guardados -->
        <div id="saved-data-display" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Datos Guardados:</h2>
            <p id="saved-text" class="text-gray-900 break-words"></p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importar los módulos necesarios de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Obtener variables de configuración del entorno de Canvas
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inicializar los servicios de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Referencias a elementos del DOM
        const dataInput = document.getElementById('data-input');
        const saveButton = document.getElementById('save-button');
        const savedTextElement = document.getElementById('saved-text');
        const userIdDisplay = document.getElementById('user-id-display');
        const userIdElement = document.getElementById('user-id');
        const errorAlert = document.getElementById('error-alert');
        const errorMessageElement = document.getElementById('error-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContent = document.getElementById('app-content');
        const savedDataDisplay = document.getElementById('saved-data-display');

        let userId = null;

        // Función para mostrar mensajes de error
        function showError(message) {
            errorMessageElement.textContent = message;
            errorAlert.classList.remove('hidden');
        }

        // Función para ocultar el indicador de carga y mostrar el contenido
        function showAppContent() {
            loadingSpinner.classList.add('hidden');
            appContent.classList.remove('hidden');
            savedDataDisplay.classList.remove('hidden');
        }

        // Oyente de cambios en la autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdElement.textContent = userId;
                userIdDisplay.classList.remove('hidden');

                // Establecer un oyente en tiempo real para los datos del usuario
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/mis_datos`, 'datos');
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        savedTextElement.textContent = docSnap.data().texto;
                    } else {
                        savedTextElement.textContent = "No hay datos guardados aún.";
                    }
                    // Ocultar carga y mostrar contenido de la aplicación
                    showAppContent();
                }, (err) => {
                    console.error("Error al escuchar los datos:", err);
                    showError("Error al cargar los datos. Por favor, revisa la consola.");
                });
            } else {
                // Iniciar sesión anónimamente si no hay usuario
                await signInAnonymously(auth).catch((error) => {
                    console.error("Error al iniciar sesión anónimamente:", error);
                    showError("Error al iniciar sesión. Por favor, revisa la consola.");
                });
            }
        });

        // Oyente de eventos para el botón de guardar
        saveButton.addEventListener('click', async () => {
            const inputValue = dataInput.value.trim();
            if (!inputValue) {
                showError("Por favor, introduce algún texto para guardar.");
                return;
            }

            if (!userId) {
                showError("Error: No se ha iniciado sesión.");
                return;
            }

            try {
                // Referencia al documento donde se guardarán los datos
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/mis_datos`, 'datos');
                await setDoc(docRef, {
                    texto: inputValue,
                    timestamp: new Date()
                });
                dataInput.value = ''; // Limpiar la entrada después de guardar
                errorAlert.classList.add('hidden'); // Ocultar cualquier error anterior
            } catch (e) {
                console.error("Error al guardar el documento:", e);
                showError("Error al guardar los datos. Por favor, inténtalo de nuevo.");
            }
        });

        // Oyente para habilitar el botón cuando hay texto en la entrada
        dataInput.addEventListener('input', () => {
            saveButton.disabled = dataInput.value.trim() === '';
        });

    </script>
</body>
</html>














































