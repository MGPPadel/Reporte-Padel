<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe de Clases de Padel</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail, browserSessionPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, onSnapshot, writeBatch, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.writeBatch = writeBatch;
        window.Timestamp = Timestamp;
        window.getDoc = getDoc;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.browserSessionPersistence = browserSessionPersistence;
        window.setPersistence = setPersistence;
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyAvk1yOsxXfc2w4YwZ1R1tQFrQuM2AbEYk",
            authDomain: "app-de-padel.firebaseapp.com",
            projectId: "app-de-padel",
            storageBucket: "app-de-padel.firebasestorage.app",
            messagingSenderId: "731771747398",
            appId: "1:731771747398:web:ebc8b723fe220869fade47"
        };
        const appId = typeof firebaseConfig.appId !== 'undefined' ? firebaseConfig.appId : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const { useState, useEffect, useRef, useMemo } = React;
        const daysOfWeek = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
        const defaultClassPrices = {
            1: 5000,
            2: 3000,
            3: 2500,
            4: 2000,
        };
        const peopleOptions = [1, 2, 3, 4];
        const timesOfDay = [
            '8:00 a.m.', '9:00 a.m.', '10:00 a.m.', '11:00 a.m.', '12:00 p.m.',
            '1:00 p.m.', '2:00 p.m.', '3:00 p.m.', '4:00 p.m.', '5:00 p.m.',
            '6:00 p.m.', '7:00 p.m.', '8:00 p.m.', '9:00 p.m.', '10:00 p.m.',
        ];
        const colorMap = {
            1: 'bg-yellow-100',
            2: 'bg-green-100',
            3: 'bg-blue-100',
            4: 'bg-purple-100',
        };
        const MessageBox = ({ show, title, content, type, onConfirm, onClose }) => {
            if (!show) return null;
            let icon, bgColor, titleColor;
            switch (type) {
                case 'success':
                    icon = <i className="fas fa-check-circle text-4xl text-green-600"></i>;
                    bgColor = 'bg-white';
                    titleColor = 'text-green-600';
                    break;
                case 'error':
                    icon = <i className="fas fa-times-circle text-4xl text-red-500"></i>;
                    bgColor = 'bg-white';
                    titleColor = 'text-red-600';
                    break;
                case 'confirm':
                    icon = <i className="fas fa-question-circle text-4xl text-blue-800"></i>;
                    bgColor = 'bg-white';
                    titleColor = 'text-blue-800';
                    break;
                default:
                    icon = null;
            }

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div className={`p-6 rounded-xl shadow-xl w-full max-w-sm text-center ${bgColor} transform transition-all duration-300 ease-in-out scale-100`}>
                        <div className="mb-4">{icon}</div>
                        <h3 className={`text-lg font-bold mb-2 ${titleColor}`}>{title}</h3>
                        <p className="text-sm text-gray-500 mb-4">{content}</p>
                        <div className="mt-4">
                            {type === 'confirm' && (
                                <button
                                    onClick={() => { onConfirm(); onClose(); }}
                                    className={`py-2 px-4 rounded-lg font-bold transition-colors text-white bg-blue-800 hover:bg-blue-900 shadow-md mr-2`}
                                >
                                    Aceptar
                                </button>
                            )}
                            <button
                                onClick={onClose}
                                className={`py-2 px-4 rounded-lg font-bold transition-colors text-white ${type === 'confirm' ? 'bg-gray-400 hover:bg-gray-500' : type === 'success' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-500 hover:bg-red-600'} shadow-md`}
                            >
                                {type === 'confirm' ? 'Cancelar' : 'Cerrar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const StudentAutocompleteInput = ({ value, onChange, students, index }) => {
            const [filteredSuggestions, setFilteredSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const inputRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (inputRef.current && !inputRef.current.contains(event.target)) {
                        setShowSuggestions(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, []);

            const handleChange = (e) => {
                const userInput = e.target.value;
                onChange(index, userInput);
                const suggestions = students.filter(
                    (student) =>
                        `${student.firstName} ${student.lastName}`
                            .toLowerCase()
                            .includes(userInput.toLowerCase())
                );
                setFilteredSuggestions(suggestions);
                setShowSuggestions(true);
            };

            const handleSelectSuggestion = (student) => {
                onChange(index, `${student.firstName} ${student.lastName}`);
                setShowSuggestions(false);
                setFilteredSuggestions([]);
            };

            return (
                <div className="relative mb-2" ref={inputRef}>
                    <input
                        type="text"
                        name={`studentName-${index}`}
                        value={value}
                        onChange={handleChange}
                        placeholder={`Nombre del Alumno ${index + 1}`}
                        className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    {showSuggestions && filteredSuggestions.length > 0 && (
                        <ul className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                            {filteredSuggestions.map((student) => (
                                <li
                                    key={student.id}
                                    onClick={() => handleSelectSuggestion(student)}
                                    className="p-2 cursor-pointer hover:bg-gray-200"
                                >
                                    {student.firstName} {student.lastName}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        const App = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [userId, setUserId] = useState(null);
            const [userEmail, setUserEmail] = useState('');
            const [loading, setLoading] = useState(true);
            const [classes, setClasses] = useState([]);
            const [students, setStudents] = useState([]);
            const [payments, setPayments] = useState([]);
            const [activityLog, setActivityLog] = useState([]);
            const [customPrices, setCustomPrices] = useState(defaultClassPrices);
            const [newEntry, setNewEntry] = useState({
                studentCount: 1,
                studentNames: [''],
                date: new Date().toISOString().split('T')[0],
                day: daysOfWeek[new Date().getDay()],
                time: timesOfDay[0],
                price: defaultClassPrices[1] || 0,
            });
            const [newStudent, setNewStudent] = useState({
                firstName: '',
                lastName: '',
                phone: '',
            });
            const [isEditingStudent, setIsEditingStudent] = useState(false);
            const [editedStudentId, setEditedStudentId] = useState(null);
            const [newPayment, setNewPayment] = useState({
                date: new Date().toISOString().split('T')[0],
                amount: 0,
                description: '',
            });
            const [isEditingPayment, setIsEditingPayment] = useState(false);
            const [editedPaymentId, setEditedPaymentId] = useState(null);

            const [monthlyReports, setMonthlyReports] = useState({});
            const [selectedMonthYear, setSelectedMonthYear] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [editedClassId, setEditedClassId] = useState(null);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [view, setView] = useState('list');
            const [filterText, setFilterText] = useState('');
            const [selectedClassesForDay, setSelectedClassesForDay] = useState(null);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [isSigningUp, setIsSigningUp] = useState(false);

            const [messageBox, setMessageBox] = useState({
                show: false,
                title: '',
                content: '',
                type: 'confirm',
                onConfirm: null,
            });

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const fileInputRef = useRef(null);
            const formatPrice = (price) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(price);
            const formatMonthYear = (monthYearString) => {
                const [year, month] = monthYearString.split('-');
                return new Date(year, month - 1).toLocaleString('es-AR', { month: 'long', year: 'numeric' });
            };
            const formatDate = (timestamp) => {
                const date = new Date(timestamp.seconds * 1000);
                return date.toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            };
            const initializeFirebase = async () => {
                try {
                    const app = window.initializeApp(firebaseConfig);
                    dbRef.current = window.getFirestore(app);
                    authRef.current = window.getAuth(app);

                    const unsubscribe = window.onAuthStateChanged(authRef.current, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setUserEmail(user.email);
                        } else {
                            setUserId(null);
                            setUserEmail('');
                        }
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    setMessageBox({
                        show: true,
                        title: 'Error de configuración',
                        content: 'Error al inicializar Firebase. Revisa tu configuración.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    setLoading(false);
                }
            };
            useEffect(() => {
                initializeFirebase();
            }, []);
            const signIn = async () => {
                try {
                    setLoading(true);
                    const auth = authRef.current;
                    await window.setPersistence(auth, window.browserSessionPersistence);
                    await window.signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    setMessageBox({
                        show: true,
                        title: 'Error de autenticación',
                        content: 'Usuario o contraseña incorrectos. Por favor, inténtalo de nuevo.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    console.error("Error signing in:", error);
                } finally {
                    setLoading(false);
                }
            };
            const signUp = async () => {
                try {
                    setLoading(true);
                    const auth = authRef.current;
                    await window.createUserWithEmailAndPassword(auth, email, password);
                    setMessageBox({
                        show: true,
                        title: 'Cuenta creada',
                        content: 'Tu cuenta se ha creado exitosamente. ¡Ya puedes iniciar sesión!',
                        type: 'success',
                        onClose: () => {
                            setMessageBox({ ...messageBox, show: false });
                            setIsSigningUp(false);
                        }
                    });
                } catch (error) {
                    setMessageBox({
                        show: true,
                        title: 'Error de registro',
                        content: 'Hubo un error al crear la cuenta. Puede que el email ya esté en uso o la contraseña sea demasiado débil.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    console.error("Error signing up:", error);
                } finally {
                    setLoading(false);
                }
            };
            const handlePasswordReset = async () => {
                if (!email) {
                    setMessageBox({
                        show: true,
                        title: 'Error de validación',
                        content: 'Por favor, ingresa tu email para restablecer la contraseña.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    return;
                }
                try {
                    setLoading(true);
                    await window.sendPasswordResetEmail(authRef.current, email);
                    setMessageBox({
                        show: true,
                        title: 'Correo enviado',
                        content: 'Se ha enviado un correo para restablecer tu contraseña. Revisa tu bandeja de entrada.',
                        type: 'success',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                } catch (error) {
                    setMessageBox({
                        show: true,
                        title: 'Error al enviar correo',
                        content: 'Hubo un error al enviar el correo. Asegúrate de que el email sea correcto.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    console.error("Error sending password reset email:", error);
                } finally {
                    setLoading(false);
                }
            };
            const signOutUser = async () => {
                try {
                    await window.signOut(authRef.current);
                    setUserId(null);
                    setClasses([]);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };
            const saveCustomPrices = async () => {
                if (!dbRef.current || !userId) return;
                try {
                    setLoading(true);
                    const userDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'config', 'prices');
                    await window.setDoc(userDocRef, { prices: customPrices });
                    setMessageBox({ show: true, title: 'Precios guardados', content: 'Los precios de las clases se han guardado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar', content: 'Hubo un error al guardar los precios.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error saving custom prices:", error);
                } finally {
                    setLoading(false);
                }
            };
            const loadCustomPrices = async () => {
                if (!dbRef.current || !userId) return;
                try {
                    const userDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'config', 'prices');
                    const docSnap = await window.getDoc(userDocRef);
                    if (docSnap.exists()) {
                        setCustomPrices(docSnap.data().prices);
                    }
                } catch (error) {
                    console.error("Error loading custom prices:", error);
                }
            };
            const addLogEntry = async (action, details) => {
                if (!dbRef.current || !userId) return;
                try {
                    const logColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'activityLog');
                    await window.addDoc(logColRef, {
                        action,
                        details,
                        timestamp: window.Timestamp.now()
                    });
                } catch (error) {
                    console.error("Error adding log entry:", error);
                }
            };
            const addStudent = async () => {
                if (!dbRef.current || !userId) return;
                if (!newStudent.firstName || !newStudent.lastName || !newStudent.phone) {
                    setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, completa todos los campos del alumno.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    return;
                }
                try {
                    setLoading(true);
                    const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                    if (isEditingStudent) {
                        const studentDocRef = window.doc(studentsColRef, editedStudentId);
                        await window.setDoc(studentDocRef, newStudent);
                        setMessageBox({ show: true, title: 'Alumno actualizado', content: 'El alumno se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    } else {
                        await window.addDoc(studentsColRef, newStudent);
                        setMessageBox({ show: true, title: 'Alumno añadido', content: 'El nuevo alumno se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    }
                    setNewStudent({ firstName: '', lastName: '', phone: '' });
                    setIsEditingStudent(false);
                    setEditedStudentId(null);
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar el alumno', content: 'Hubo un error al guardar los datos del alumno. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error adding/updating student:", error);
                } finally {
                    setLoading(false);
                }
            };
            const editStudent = (studentToEdit) => {
                setNewStudent(studentToEdit);
                setIsEditingStudent(true);
                setEditedStudentId(studentToEdit.id);
            };

            const deleteStudent = (studentId) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar eliminación',
                    content: '¿Estás seguro de que quieres eliminar a este alumno? Esta acción es irreversible.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        try {
                            setLoading(true);
                            const studentDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'students', studentId);
                            await window.deleteDoc(studentDocRef);
                            setMessageBox({ show: true, title: 'Alumno eliminado', content: 'El alumno ha sido eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } catch (error) {
                            setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar al alumno. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            console.error("Error deleting student:", error);
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            const sendWhatsApp = (phone) => {
                const formattedPhone = phone.replace(/\D/g, '');
                const url = `https://wa.me/${formattedPhone}`;
                window.open(url, '_blank');
            };

            const addPayment = async () => {
                if (!dbRef.current || !userId) return;
                if (!newPayment.date || !newPayment.amount || newPayment.amount <= 0) {
                    setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, ingresa una fecha y un monto válido para el pago.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    return;
                }
                try {
                    setLoading(true);
                    const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');
                    const paymentData = {
                        ...newPayment,
                        amount: parseFloat(newPayment.amount),
                        date: newPayment.date,
                        timestamp: window.Timestamp.fromDate(new Date(newPayment.date))
                    };
                    if (isEditingPayment) {
                        const paymentDocRef = window.doc(paymentsColRef, editedPaymentId);
                        await window.setDoc(paymentDocRef, paymentData);
                        setMessageBox({ show: true, title: 'Pago actualizado', content: 'El pago se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    } else {
                        await window.addDoc(paymentsColRef, paymentData);
                        setMessageBox({ show: true, title: 'Pago añadido', content: 'El nuevo pago se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    }
                    setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' });
                    setIsEditingPayment(false);
                    setEditedPaymentId(null);
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar el pago', content: 'Hubo un error al guardar los datos del pago. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error adding/updating payment:", error);
                } finally {
                    setLoading(false);
                }
            };
            const editPayment = (paymentToEdit) => {
                setNewPayment({ ...paymentToEdit, amount: paymentToEdit.amount.toString() });
                setIsEditingPayment(true);
                setEditedPaymentId(paymentToEdit.id);
            };
            const deletePayment = (paymentId) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar eliminación',
                    content: '¿Estás seguro de que quieres eliminar este pago? Esta acción es irreversible.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        try {
                            setLoading(true);
                            const paymentDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments', paymentId);
                            await window.deleteDoc(paymentDocRef);
                            setMessageBox({ show: true, title: 'Pago eliminado', content: 'El pago ha sido eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } catch (error) {
                            setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar el pago. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            console.error("Error deleting payment:", error);
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            useEffect(() => {
                if (userId && dbRef.current) {
                    loadCustomPrices();

                    const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                    const classesQuery = window.query(classesColRef);
                    const unsubscribeClasses = window.onSnapshot(classesQuery, (snapshot) => {
                        const fetchedClasses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const sortedClasses = fetchedClasses.sort((a, b) => new Date(b.date) - new Date(a.date));
                        setClasses(sortedClasses);
                    });

                    const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                    const studentsQuery = window.query(studentsColRef);
                    const unsubscribeStudents = window.onSnapshot(studentsQuery, (snapshot) => {
                        const fetchedStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStudents(fetchedStudents.sort((a, b) => a.lastName.localeCompare(b.lastName)));
                    });

                    const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');
                    const paymentsQuery = window.query(paymentsColRef);
                    const unsubscribePayments = window.onSnapshot(paymentsQuery, (snapshot) => {
                        const fetchedPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const sortedPayments = fetchedPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                        setPayments(sortedPayments);
                    });
                    const logColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'activityLog');
                    const logQuery = window.query(logColRef);
                    const unsubscribeLog = window.onSnapshot(logQuery, (snapshot) => {
                        const fetchedLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const sortedLog = fetchedLog.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                        setActivityLog(sortedLog);
                    });
                    return () => {
                        unsubscribeClasses();
                        unsubscribeStudents();
                        unsubscribePayments();
                        unsubscribeLog();
                    };
                } else {
                    setClasses([]);
                    setStudents([]);
                    setPayments([]);
                    setActivityLog([]);
                }
            }, [userId]);
            useEffect(() => {
                if (Object.keys(customPrices).length > 0) {
                    setNewEntry(prev => ({ ...prev, price: customPrices[prev.studentCount] || 0 }));
                }
            }, [customPrices]);
            useEffect(() => {
                const report = {};
                classes.forEach(cls => {
                    const date = new Date(`${cls.date}T00:00:00Z`);
                    const monthYear = `${date.getUTCFullYear()}-${(date.getUTCMonth() + 1).toString().padStart(2, '0')}`;
                    if (!report[monthYear]) {
                        report[monthYear] = { totalIncome: 0, classCount: 0, classCountByStudent: {} };
                    }
                    report[monthYear].totalIncome += cls.price;
                    report[monthYear].classCount += 1;
                    const studentCount = cls.studentCount;
                    report[monthYear].classCountByStudent[studentCount] = (report[monthYear].classCountByStudent[studentCount] || 0) + 1;
                });
                setMonthlyReports(report);
            }, [classes]);

            const handleNewEntryChange = (e) => {
                const { name, value } = e.target;
                if (name === 'studentCount') {
                    const count = parseInt(value);
                    const newNames = Array(count).fill('');
                    const newPrice = customPrices[count] || 0;
                    setNewEntry(prev => ({ ...prev, studentCount: count, studentNames: newNames, price: newPrice }));
                } else if (name.startsWith('studentName-')) {
                    const index = parseInt(name.split('-')[1]);
                    const newNames = [...newEntry.studentNames];
                    newNames[index] = value;
                    setNewEntry(prev => ({ ...prev, studentNames: newNames }));
                } else {
                    setNewEntry(prev => ({ ...prev, [name]: value }));
                }
            };
            const handleAutocompleteStudentChange = (index, value) => {
                const newNames = [...newEntry.studentNames];
                newNames[index] = value;
                setNewEntry(prev => ({ ...prev, studentNames: newNames }));
            };
            const handleDateChange = (e) => {
                const dateString = e.target.value;
                const dateObj = new Date(`${dateString}T00:00:00Z`);
                const dayOfWeek = daysOfWeek[dateObj.getUTCDay()];
                setNewEntry(prev => ({ ...prev, date: dateString, day: dayOfWeek }));
            };
            const handleCustomPriceChange = (studentCount, price) => setCustomPrices(prev => ({ ...prev, [studentCount]: parseInt(price) || 0 }));
            const addClass = async () => {
                if (!dbRef.current || !userId) return;
                if (newEntry.studentNames.some(name => name.trim() === '') || newEntry.price <= 0) {
                    setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, completa todos los campos de los alumnos y el precio.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    return;
                }
                try {
                    setLoading(true);
                    const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                    const classData = { ...newEntry, timestamp: window.Timestamp.fromDate(new Date(newEntry.date)) };
                    if (isEditing) {
                        const classDocRef = window.doc(classesColRef, editedClassId);
                        await window.setDoc(classDocRef, classData);
                        setMessageBox({ show: true, title: 'Clase actualizada', content: 'La clase se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        addLogEntry('Clase editada', `Clase con ${classData.studentNames.join(', ')} editada el día ${classData.date} a las ${classData.time}.`);
                    } else {
                        await window.addDoc(classesColRef, classData);
                        setMessageBox({ show: true, title: 'Clase añadida', content: 'La nueva clase se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        addLogEntry('Clase añadida', `Clase con ${classData.studentNames.join(', ')} añadida para el día ${classData.date} a las ${classData.time}.`);
                    }
                    setNewEntry({
                        studentCount: 1,
                        studentNames: [''],
                        date: new Date().toISOString().split('T')[0],
                        day: daysOfWeek[new Date().getDay()],
                        time: timesOfDay[0],
                        price: customPrices[1] || 0,
                    });
                    setIsEditing(false);
                    setEditedClassId(null);
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar la clase', content: 'Hubo un error al guardar los datos de la clase. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error adding/updating class:", error);
                } finally {
                    setLoading(false);
                }
            };
            const deleteClass = (id, classData) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar eliminación',
                    content: '¿Estás seguro de que quieres eliminar esta clase? Esta acción es irreversible.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        try {
                            setLoading(true);
                            const classDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'classes', id);
                            await window.deleteDoc(classDocRef);
                            setMessageBox({ show: true, title: 'Clase eliminada', content: 'La clase ha sido eliminada exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            addLogEntry('Clase eliminada', `Clase con ${classData.studentNames.join(', ')} del día ${classData.date} a las ${classData.time} ha sido eliminada.`);
                            setSelectedClassesForDay(null); // Close modal after deleting
                        } catch (error) {
                            setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar la clase. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            console.error("Error deleting class:", error);
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };
            const editClass = (classToEdit) => {
                setNewEntry({
                    studentCount: classToEdit.studentCount,
                    studentNames: classToEdit.studentNames,
                    date: classToEdit.date,
                    day: classToEdit.day,
                    time: classToEdit.time,
                    price: classToEdit.price,
                });
                setIsEditing(true);
                setEditedClassId(classToEdit.id);
                setSelectedClassesForDay(null); // Close modal when editing
                setView('list');
            };
            const generatePDF = () => {
                if (!reportTableRef.current) return;
                setLoading(true);
                const input = reportTableRef.current;
                window.html2canvas(input, { scale: 2 }).then((canvas) => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    pdf.save(`informe_clases.pdf`);
                    setLoading(false);
                }).catch(err => {
                    console.error("Error generating PDF:", err);
                    setLoading(false);
                });
            };
            const uniqueMonths = useMemo(() => {
                const months = new Set();
                classes.forEach(cls => {
                    const monthYear = cls.date.substring(0, 7);
                    months.add(monthYear);
                });
                return Array.from(months).sort((a, b) => new Date(a) - new Date(b));
            }, [classes]);
            const filteredClasses = useMemo(() => {
                let filtered = classes;
                if (selectedMonthYear) {
                    filtered = filtered.filter(cls => cls.date.startsWith(selectedMonthYear));
                }
                if (filterText) {
                    filtered = filtered.filter(cls => cls.studentNames.some(name => name.toLowerCase().includes(filterText.toLowerCase())));
                }
                return filtered;
            }, [classes, selectedMonthYear, filterText]);
            const getCalendarDays = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                const days = [];
                const prevMonthLastDay = new Date(year, month, 0).getDate();
                for (let i = firstDayOfMonth - 1; i >= 0; i--) {
                    days.push({ day: prevMonthLastDay - i, classes: [], isCurrentMonth: false, dailyIncome: 0 });
                }
                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                    const classesOnDay = classes.filter(cls => cls.date === dateStr);
                    const dailyIncome = classesOnDay.reduce((sum, cls) => sum + cls.price, 0);
                    days.push({ day: i, classes: classesOnDay, isCurrentMonth: true, date: dateStr, dailyIncome });
                }
                const totalDays = days.length;
                const remainingDays = 42 - totalDays;
                for (let i = 1; i <= remainingDays; i++) {
                    days.push({ day: i, classes: [], isCurrentMonth: false, dailyIncome: 0 });
                }
                return days;
            };
            const calendarDays = useMemo(() => getCalendarDays(selectedDate), [selectedDate, classes]);
            const handleCalendarNavigation = (delta) => {
                setSelectedDate(prev => {
                    const newDate = new Date(prev);
                    newDate.setMonth(newDate.getMonth() + delta);
                    return newDate;
                });
            };
            const handleDayClick = (classesOnDay) => {
                if (classesOnDay.length > 0) {
                    setSelectedClassesForDay(classesOnDay);
                }
            };
            const reportTableRef = useRef(null);
            const exportData = () => {
                const data = JSON.stringify({ classes, students, payments }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `padel_data_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        setMessageBox({ show: true, title: 'Confirmar importación', content: `Se reemplazarán los datos actuales con los del archivo. ¿Estás seguro?`, type: 'confirm', onConfirm: () => importData(importedData), onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    } catch (error) {
                        setMessageBox({ show: true, title: 'Error de archivo', content: 'El archivo no es un JSON válido. Por favor, revisa el formato.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        console.error("Error parsing JSON:", error);
                    }
                };
                reader.readAsText(file);
            };
            const importData = async (data) => {
                if (!dbRef.current || !userId) return;
                setLoading(true);
                try {
                    const batch = window.writeBatch(dbRef.current);
                    const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                    const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                    const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');
                    const existingClassesDocs = await window.getDocs(classesColRef);
                    existingClassesDocs.forEach(doc => batch.delete(doc.ref));
                    data.classes.forEach(cls => {
                        const newDocRef = window.doc(classesColRef);
                        const { id, ...classData } = cls;
                        batch.set(newDocRef, { ...classData, timestamp: window.Timestamp.fromDate(new Date(classData.date)) });
                    });
                    const existingStudentsDocs = await window.getDocs(studentsColRef);
                    existingStudentsDocs.forEach(doc => batch.delete(doc.ref));
                    data.students.forEach(student => {
                        const newDocRef = window.doc(studentsColRef);
                        const { id, ...studentData } = student;
                        batch.set(newDocRef, studentData);
                    });
                    const existingPaymentsDocs = await window.getDocs(paymentsColRef);
                    existingPaymentsDocs.forEach(doc => batch.delete(doc.ref));
                    data.payments.forEach(payment => {
                        const newDocRef = window.doc(paymentsColRef);
                        const { id, ...paymentData } = payment;
                        batch.set(newDocRef, { ...paymentData, timestamp: window.Timestamp.fromDate(new Date(paymentData.date)) });
                    });
                    await batch.commit();
                    addLogEntry('Importación de datos', 'Datos importados exitosamente desde un archivo JSON.');
                    setMessageBox({ show: true, title: 'Importación exitosa', content: 'Los datos han sido importados exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error de importación', content: 'Hubo un error al importar los datos. Revisa el archivo e inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error importing data:", error);
                } finally {
                    setLoading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };
            const Login = () => (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-200 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                        <div className="flex justify-center mb-6">
                            <i className="fas fa-sign-in-alt text-5xl text-blue-800"></i>
                        </div>
                        <h2 className="text-3xl font-bold text-center text-gray-800 mb-6">{isSigningUp ? 'Crear Cuenta' : 'Iniciar Sesión'}</h2>
                        <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            placeholder="Email"
                            className="w-full p-3 mb-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        />
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            placeholder="Contraseña"
                            className="w-full p-3 mb-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        />
                        <button
                            onClick={isSigningUp ? signUp : signIn}
                            className="w-full bg-blue-800 text-white font-bold p-3 rounded-lg hover:bg-blue-900 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                        >
                            {isSigningUp ? 'Crear Cuenta' : 'Ingresar'}
                        </button>
                        <div className="mt-6 text-center">
                            <button
                                onClick={() => setIsSigningUp(!isSigningUp)}
                                className="text-sm text-blue-700 hover:text-blue-900 transition-colors"
                            >
                                {isSigningUp ? '¿Ya tienes una cuenta? Inicia sesión' : '¿No tienes una cuenta? Regístrate'}
                            </button>
                        </div>
                        <div className="mt-4 text-center">
                            <button
                                onClick={handlePasswordReset}
                                className="text-xs text-gray-500 hover:text-gray-700 transition-colors"
                            >
                                ¿Olvidaste tu contraseña?
                            </button>
                        </div>
                    </div>
                </div>
            );
            const AddClass = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 className="text-xl font-bold mb-4 text-blue-800">Añadir Clase</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                            <input
                                type="date"
                                name="date"
                                value={newEntry.date}
                                onChange={handleDateChange}
                                className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Día</label>
                            <input
                                type="text"
                                name="day"
                                value={newEntry.day}
                                readOnly
                                className="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Hora</label>
                            <select
                                name="time"
                                value={newEntry.time}
                                onChange={handleNewEntryChange}
                                className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                {timesOfDay.map((time, index) => (
                                    <option key={index} value={time}>{time}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">N° de alumnos</label>
                            <select
                                name="studentCount"
                                value={newEntry.studentCount}
                                onChange={handleNewEntryChange}
                                className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                {peopleOptions.map(option => (
                                    <option key={option} value={option}>{option}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Añadir alumnos</label>
                        {Array.from({ length: newEntry.studentCount }).map((_, index) => (
                            <StudentAutocompleteInput
                                key={index}
                                index={index}
                                value={newEntry.studentNames[index]}
                                onChange={handleAutocompleteStudentChange}
                                students={students}
                            />
                        ))}
                    </div>
                    <div className="mt-4 text-right">
                        <div className="text-lg font-bold text-gray-800 mb-2">Precio: <span className="text-blue-800">{formatPrice(newEntry.price)}</span></div>
                        <button
                            onClick={addClass}
                            className={`w-full md:w-auto px-6 py-3 rounded-lg font-bold transition-colors text-white ${isEditing ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-800 hover:bg-blue-900'} shadow-md`}
                        >
                            {isEditing ? 'Actualizar Clase' : 'Añadir Clase'}
                        </button>
                    </div>
                </div>
            );
            const AddStudent = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 className="text-xl font-bold mb-4 text-blue-800">{isEditingStudent ? 'Editar Alumno' : 'Añadir Alumno'}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input
                            type="text"
                            value={newStudent.firstName}
                            onChange={(e) => setNewStudent({ ...newStudent, firstName: e.target.value })}
                            placeholder="Nombre"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <input
                            type="text"
                            value={newStudent.lastName}
                            onChange={(e) => setNewStudent({ ...newStudent, lastName: e.target.value })}
                            placeholder="Apellido"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <input
                            type="tel"
                            value={newStudent.phone}
                            onChange={(e) => setNewStudent({ ...newStudent, phone: e.target.value })}
                            placeholder="Teléfono (ej: 381...)"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div className="text-right">
                        <button
                            onClick={addStudent}
                            className={`w-full md:w-auto px-6 py-3 rounded-lg font-bold transition-colors text-white ${isEditingStudent ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-800 hover:bg-blue-900'} shadow-md`}
                        >
                            {isEditingStudent ? 'Actualizar Alumno' : 'Añadir Alumno'}
                        </button>
                    </div>
                </div>
            );
            const AddPayment = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 className="text-xl font-bold mb-4 text-blue-800">{isEditingPayment ? 'Editar Pago' : 'Añadir Pago'}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input
                            type="date"
                            value={newPayment.date}
                            onChange={(e) => setNewPayment({ ...newPayment, date: e.target.value })}
                            className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <input
                            type="number"
                            value={newPayment.amount}
                            onChange={(e) => setNewPayment({ ...newPayment, amount: e.target.value })}
                            placeholder="Monto"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <input
                            type="text"
                            value={newPayment.description}
                            onChange={(e) => setNewPayment({ ...newPayment, description: e.target.value })}
                            placeholder="Descripción (ej: Alquiler de cancha)"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div className="text-right">
                        <button
                            onClick={addPayment}
                            className={`w-full md:w-auto px-6 py-3 rounded-lg font-bold transition-colors text-white ${isEditingPayment ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-800 hover:bg-blue-900'} shadow-md`}
                        >
                            {isEditingPayment ? 'Actualizar Pago' : 'Añadir Pago'}
                        </button>
                    </div>
                </div>
            );
            const Tab = ({ label, name, currentView, setView }) => (
                <button
                    className={`px-4 py-2 font-bold transition-colors rounded-t-lg ${currentView === name ? 'bg-white text-blue-800 shadow-md' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                    onClick={() => setView(name)}
                >
                    {label}
                </button>
            );
            const DataList = ({ data, type, onDelete, onEdit, sendWhatsApp, columns }) => (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <h3 className="text-xl font-bold mb-4 text-blue-800">
                        {type === 'class' ? 'Listado de Clases' : type === 'student' ? 'Listado de Alumnos' : 'Listado de Pagos'}
                    </h3>
                    <input
                        type="text"
                        placeholder="Filtrar por nombre..."
                        value={filterText}
                        onChange={(e) => setFilterText(e.target.value)}
                        className="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    {data.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        {columns.map((col, index) => (
                                            <th key={index} scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{col.label}</th>
                                        ))}
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {data.map((item, index) => (
                                        <tr key={item.id} className="hover:bg-gray-100 transition-colors">
                                            {columns.map((col, colIndex) => (
                                                <td key={colIndex} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {col.render(item)}
                                                </td>
                                            ))}
                                            <td className="px-6 py-4 whitespace-now-rap text-right text-sm font-medium">
                                                <div className="flex justify-end space-x-2">
                                                    <button onClick={() => onEdit(item)} className="text-blue-600 hover:text-blue-900 transition-colors">
                                                        <i className="fas fa-edit"></i>
                                                    </button>
                                                    {type === 'student' && item.phone && (
                                                        <button onClick={() => sendWhatsApp(item.phone)} className="text-green-600 hover:text-green-800 transition-colors">
                                                            <i className="fab fa-whatsapp"></i>
                                                        </button>
                                                    )}
                                                    <button onClick={() => onDelete(item.id, item)} className="text-red-600 hover:text-red-900 transition-colors">
                                                        <i className="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <p className="text-center text-gray-500 p-8">No hay {type === 'class' ? 'clases' : type === 'student' ? 'alumnos' : 'pagos'} registrados.</p>
                    )}
                </div>
            );
            const Reportes = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 className="text-xl font-bold mb-4 text-blue-800">Informes Mensuales</h3>
                    <div className="flex flex-col md:flex-row items-center mb-4 space-y-4 md:space-y-0 md:space-x-4">
                        <select
                            value={selectedMonthYear}
                            onChange={(e) => setSelectedMonthYear(e.target.value)}
                            className="w-full md:w-auto p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Todos los Meses</option>
                            {uniqueMonths.map(monthYear => (
                                <option key={monthYear} value={monthYear}>{formatMonthYear(monthYear)}</option>
                            ))}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {Object.keys(monthlyReports).length > 0 ? (
                            Object.keys(monthlyReports).sort((a, b) => new Date(b) - new Date(a)).filter(monthYear => !selectedMonthYear || monthYear === selectedMonthYear).map(monthYear => (
                                <div key={monthYear} className="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <h4 className="font-bold text-lg text-blue-700 mb-2">{formatMonthYear(monthYear)}</h4>
                                    <p className="text-gray-700">Ingresos Totales: <span className="font-bold">{formatPrice(monthlyReports[monthYear].totalIncome)}</span></p>
                                    <p className="text-gray-700">Clases Registradas: <span className="font-bold">{monthlyReports[monthYear].classCount}</span></p>
                                    <ul className="mt-2 list-disc list-inside text-sm text-gray-600">
                                        {Object.entries(monthlyReports[monthYear].classCountByStudent).map(([count, numClasses]) => (
                                            <li key={count}>Clases de {count} alumno(s): {numClasses}</li>
                                        ))}
                                    </ul>
                                </div>
                            ))
                        ) : (
                            <p className="col-span-2 text-center text-gray-500 p-8">No hay datos para generar informes.</p>
                        )}
                    </div>
                    <div className="mt-6 text-right">
                        <button
                            onClick={generatePDF}
                            className="w-full md:w-auto px-6 py-3 rounded-lg font-bold transition-colors text-white bg-red-600 hover:bg-red-700 shadow-md"
                        >
                            Descargar PDF
                        </button>
                    </div>
                </div>
            );
            const CalendarView = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 className="text-xl font-bold mb-4 text-blue-800">Calendario de Clases</h3>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => handleCalendarNavigation(-1)} className="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">
                            <i className="fas fa-chevron-left"></i>
                        </button>
                        <h4 className="text-lg font-bold">{selectedDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h4>
                        <button onClick={() => handleCalendarNavigation(1)} className="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">
                            <i className="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div className="grid grid-cols-7 text-center text-sm font-bold text-gray-600">
                        {daysOfWeek.map(day => <div key={day}>{day.substring(0, 3)}</div>)}
                    </div>
                    <div className="grid grid-cols-7 gap-1 mt-2">
                        {calendarDays.map((day, index) => (
                            <div
                                key={index}
                                className={`p-2 text-center rounded-lg cursor-pointer transition-colors ${day.isCurrentMonth ? (day.classes.length > 0 ? `${colorMap[day.classes[0].studentCount]} shadow-sm` : 'bg-gray-100 hover:bg-gray-200') : 'text-gray-400 bg-gray-50'}`}
                                onClick={() => handleDayClick(day.classes)}
                            >
                                <span className="font-bold">{day.day}</span>
                                {day.classes.length > 0 && (
                                    <div className="text-xs mt-1 text-gray-800">
                                        <div className="font-semibold">{day.classes.length} {day.classes.length === 1 ? 'clase' : 'clases'}</div>
                                        <div>{formatPrice(day.dailyIncome)}</div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                    {selectedClassesForDay && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg mx-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="text-xl font-bold text-blue-800">Clases del {new Date(selectedClassesForDay[0].date).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</h4>
                                    <button onClick={() => setSelectedClassesForDay(null)} className="text-gray-500 hover:text-gray-700">
                                        <i className="fas fa-times-circle text-2xl"></i>
                                    </button>
                                </div>
                                <ul className="space-y-4">
                                    {selectedClassesForDay.map(cls => (
                                        <li key={cls.id} className="p-4 rounded-lg bg-gray-100 shadow-sm flex justify-between items-center">
                                            <div>
                                                <p className="font-bold text-gray-800">{cls.time}</p>
                                                <p className="text-sm text-gray-600">Alumnos: {cls.studentNames.join(', ')}</p>
                                                <p className="text-sm font-bold text-blue-700 mt-1">Precio: {formatPrice(cls.price)}</p>
                                            </div>
                                            <div className="flex space-x-2">
                                                <button onClick={() => editClass(cls)} className="text-blue-600 hover:text-blue-900 transition-colors">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => deleteClass(cls.id, cls)} className="text-red-600 hover:text-red-900 transition-colors">
                                                    <i className="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    )}
                </div>
            );
            const ImportExport = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 className="text-xl font-bold mb-4 text-blue-800">Importar / Exportar Datos</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="p-4 bg-gray-50 rounded-lg shadow-inner text-center">
                            <h4 className="font-bold text-lg mb-2 text-gray-700">Exportar Datos</h4>
                            <p className="text-sm text-gray-500 mb-4">Exporta todas tus clases, alumnos y pagos a un archivo JSON.</p>
                            <button
                                onClick={exportData}
                                className="w-full px-6 py-3 rounded-lg font-bold transition-colors text-white bg-blue-800 hover:bg-blue-900 shadow-md"
                            >
                                <i className="fas fa-download mr-2"></i> Exportar
                            </button>
                        </div>
                        <div className="p-4 bg-gray-50 rounded-lg shadow-inner text-center">
                            <h4 className="font-bold text-lg mb-2 text-gray-700">Importar Datos</h4>
                            <p className="text-sm text-gray-500 mb-4">Importa datos desde un archivo JSON. ¡Esto reemplazará todos tus datos existentes!</p>
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleFileChange}
                                accept=".json"
                                className="hidden"
                                id="import-file"
                            />
                            <label
                                htmlFor="import-file"
                                className="w-full inline-block px-6 py-3 rounded-lg font-bold transition-colors text-white bg-green-600 hover:bg-green-700 shadow-md cursor-pointer"
                            >
                                <i className="fas fa-upload mr-2"></i> Seleccionar Archivo
                            </label>
                        </div>
                    </div>
                </div>
            );
            const ConfigModal = () => {
                if (!showConfigModal) return null;
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-md mx-4">
                            <h3 className="text-xl font-bold mb-4 text-blue-800">Configuración de Precios</h3>
                            {peopleOptions.map(count => (
                                <div key={count} className="flex items-center justify-between mb-4">
                                    <label className="text-gray-700">Precio para {count} alumno(s):</label>
                                    <div className="relative rounded-lg shadow-sm">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span className="text-gray-500 sm:text-sm">$</span>
                                        </div>
                                        <input
                                            type="number"
                                            value={customPrices[count] || ''}
                                            onChange={(e) => handleCustomPriceChange(count, e.target.value)}
                                            className="block w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="0"
                                        />
                                    </div>
                                </div>
                            ))}
                            <div className="mt-6 flex justify-end space-x-2">
                                <button
                                    onClick={() => setShowConfigModal(false)}
                                    className="px-4 py-2 rounded-lg font-bold transition-colors text-gray-700 bg-gray-200 hover:bg-gray-300 shadow-md"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={saveCustomPrices}
                                    className="px-4 py-2 rounded-lg font-bold transition-colors text-white bg-blue-800 hover:bg-blue-900 shadow-md"
                                >
                                    Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const activityLogColumns = [
                { label: 'Acción', render: (log) => <span className="font-bold text-blue-800 uppercase">{log.action}</span> },
                { label: 'Detalles', render: (log) => <span className="text-gray-700">{log.details}</span> },
                { label: 'Fecha/Hora', render: (log) => <span className="text-gray-500">{formatDate(log.timestamp)}</span> },
            ];

            const classColumns = [
                { label: 'Fecha', render: (cls) => cls.date },
                { label: 'Hora', render: (cls) => cls.time },
                { label: 'Alumnos', render: (cls) => cls.studentNames.join(', ') },
                { label: 'Precio', render: (cls) => formatPrice(cls.price) },
            ];

            const studentColumns = [
                { label: 'Nombre', render: (student) => `${student.firstName} ${student.lastName}` },
                { label: 'Teléfono', render: (student) => student.phone },
            ];

            const paymentColumns = [
                { label: 'Fecha', render: (payment) => payment.date },
                { label: 'Monto', render: (payment) => formatPrice(payment.amount) },
                { label: 'Descripción', render: (payment) => payment.description },
            ];
            return (
                <div className="min-h-screen bg-gray-100">
                    <MessageBox {...messageBox} />
                    {showConfigModal && <ConfigModal />}
                    <header className="bg-blue-800 text-white p-4 shadow-md">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-bold flex items-center">
                                <i className="fas fa-table-tennis mr-2"></i> Padel Pro Manager
                            </h1>
                            {userId && (
                                <div className="flex items-center space-x-4">
                                    <span className="text-sm">Hola, {userEmail}</span>
                                    <button onClick={signOutUser} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-colors">
                                        Cerrar Sesión
                                    </button>
                                </div>
                            )}
                        </div>
                    </header>
                    {!userId ? (
                        <Login />
                    ) : (
                        <>
                            <div className="container mx-auto p-4 md:p-8">
                                <div className="flex justify-between items-center mb-4 space-x-2 overflow-x-auto">
                                    <Tab label="Añadir Clase" name="addClass" currentView={view} setView={setView} />
                                    <Tab label="Ver Clases" name="list" currentView={view} setView={setView} />
                                    <Tab label="Calendario" name="calendar" currentView={view} setView={setView} />
                                    <Tab label="Añadir Alumno" name="addStudent" currentView={view} setView={setView} />
                                    <Tab label="Ver Alumnos" name="listStudents" currentView={view} setView={setView} />
                                    <Tab label="Añadir Pago" name="addPayment" currentView={view} setView={setView} />
                                    <Tab label="Ver Pagos" name="listPayments" currentView={view} setView={setView} />
                                    <Tab label="Informes" name="reports" currentView={view} setView={setView} />
                                    <Tab label="Actividad" name="log" currentView={view} setView={setView} />
                                    <button
                                        onClick={() => setShowConfigModal(true)}
                                        className="px-4 py-2 font-bold transition-colors rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300 flex-shrink-0"
                                    >
                                        <i className="fas fa-cog"></i> Precios
                                    </button>
                                    <button
                                        onClick={() => setView('importExport')}
                                        className="px-4 py-2 font-bold transition-colors rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300 flex-shrink-0"
                                    >
                                        <i className="fas fa-file-import"></i> Datos
                                    </button>
                                </div>
                                {view === 'addClass' && <AddClass />}
                                {view === 'addStudent' && <AddStudent />}
                                {view === 'addPayment' && <AddPayment />}
                                {view === 'list' && (
                                    <DataList
                                        data={filteredClasses}
                                        type="class"
                                        onDelete={deleteClass}
                                        onEdit={editClass}
                                        columns={classColumns}
                                    />
                                )}
                                {view === 'listStudents' && (
                                    <DataList
                                        data={students}
                                        type="student"
                                        onDelete={deleteStudent}
                                        onEdit={editStudent}
                                        sendWhatsApp={sendWhatsApp}
                                        columns={studentColumns}
                                    />
                                )}
                                {view === 'listPayments' && (
                                    <DataList
                                        data={payments}
                                        type="payment"
                                        onDelete={deletePayment}
                                        onEdit={editPayment}
                                        columns={paymentColumns}
                                    />
                                )}
                                {view === 'reports' && <Reportes />}
                                {view === 'calendar' && <CalendarView />}
                                {view === 'importExport' && <ImportExport />}
                                {view === 'log' && (
                                    <div className="bg-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-xl font-bold mb-4 text-blue-800">Historial de Actividad</h3>
                                        {activityLog.length > 0 ? (
                                            <div className="overflow-x-auto">
                                                <ul className="divide-y divide-gray-200">
                                                    {activityLog.map(log => (
                                                        <li key={log.id} className="py-4">
                                                            <div className="flex justify-between items-center">
                                                                <div>
                                                                    <span className="font-bold text-blue-800 uppercase mr-2">{log.action}:</span>
                                                                    <span className="text-gray-700">{log.details}</span>
                                                                </div>
                                                                <span className="text-gray-500 text-xs">{formatDate(log.timestamp)}</span>
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : (
                                            <p className="text-center text-gray-500 p-8 bg-white">No hay actividad reciente.</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                    {userId && (
                        <div className="mt-8 text-center text-gray-500">
                            ID de Usuario: <span className="font-mono">{userId}</span>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
