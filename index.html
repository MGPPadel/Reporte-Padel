<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe de Clases de Padel</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail, browserSessionPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
 const firebaseConfig = {
  apiKey: "AIzaSyAvk1yOsxXfc2w4YwZ1R1tQFrQuM2AbEYk",
  authDomain: "app-de-padel.firebaseapp.com",
  projectId: "app-de-padel",
  storageBucket: "app-de-padel.firebasestorage.app",
  messagingSenderId: "731771747398",
  appId: "1:731771747398:web:ebc8b723fe220869fade47"
};
        let db;
        let auth;
        let storage;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
        }
    </script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const App = () => {
            const [classes, setClasses] = useState([]);
            const [allClasses, setAllClasses] = useState([]);
            const [monthlyEarnings, setMonthlyEarnings] = useState([]);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [showClassForm, setShowClassForm] = useState(false);
            const [classData, setClassData] = useState({ student: '', price: '', notes: '' });
            const [monthlyReport, setMonthlyReport] = useState(null);
            const [payments, setPayments] = useState([]);
            const [showPayments, setShowPayments] = useState(false);
            const [showStudents, setShowStudents] = useState(false);
            const [students, setStudents] = useState([]);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            const [registerData, setRegisterData] = useState({ email: '', password: '' });
            const [showRegister, setShowRegister] = useState(false);
            const [showLogin, setShowLogin] = useState(true);
            const [loginError, setLoginError] = useState('');
            const [registerError, setRegisterError] = useState('');
            const [resetPasswordEmail, setResetPasswordEmail] = useState('');
            const [showPasswordReset, setShowPasswordReset] = useState(false);
            const [passwordResetSuccess, setPasswordResetSuccess] = useState('');
            const [showLogs, setShowLogs] = useState(false);
            const [logs, setLogs] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [showSearch, setShowSearch] = useState(false);
            const [calendarView, setCalendarView] = useState(null);
            const [showMonthlyReport, setShowMonthlyReport] = useState(false);
            const [selectedReportMonth, setSelectedReportMonth] = useState('');

            const classFormRef = useRef(null);

            useEffect(() => {
                if (auth) {
                    setPersistence(auth, browserSessionPersistence)
                        .then(() => {
                            console.log("Persistence set to session");
                        })
                        .catch((error) => {
                            console.error("Error setting persistence:", error);
                        });
                    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                        if (currentUser) {
                            setIsLoggedIn(true);
                            setUser(currentUser);
                            setUserId(currentUser.uid);
                            console.log("User logged in:", currentUser.uid);
                            fetchData(currentUser.uid);
                            addLog(`Usuario ${currentUser.email} ha iniciado sesiÃ³n.`, currentUser.uid);
                            setLoginError('');
                            setRegisterError('');
                        } else {
                            setIsLoggedIn(false);
                            setUser(null);
                            setUserId(null);
                            console.log("User logged out");
                            setClasses([]);
                            setAllClasses([]);
                            setMonthlyEarnings([]);
                            setPayments([]);
                            setStudents([]);
                            setLogs([]);
                            setLoginData({ email: '', password: '' });
                            setRegisterData({ email: '', password: '' });
                        }
                    });
                    return () => unsubscribe();
                }
            }, [auth]);

            useEffect(() => {
                if (userId) {
                    fetchData(userId);
                }
            }, [userId]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (classFormRef.current && !classFormRef.current.contains(event.target)) {
                        setShowClassForm(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [classFormRef]);

            const fetchData = async (uid) => {
                if (db) {
                    console.log("Fetching data for user:", uid);
                    const classesQuery = query(collection(db, "classes"), where("userId", "==", uid));
                    const paymentsQuery = query(collection(db, "payments"), where("userId", "==", uid));
                    const studentsQuery = query(collection(db, "students"), where("userId", "==", uid));
                    const logsQuery = query(collection(db, "logs"), where("userId", "==", uid));

                    onSnapshot(classesQuery, (snapshot) => {
                        const classesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setAllClasses(classesData);
                        setClasses(classesData);
                        console.log("Fetched classes:", classesData.length);
                        calculateMonthlyEarnings(classesData);
                    });

                    onSnapshot(paymentsQuery, (snapshot) => {
                        const paymentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setPayments(paymentsData);
                        console.log("Fetched payments:", paymentsData.length);
                    });

                    onSnapshot(studentsQuery, (snapshot) => {
                        const studentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStudents(studentsData);
                        console.log("Fetched students:", studentsData.length);
                    });

                    onSnapshot(logsQuery, (snapshot) => {
                        const logsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setLogs(logsData.sort((a, b) => b.timestamp - a.timestamp));
                        console.log("Fetched logs:", logsData.length);
                    });
                }
            };

            const calculateMonthlyEarnings = (data) => {
                const monthly = {};
                data.forEach(c => {
                    const date = new Date(c.date);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    const key = `${month}/${year}`;
                    if (!monthly[key]) {
                        monthly[key] = 0;
                    }
                    monthly[key] += parseFloat(c.price);
                });
                const sortedMonthly = Object.keys(monthly).map(key => ({
                    month: key,
                    earnings: monthly[key]
                })).sort((a, b) => {
                    const [monthA, yearA] = a.month.split('/').map(Number);
                    const [monthB, yearB] = b.month.split('/').map(Number);
                    if (yearA !== yearB) return yearA - yearB;
                    return monthA - monthB;
                });
                setMonthlyEarnings(sortedMonthly);
            };

            const addLog = async (action, uid, details = '') => {
                if (!db || !uid) return;
                try {
                    const docRef = await addDoc(collection(db, "logs"), {
                        action: action,
                        details: details,
                        timestamp: Date.now(),
                        userId: uid
                    });
                    console.log("Log added with ID: ", docRef.id);
                } catch (e) {
                    console.error("Error adding log: ", e);
                }
            };

            const addClass = async (e) => {
                e.preventDefault();
                if (!db || !userId) return;
                try {
                    const newClass = {
                        ...classData,
                        date: selectedDate.toISOString(),
                        createdAt: Date.now(),
                        userId: userId
                    };
                    const docRef = await addDoc(collection(db, "classes"), newClass);
                    console.log("Class added with ID: ", docRef.id);
                    addLog('Clase agregada', userId, `Clase con ${classData.student} por ${classData.price}â¬`);
                    setClassData({ student: '', price: '', notes: '' });
                    setShowClassForm(false);
                    const studentExists = students.some(student => student.name.toLowerCase() === classData.student.toLowerCase());
                    if (!studentExists && classData.student) {
                        await addDoc(collection(db, "students"), { name: classData.student, userId: userId });
                        addLog('Nuevo alumno agregado', userId, `Alumno: ${classData.student}`);
                    }
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            };

            const deleteClass = async (id, student) => {
                if (!db || !userId) return;
                try {
                    await deleteDoc(doc(db, "classes", id));
                    console.log("Class deleted with ID:", id);
                    addLog('Clase eliminada', userId, `Clase de ${student} eliminada`);
                } catch (e) {
                    console.error("Error deleting document:", e);
                }
            };

            const addPayment = async (e) => {
                e.preventDefault();
                if (!db || !userId) return;
                try {
                    const newPayment = {
                        student: e.target.student.value,
                        amount: parseFloat(e.target.amount.value),
                        date: new Date().toISOString(),
                        createdAt: Date.now(),
                        userId: userId
                    };
                    const docRef = await addDoc(collection(db, "payments"), newPayment);
                    console.log("Payment added with ID: ", docRef.id);
                    addLog('Pago registrado', userId, `Pago de ${newPayment.student} por ${newPayment.amount}â¬`);
                    e.target.reset();
                } catch (e) {
                    console.error("Error adding payment: ", e);
                }
            };

            const deletePayment = async (id, student) => {
                if (!db || !userId) return;
                try {
                    await deleteDoc(doc(db, "payments", id));
                    console.log("Payment deleted with ID:", id);
                    addLog('Pago eliminado', userId, `Pago de ${student} eliminado`);
                } catch (e) {
                    console.error("Error deleting payment:", e);
                }
            };

            const generateMonthlyReport = async (month, year) => {
                const report = {};
                const classesInMonth = allClasses.filter(c => {
                    const classDate = new Date(c.date);
                    return classDate.getMonth() === month && classDate.getFullYear() === year;
                });

                let totalIncome = 0;
                classesInMonth.forEach(c => {
                    if (!report[c.student]) {
                        report[c.student] = { classes: 0, income: 0, payments: 0, balance: 0 };
                    }
                    report[c.student].classes++;
                    report[c.student].income += parseFloat(c.price);
                    totalIncome += parseFloat(c.price);
                });

                const paymentsInMonth = payments.filter(p => {
                    const paymentDate = new Date(p.date);
                    return paymentDate.getMonth() === month && paymentDate.getFullYear() === year;
                });

                paymentsInMonth.forEach(p => {
                    if (!report[p.student]) {
                        report[p.student] = { classes: 0, income: 0, payments: 0, balance: 0 };
                    }
                    report[p.student].payments += parseFloat(p.amount);
                });

                Object.keys(report).forEach(student => {
                    report[student].balance = report[student].income - report[student].payments;
                });

                setMonthlyReport({ report, totalIncome, month, year });
                addLog('Informe mensual generado', userId, `Informe de ${month + 1}/${year}`);
            };

            const exportData = () => {
                const data = {
                    classes: allClasses,
                    payments: payments,
                    students: students
                };
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `padel_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                addLog('Datos exportados', userId, 'Se exportaron los datos del club a un archivo JSON.');
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.classes && importedData.payments && importedData.students) {
                            if (confirm("Â¿EstÃ¡s seguro de que deseas importar estos datos? Esto reemplazarÃ¡ los datos existentes.")) {
                                const batch = db.batch();

                                const currentClasses = await getDocs(query(collection(db, "classes"), where("userId", "==", userId)));
                                currentClasses.forEach(doc => {
                                    batch.delete(doc.ref);
                                });

                                const currentPayments = await getDocs(query(collection(db, "payments"), where("userId", "==", userId)));
                                currentPayments.forEach(doc => {
                                    batch.delete(doc.ref);
                                });

                                const currentStudents = await getDocs(query(collection(db, "students"), where("userId", "==", userId)));
                                currentStudents.forEach(doc => {
                                    batch.delete(doc.ref);
                                });

                                await batch.commit();
                                console.log("Old data cleared.");

                                const newBatch = db.batch();
                                importedData.classes.forEach(c => {
                                    const newDocRef = doc(collection(db, "classes"));
                                    newBatch.set(newDocRef, { ...c, userId: userId });
                                });

                                importedData.payments.forEach(p => {
                                    const newDocRef = doc(collection(db, "payments"));
                                    newBatch.set(newDocRef, { ...p, userId: userId });
                                });

                                importedData.students.forEach(s => {
                                    const newDocRef = doc(collection(db, "students"));
                                    newBatch.set(newDocRef, { ...s, userId: userId });
                                });
                                await newBatch.commit();
                                console.log("New data imported.");
                                addLog('Datos importados', userId, 'Se importaron nuevos datos desde un archivo JSON.');
                                alert("Datos importados exitosamente.");
                            }
                        } else {
                            alert("Archivo JSON no vÃ¡lido. Por favor, asegÃºrate de que contenga las claves 'classes', 'payments' y 'students'.");
                        }
                    } catch (e) {
                        console.error("Error importing data:", e);
                        alert("Error al importar el archivo. Por favor, asegÃºrate de que sea un archivo JSON vÃ¡lido.");
                    }
                };
                reader.readAsText(file);
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoginError('');
                try {
                    await signInWithEmailAndPassword(auth, loginData.email, loginData.password);
                } catch (error) {
                    console.error("Login failed:", error);
                    setLoginError("Error de inicio de sesiÃ³n. Por favor, verifica tu email y contraseÃ±a.");
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setRegisterError('');
                try {
                    await createUserWithEmailAndPassword(auth, registerData.email, registerData.password);
                    setLoginData({ email: registerData.email, password: registerData.password });
                    setShowLogin(true);
                    setShowRegister(false);
                } catch (error) {
                    console.error("Registration failed:", error);
                    setRegisterError("Error de registro. Por favor, intÃ©ntalo de nuevo.");
                }
            };

            const handleLogout = async () => {
                if (auth) {
                    addLog(`Usuario ${user.email} ha cerrado sesiÃ³n.`, userId);
                    await signOut(auth);
                }
            };

            const handlePasswordReset = async (e) => {
                e.preventDefault();
                if (!resetPasswordEmail) {
                    setLoginError("Por favor, ingresa tu email.");
                    return;
                }
                setLoginError('');
                try {
                    await sendPasswordResetEmail(auth, resetPasswordEmail);
                    setPasswordResetSuccess('Se ha enviado un correo de recuperaciÃ³n de contraseÃ±a. Por favor, revisa tu bandeja de entrada.');
                } catch (error) {
                    console.error("Password reset failed:", error);
                    setLoginError('Error al enviar el correo de recuperaciÃ³n. Por favor, verifica el email.');
                }
            };

            const handleShowMonth = (year, month) => {
                const daysInMonth = Array.from({ length: new Date(year, month + 1, 0).getDate() }, (_, i) => i + 1);

                const dailyEarnings = daysInMonth.map((day) => {
                    const date = new Date(year, month, day);
                    const dailyIncome = allClasses.filter(c =>
                        new Date(c.date).toDateString() === date.toDateString()
                    ).reduce((total, c) => total + parseFloat(c.price), 0);

                    return {
                        date: date,
                        dailyIncome: dailyIncome
                    };
                });

                setCalendarView({
                    year,
                    month,
                    days: dailyEarnings
                });
            };

            const formatDate = (timestamp) => {
                const date = new Date(timestamp);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            };

            const getDayName = (dayIndex) => {
                const days = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
                return days[dayIndex];
            };

            const getMonthName = (monthIndex) => {
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                return months[monthIndex];
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount);
            };

            const filteredClasses = classes.filter(c => {
                const studentName = c.student.toLowerCase();
                const notes = c.notes.toLowerCase();
                const term = searchTerm.toLowerCase();
                return studentName.includes(term) || notes.includes(term);
            });

            const filteredPayments = payments.filter(p => {
                const studentName = p.student.toLowerCase();
                const term = searchTerm.toLowerCase();
                return studentName.includes(term);
            });

            return (
                <div className="min-h-screen bg-gray-100 p-4 font-sans text-gray-800">
                    <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white text-center">
                            <h1 className="text-3xl font-bold mb-1">Informe de Clases de Padel</h1>
                            <p className="text-sm opacity-90">GestiÃ³n de tu negocio de pÃ¡del de forma simple y eficiente.</p>
                            {isLoggedIn && (
                                <button
                                    onClick={handleLogout}
                                    className="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-xs transition duration-300"
                                >
                                    Cerrar sesiÃ³n
                                </button>
                            )}
                        </div>

                        {!isLoggedIn && (
                            <div className="p-8">
                                <div className="max-w-sm mx-auto bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200">
                                    {showLogin && (
                                        <>
                                            <h2 className="text-2xl font-bold text-center text-blue-800 mb-6">Iniciar SesiÃ³n</h2>
                                            {loginError && <p className="text-red-500 text-center mb-4">{loginError}</p>}
                                            <form onSubmit={handleLogin} className="space-y-4">
                                                <input
                                                    type="email"
                                                    placeholder="Email"
                                                    className="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    value={loginData.email}
                                                    onChange={(e) => setLoginData({ ...loginData, email: e.target.value })}
                                                />
                                                <input
                                                    type="password"
                                                    placeholder="ContraseÃ±a"
                                                    className="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    value={loginData.password}
                                                    onChange={(e) => setLoginData({ ...loginData, password: e.target.value })}
                                                />
                                                <button
                                                    type="submit"
                                                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300 font-semibold"
                                                >
                                                    Entrar
                                                </button>
                                            </form>
                                            <div className="flex justify-between mt-4 text-sm">
                                                <button
                                                    onClick={() => { setShowRegister(true); setShowLogin(false); setLoginError(''); setPasswordResetSuccess(''); }}
                                                    className="text-blue-600 hover:underline"
                                                >
                                                    Crear cuenta
                                                </button>
                                                <button
                                                    onClick={() => { setShowPasswordReset(true); setShowLogin(false); setLoginError(''); }}
                                                    className="text-blue-600 hover:underline"
                                                >
                                                    OlvidÃ© mi contraseÃ±a
                                                </button>
                                            </div>
                                        </>
                                    )}
                                    {showRegister && (
                                        <>
                                            <h2 className="text-2xl font-bold text-center text-blue-800 mb-6">Crear Cuenta</h2>
                                            {registerError && <p className="text-red-500 text-center mb-4">{registerError}</p>}
                                            <form onSubmit={handleRegister} className="space-y-4">
                                                <input
                                                    type="email"
                                                    placeholder="Email"
                                                    className="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    value={registerData.email}
                                                    onChange={(e) => setRegisterData({ ...registerData, email: e.target.value })}
                                                />
                                                <input
                                                    type="password"
                                                    placeholder="ContraseÃ±a"
                                                    className="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    value={registerData.password}
                                                    onChange={(e) => setRegisterData({ ...registerData, password: e.target.value })}
                                                />
                                                <button
                                                    type="submit"
                                                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300 font-semibold"
                                                >
                                                    Registrar
                                                </button>
                                            </form>
                                            <div className="text-center mt-4 text-sm">
                                                <button
                                                    onClick={() => { setShowRegister(false); setShowLogin(true); setRegisterError(''); }}
                                                    className="text-blue-600 hover:underline"
                                                >
                                                    Ya tengo una cuenta
                                                </button>
                                            </div>
                                        </>
                                    )}
                                    {showPasswordReset && (
                                        <>
                                            <h2 className="text-2xl font-bold text-center text-blue-800 mb-6">Restablecer ContraseÃ±a</h2>
                                            {loginError && <p className="text-red-500 text-center mb-4">{loginError}</p>}
                                            {passwordResetSuccess && <p className="text-green-600 text-center mb-4">{passwordResetSuccess}</p>}
                                            <form onSubmit={handlePasswordReset} className="space-y-4">
                                                <input
                                                    type="email"
                                                    placeholder="Email"
                                                    className="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    value={resetPasswordEmail}
                                                    onChange={(e) => setResetPasswordEmail(e.target.value)}
                                                />
                                                <button
                                                    type="submit"
                                                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300 font-semibold"
                                                >
                                                    Enviar
                                                </button>
                                            </form>
                                            <div className="text-center mt-4 text-sm">
                                                <button
                                                    onClick={() => { setShowPasswordReset(false); setShowLogin(true); setLoginError(''); }}
                                                    className="text-blue-600 hover:underline"
                                                >
                                                    Volver al inicio de sesiÃ³n
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {isLoggedIn && (
                            <>
                                <div className="p-8">
                                    <div className="flex flex-col md:flex-row md:justify-between md:items-center mb-6 space-y-4 md:space-y-0">
                                        <div className="flex-1 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                                            <div className="flex-1">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Total de Ingresos</label>
                                                <div className="bg-green-100 text-green-800 p-3 rounded-md font-bold text-lg text-center">
                                                    {formatCurrency(allClasses.reduce((sum, c) => sum + parseFloat(c.price), 0))}
                                                </div>
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Clases totales</label>
                                                <div className="bg-blue-100 text-blue-800 p-3 rounded-md font-bold text-lg text-center">
                                                    {allClasses.length}
                                                </div>
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Pagos totales</label>
                                                <div className="bg-yellow-100 text-yellow-800 p-3 rounded-md font-bold text-lg text-center">
                                                    {formatCurrency(payments.reduce((sum, p) => sum + parseFloat(p.amount), 0))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center text-sm font-medium text-gray-700 mb-6">
                                        <button onClick={() => { setShowClassForm(true); setShowPayments(false); setShowStudents(false); setShowLogs(false); setShowSearch(false); setShowMonthlyReport(false); setSelectedDate(new Date()); }} className="p-3 bg-blue-500 text-white rounded-lg shadow-sm hover:bg-blue-600 transition">
                                            <i className="fa-solid fa-plus-circle mr-2"></i>Nueva Clase
                                        </button>
                                        <button onClick={() => { setShowPayments(true); setShowClassForm(false); setShowStudents(false); setShowLogs(false); setShowSearch(false); setShowMonthlyReport(false); }} className="p-3 bg-yellow-500 text-white rounded-lg shadow-sm hover:bg-yellow-600 transition">
                                            <i className="fa-solid fa-money-bill-transfer mr-2"></i>Pagos
                                        </button>
                                        <button onClick={() => { setShowStudents(true); setShowPayments(false); setShowClassForm(false); setShowLogs(false); setShowSearch(false); setShowMonthlyReport(false); }} className="p-3 bg-green-500 text-white rounded-lg shadow-sm hover:bg-green-600 transition">
                                            <i className="fa-solid fa-users mr-2"></i>Alumnos
                                        </button>
                                        <button onClick={() => { setShowSearch(true); setShowStudents(false); setShowPayments(false); setShowClassForm(false); setShowLogs(false); setShowMonthlyReport(false); }} className="p-3 bg-gray-500 text-white rounded-lg shadow-sm hover:bg-gray-600 transition">
                                            <i className="fa-solid fa-search mr-2"></i>Buscar
                                        </button>
                                        <button onClick={() => { setShowLogs(true); setShowStudents(false); setShowPayments(false); setShowClassForm(false); setShowSearch(false); setShowMonthlyReport(false); }} className="p-3 bg-purple-500 text-white rounded-lg shadow-sm hover:bg-purple-600 transition">
                                            <i className="fa-solid fa-clipboard-list mr-2"></i>Actividad
                                        </button>
                                        <button onClick={() => { setShowMonthlyReport(true); setShowLogs(false); setShowStudents(false); setShowPayments(false); setShowClassForm(false); setShowSearch(false); }} className="p-3 bg-teal-500 text-white rounded-lg shadow-sm hover:bg-teal-600 transition">
                                            <i className="fa-solid fa-chart-bar mr-2"></i>Informe Mensual
                                        </button>
                                        <button onClick={exportData} className="p-3 bg-orange-500 text-white rounded-lg shadow-sm hover:bg-orange-600 transition">
                                            <i className="fa-solid fa-download mr-2"></i>Exportar
                                        </button>
                                        <div className="relative">
                                            <input type="file" onChange={importData} className="hidden" id="importFile" accept=".json" />
                                            <label htmlFor="importFile" className="p-3 bg-indigo-500 text-white rounded-lg shadow-sm hover:bg-indigo-600 transition cursor-pointer flex items-center justify-center h-full">
                                                <i className="fa-solid fa-upload mr-2"></i>Importar
                                            </label>
                                        </div>
                                    </div>

                                    {showClassForm && (
                                        <div ref={classFormRef} className="bg-white p-6 rounded-lg shadow-inner mt-6">
                                            <h3 className="text-xl font-semibold mb-4 text-blue-800">Agregar Nueva Clase</h3>
                                            <form onSubmit={addClass} className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700">Alumno</label>
                                                    <input
                                                        type="text"
                                                        value={classData.student}
                                                        onChange={(e) => setClassData({ ...classData, student: e.target.value })}
                                                        placeholder="Nombre del alumno"
                                                        required
                                                        className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                        list="student-list"
                                                    />
                                                    <datalist id="student-list">
                                                        {students.map((student) => (
                                                            <option key={student.id} value={student.name} />
                                                        ))}
                                                    </datalist>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700">Precio</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        value={classData.price}
                                                        onChange={(e) => setClassData({ ...classData, price: e.target.value })}
                                                        placeholder="Precio"
                                                        required
                                                        className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700">Notas</label>
                                                    <textarea
                                                        value={classData.notes}
                                                        onChange={(e) => setClassData({ ...classData, notes: e.target.value })}
                                                        placeholder="Notas adicionales"
                                                        className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    ></textarea>
                                                </div>
                                                <button
                                                    type="submit"
                                                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-semibold"
                                                >
                                                    Agregar Clase
                                                </button>
                                            </form>
                                        </div>
                                    )}

                                    {showPayments && (
                                        <div className="bg-white p-6 rounded-lg shadow-inner mt-6">
                                            <h3 className="text-xl font-semibold mb-4 text-yellow-800">Registrar Pagos</h3>
                                            <form onSubmit={addPayment} className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700">Alumno</label>
                                                    <input
                                                        type="text"
                                                        name="student"
                                                        placeholder="Nombre del alumno"
                                                        required
                                                        className="mt-1 w-full p-2 border border-gray-300 rounded-md"
                                                        list="student-list"
                                                    />
                                                    <datalist id="student-list">
                                                        {students.map((student) => (
                                                            <option key={student.id} value={student.name} />
                                                        ))}
                                                    </datalist>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700">Monto</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        name="amount"
                                                        placeholder="Monto del pago"
                                                        required
                                                        className="mt-1 w-full p-2 border border-gray-300 rounded-md"
                                                    />
                                                </div>
                                                <button type="submit" className="w-full bg-yellow-600 text-white py-2 rounded-md hover:bg-yellow-700 transition font-semibold">Registrar Pago</button>
                                            </form>
                                            <h4 className="text-lg font-semibold mt-6 mb-2 text-yellow-800">Historial de Pagos</h4>
                                            <ul className="space-y-2 max-h-64 overflow-y-auto pr-2">
                                                {payments.sort((a, b) => b.createdAt - a.createdAt).map(p => (
                                                    <li key={p.id} className="flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-md">
                                                        <div className="flex-1">
                                                            <span className="font-medium">{p.student}</span> - <span className="text-green-600 font-semibold">{formatCurrency(p.amount)}</span>
                                                            <p className="text-xs text-gray-500">{new Date(p.date).toLocaleDateString()}</p>
                                                        </div>
                                                        <button
                                                            onClick={() => deletePayment(p.id, p.student)}
                                                            className="text-red-500 hover:text-red-700 transition"
                                                            title="Eliminar Pago"
                                                        >
                                                            <i className="fa-solid fa-trash"></i>
                                                        </button>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {showStudents && (
                                        <div className="bg-white p-6 rounded-lg shadow-inner mt-6">
                                            <h3 className="text-xl font-semibold mb-4 text-green-800">Listado de Alumnos</h3>
                                            <ul className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                                {students.map(s => (
                                                    <li key={s.id} className="p-3 bg-gray-50 border border-gray-200 rounded-md flex items-center justify-between">
                                                        <span className="font-medium text-gray-700">{s.name}</span>
                                                        <span className="text-sm text-gray-500">{allClasses.filter(c => c.student === s.name).length} clases</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {showSearch && (
                                        <div className="bg-white p-6 rounded-lg shadow-inner mt-6">
                                            <h3 className="text-xl font-semibold mb-4 text-gray-800">Buscar Clases y Pagos</h3>
                                            <input
                                                type="text"
                                                placeholder="Buscar por alumno o notas..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500 mb-4"
                                            />
                                            {searchTerm && (
                                                <div className="space-y-4">
                                                    <div>
                                                        <h4 className="font-semibold text-lg text-gray-600 mb-2">Clases</h4>
                                                        {filteredClasses.length > 0 ? (
                                                            <ul className="space-y-2">
                                                                {filteredClasses.map(c => (
                                                                    <li key={c.id} className="p-3 bg-blue-50 border-l-4 border-blue-400 rounded-md flex justify-between items-center">
                                                                        <div className="flex-1">
                                                                            <p className="font-medium text-blue-800">{c.student}</p>
                                                                            <p className="text-sm text-gray-600">
                                                                                <i className="fa-solid fa-calendar-alt mr-1"></i>
                                                                                {new Date(c.date).toLocaleDateString()}
                                                                            </p>
                                                                            <p className="text-sm text-gray-600">
                                                                                <i className="fa-solid fa-money-bill-wave mr-1"></i>
                                                                                {formatCurrency(c.price)}
                                                                            </p>
                                                                            {c.notes && <p className="text-xs text-gray-500 mt-1 italic">Notas: {c.notes}</p>}
                                                                        </div>
                                                                        <button onClick={() => deleteClass(c.id, c.student)} className="text-red-500 hover:text-red-700" title="Eliminar Clase">
                                                                            <i className="fa-solid fa-trash"></i>
                                                                        </button>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        ) : (
                                                            <p className="text-gray-500 text-sm italic">No se encontraron clases.</p>
                                                        )}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-semibold text-lg text-gray-600 mb-2">Pagos</h4>
                                                        {filteredPayments.length > 0 ? (
                                                            <ul className="space-y-2">
                                                                {filteredPayments.map(p => (
                                                                    <li key={p.id} className="p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-md flex justify-between items-center">
                                                                        <div className="flex-1">
                                                                            <p className="font-medium text-yellow-800">{p.student}</p>
                                                                            <p className="text-sm text-gray-600">
                                                                                <i className="fa-solid fa-calendar-alt mr-1"></i>
                                                                                {new Date(p.date).toLocaleDateString()}
                                                                            </p>
                                                                            <p className="text-sm text-gray-600">
                                                                                <i className="fa-solid fa-money-bill-wave mr-1"></i>
                                                                                {formatCurrency(p.amount)}
                                                                            </p>
                                                                        </div>
                                                                        <button onClick={() => deletePayment(p.id, p.student)} className="text-red-500 hover:text-red-700" title="Eliminar Pago">
                                                                            <i className="fa-solid fa-trash"></i>
                                                                        </button>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        ) : (
                                                            <p className="text-gray-500 text-sm italic">No se encontraron pagos.</p>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {showMonthlyReport && (
                                        <div className="bg-white p-6 rounded-lg shadow-inner mt-6">
                                            <h3 className="text-xl font-semibold mb-4 text-teal-800">Generar Informe Mensual</h3>
                                            <div className="flex items-center space-x-2 mb-4">
                                                <input
                                                    type="month"
                                                    value={selectedReportMonth}
                                                    onChange={(e) => setSelectedReportMonth(e.target.value)}
                                                    className="p-2 border rounded-md"
                                                />
                                                <button
                                                    onClick={() => {
                                                        const [year, month] = selectedReportMonth.split('-').map(Number);
                                                        if (year && month) {
                                                            generateMonthlyReport(month - 1, year);
                                                        } else {
                                                            alert('Por favor, selecciona un mes y aÃ±o vÃ¡lidos.');
                                                        }
                                                    }}
                                                    className="p-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition"
                                                >
                                                    Generar
                                                </button>
                                            </div>
                                            {monthlyReport && (
                                                <div className="bg-gray-50 p-4 rounded-md">
                                                    <h4 className="text-lg font-bold text-teal-800 mb-2">
                                                        Informe de {getMonthName(monthlyReport.month)} {monthlyReport.year}
                                                    </h4>
                                                    <p className="font-semibold text-gray-700 mb-4">Total de Ingresos: <span className="text-green-600">{formatCurrency(monthlyReport.totalIncome)}</span></p>
                                                    <div className="overflow-x-auto">
                                                        <table className="min-w-full bg-white border border-gray-200">
                                                            <thead>
                                                                <tr className="bg-gray-100 text-left text-sm text-gray-600 uppercase">
                                                                    <th className="py-2 px-4 border-b">Alumno</th>
                                                                    <th className="py-2 px-4 border-b">Clases</th>
                                                                    <th className="py-2 px-4 border-b">Ingresos</th>
                                                                    <th className="py-2 px-4 border-b">Pagos</th>
                                                                    <th className="py-2 px-4 border-b">Saldo</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {Object.keys(monthlyReport.report).sort().map(student => (
                                                                    <tr key={student} className="hover:bg-gray-50">
                                                                        <td className="py-2 px-4 border-b text-gray-800 font-medium">{student}</td>
                                                                        <td className="py-2 px-4 border-b text-center">{monthlyReport.report[student].classes}</td>
                                                                        <td className="py-2 px-4 border-b text-green-600">{formatCurrency(monthlyReport.report[student].income)}</td>
                                                                        <td className="py-2 px-4 border-b text-yellow-600">{formatCurrency(monthlyReport.report[student].payments)}</td>
                                                                        <td className="py-2 px-4 border-b">
                                                                            <span className={monthlyReport.report[student].balance >= 0 ? "text-green-600 font-bold" : "text-red-600 font-bold"}>
                                                                                {formatCurrency(monthlyReport.report[student].balance)}
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="bg-white p-6 rounded-lg shadow-lg mt-6">
                                        <h3 className="text-2xl font-semibold mb-4 text-blue-800">
                                            Calendario de Clases
                                        </h3>
                                        <div className="flex justify-between items-center mb-4">
                                            <button
                                                onClick={() => handleShowMonth(selectedDate.getFullYear(), selectedDate.getMonth() - 1)}
                                                className="text-blue-600 hover:text-blue-800 transition"
                                            >
                                                <i className="fa-solid fa-chevron-left text-lg"></i>
                                            </button>
                                            <span className="text-xl font-bold text-gray-700">
                                                {getMonthName(selectedDate.getMonth())} {selectedDate.getFullYear()}
                                            </span>
                                            <button
                                                onClick={() => handleShowMonth(selectedDate.getFullYear(), selectedDate.getMonth() + 1)}
                                                className="text-blue-600 hover:text-blue-800 transition"
                                            >
                                                <i className="fa-solid fa-chevron-right text-lg"></i>
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-7 gap-1 text-center font-bold text-gray-500 uppercase text-xs">
                                            {['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'].map(day => (
                                                <div key={day} className="p-2">{day}</div>
                                            ))}
                                        </div>
                                        <div className="grid grid-cols-7 gap-1">
                                            {calendarView && Array.from({ length: new Date(calendarView.year, calendarView.month, 1).getDay() }).map((_, i) => (
                                                <div key={`empty-${i}`} className="p-2 text-gray-400"></div>
                                            ))}
                                            {calendarView && calendarView.days.map((day, index) => (
                                                <div
                                                    key={index}
                                                    className={`p-2 rounded-md transition-all duration-200 cursor-pointer 
                                                                ${day.date.toDateString() === new Date().toDateString() ? 'bg-blue-200 border-2 border-blue-500' : ''}
                                                                ${day.date.toDateString() === selectedDate.toDateString() && day.date.toDateString() !== new Date().toDateString() ? 'bg-blue-100 border-2 border-blue-400' : ''}
                                                                ${day.dailyIncome > 0 ? 'bg-green-100 hover:bg-green-200' : 'hover:bg-gray-100'}
                                                                relative group`}
                                                    onClick={() => { setSelectedDate(day.date); setShowClassForm(true); setShowPayments(false); setShowStudents(false); setShowLogs(false); setShowSearch(false); setShowMonthlyReport(false); }}
                                                >
                                                    <div className="text-xs font-semibold">{day.date.getDate()}</div>
                                                    {day.dailyIncome > 0 && (
                                                        <div className="text-xs font-bold text-green-700 mt-1">
                                                            {formatCurrency(day.dailyIncome)}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {selectedDate && (
                                        <div className="mt-6 p-6 bg-white rounded-lg shadow-lg">
                                            <h3 className="text-2xl font-semibold mb-4 text-blue-800">Clases del {selectedDate.toLocaleDateString()}</h3>
                                            <ul className="space-y-4">
                                                {allClasses.filter(c => new Date(c.date).toDateString() === selectedDate.toDateString()).length > 0 ? (
                                                    allClasses.filter(c => new Date(c.date).toDateString() === selectedDate.toDateString()).sort((a, b) => b.createdAt - a.createdAt).map(c => (
                                                        <li key={c.id} className="bg-gray-50 p-4 border border-gray-200 rounded-lg flex items-start justify-between">
                                                            <div>
                                                                <p className="text-lg font-bold text-blue-700">{c.student}</p>
                                                                <p className="text-sm text-green-600 font-semibold mt-1">{formatCurrency(c.price)}</p>
                                                                {c.notes && <p className="text-xs text-gray-600 italic mt-2">Notas: {c.notes}</p>}
                                                            </div>
                                                            <button
                                                                onClick={() => deleteClass(c.id, c.student)}
                                                                className="text-red-500 hover:text-red-700 transition"
                                                                title="Eliminar clase"
                                                            >
                                                                <i className="fa-solid fa-trash"></i>
                                                            </button>
                                                        </li>
                                                    ))
                                                ) : (
                                                    <p className="text-center text-gray-500 italic p-4">No hay clases registradas para esta fecha.</p>
                                                )}
                                            </ul>
                                        </div>
                                    )}
                                    
                                    {showLogs && (
                                        <div className="mt-6 p-6 bg-white rounded-lg shadow-lg">
                                            <h3 className="text-2xl font-semibold mb-4 text-purple-800">Registro de Actividad</h3>
                                            {logs.length > 0 ? (
                                                <div className="max-h-96 overflow-y-auto pr-2">
                                                    <ul className="space-y-3">
                                                        {logs.map(log => (
                                                            <li key={log.id} className="bg-purple-50 p-4 rounded-lg border border-purple-200 flex justify-between items-start">
                                                                <div className="flex-1">
                                                                    <span className="font-bold text-purple-800 uppercase mr-2">{log.action}:</span>
                                                                    <span className="text-gray-700">{log.details}</span>
                                                                </div>
                                                                <span className="text-gray-500 text-xs">{formatDate(log.timestamp)}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ) : (
                                                <p className="text-center text-gray-500 p-8 bg-white">No hay actividad reciente.</p>
                                            )}
                                        </div>
                                    )}
                                </div>
                                {userId && (
                                    <div className="mt-8 text-center text-gray-500">
                                        ID de Usuario: <span className="font-mono">{userId}</span>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>


