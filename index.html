<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe de Clases de Padel</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // Este script se encarga únicamente de las importaciones de módulos ES6 de Firebase.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, writeBatch, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variables globales del entorno de Canvas
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Inicializar Firebase y hacerlo globalmente accesible
        window.firebaseApp = initializeApp(window.firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            onSnapshot,
            doc,
            deleteDoc,
            updateDoc,
            writeBatch,
            query,
            where,
            addDoc
        };
    </script>
    
    <script type="text/babel">
        // Este script utiliza Babel para transpilar el código JSX de React.
        const { useState, useEffect } = React;

        const App = () => {
            const [classes, setClasses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [confirmAction, setConfirmAction] = useState(() => () => {});

            // Efecto para manejar la autenticación del usuario.
            useEffect(() => {
                const unsubscribeAuth = firebase.onAuthStateChanged(auth, async (currentUser) => {
                    if (!currentUser) {
                        if (initialAuthToken) {
                            try {
                                await firebase.signInWithCustomToken(auth, initialAuthToken);
                            } catch (e) {
                                console.error("Error signing in with custom token:", e);
                                setError("Error de autenticación. Intente recargar.");
                                setLoading(false);
                            }
                        } else {
                            try {
                                await firebase.signInAnonymously(auth);
                            } catch (e) {
                                console.error("Error signing in anonymously:", e);
                                setError("Error de autenticación anónima. Intente recargar.");
                                setLoading(false);
                            }
                        }
                    } else {
                        setUser(currentUser);
                        setIsAuthReady(true);
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            // Efecto para escuchar los cambios en Firestore.
            useEffect(() => {
                let unsubscribeSnapshot;
                if (isAuthReady && user) {
                    setLoading(true);
                    setError(null);
                    
                    // La ruta de la colección para los datos públicos.
                    const collectionPath = `artifacts/${appId}/public/data/padelClasses`;
                    const q = firebase.query(firebase.collection(db, collectionPath));
                    
                    unsubscribeSnapshot = firebase.onSnapshot(q, (snapshot) => {
                        const newClasses = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        // Agrupar clases por nombre y día para unificar la vista
                        const grouped = newClasses.reduce((acc, cls) => {
                            const key = `${cls.className}-${cls.day}-${cls.time}`;
                            if (!acc[key]) {
                                acc[key] = {
                                    className: cls.className,
                                    day: cls.day,
                                    trainer: cls.trainer,
                                    time: cls.time,
                                    students: [],
                                    ids: []
                                };
                            }
                            if (cls.students && cls.students.length > 0) {
                                const studentArray = Array.isArray(cls.students) ? cls.students : cls.students.split(',').map(s => s.trim());
                                acc[key].students = Array.from(new Set([...acc[key].students, ...studentArray]));
                            }
                            acc[key].ids.push(cls.id);
                            return acc;
                        }, {});
                        setClasses(Object.values(grouped));
                        setLoading(false);
                    }, (err) => {
                        console.error("Error al obtener los datos de la base de datos:", err);
                        setError("Error al cargar los datos. Por favor, recargue la página.");
                        setLoading(false);
                    });
                } else if (!user && isAuthReady) {
                    setLoading(false);
                    setClasses([]);
                }
                return () => {
                    if (unsubscribeSnapshot) {
                        unsubscribeSnapshot();
                    }
                };
            }, [isAuthReady, user]);

            const handleEditGroupedClass = (cls) => {
                // Tu lógica de edición
                alert(`Editar clase: ${cls.className} del día ${cls.day}`);
            };

            const handleDeleteGroupedClass = async (ids) => {
                setLoading(true);
                const batch = firebase.writeBatch(db);
                try {
                    for (const id of ids) {
                        const docRef = firebase.doc(db, `artifacts/${appId}/public/data/padelClasses`, id);
                        batch.delete(docRef);
                    }
                    await batch.commit();
                    console.log("Clase eliminada con éxito");
                } catch (e) {
                    console.error("Error al eliminar la clase:", e);
                    setError("Error al eliminar la clase. Por favor, intente de nuevo.");
                } finally {
                    setLoading(false);
                    setShowConfirmModal(false);
                }
            };

            const showConfirmation = (onConfirm) => {
                setConfirmAction(() => onConfirm);
                setShowConfirmModal(true);
            };

            const ConfirmModal = () => (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div className="relative p-8 bg-white w-96 max-w-md mx-auto rounded-lg shadow-xl text-center">
                        <h3 className="text-xl font-bold text-gray-900 mb-4">Confirmar Eliminación</h3>
                        <p className="text-sm text-gray-500 mb-6">¿Estás seguro de que quieres eliminar esta clase?</p>
                        <div className="flex justify-center space-x-4">
                            <button 
                                onClick={confirmAction} 
                                className="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition duration-200">
                                Confirmar
                            </button>
                            <button 
                                onClick={() => setShowConfirmModal(false)} 
                                className="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (!isAuthReady) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <i className="fas fa-spinner fa-spin text-4xl text-red-600"></i>
                        <p className="ml-4 text-xl text-gray-500">Cargando autenticación...</p>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <p className="text-xl text-red-600">{error}</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="max-w-7xl mx-auto w-full bg-white shadow-xl rounded-lg overflow-hidden">
                        <div className="p-6 border-b border-gray-200">
                            <h1 className="text-2xl font-bold text-gray-800">Informe de Clases de Padel</h1>
                            <p className="mt-1 text-sm text-gray-500">
                                Tu **ID de usuario para sincronizar datos** es: <span className="font-mono bg-gray-200 rounded-md p-1">{user?.uid || 'N/A'}</span>
                            </p>
                            <p className="mt-2 text-xs text-gray-500">
                                Copia este ID y úsalo en cualquier otro dispositivo para acceder a tus datos.
                            </p>
                        </div>
                        
                        {loading ? (
                            <div className="flex items-center justify-center p-8">
                                <i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                <p className="ml-4 text-xl text-blue-500">Cargando clases...</p>
                            </div>
                        ) : (
                            <div className="p-6">
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200 rounded-lg shadow-sm">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Clase
                                                </th>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Día
                                                </th>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Entrenador
                                                </th>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Hora
                                                </th>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Alumnos
                                                </th>
                                                <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Acciones
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {classes.length > 0 ? (
                                                classes.map((cls, index) => (
                                                    <tr key={index} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                            {cls.className}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {cls.day}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {cls.trainer}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {cls.time}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {cls.students.length > 0 ? cls.students.join(', ') : 'N/A'}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                            <button onClick={() => handleEditGroupedClass(cls)} className="text-blue-600 hover:text-blue-900 mr-2">
                                                                <i className="fas fa-edit"></i>
                                                            </button>
                                                            <button onClick={() => showConfirmation(() => handleDeleteGroupedClass(cls.ids))} className="text-red-600 hover:text-red-900">
                                                                <i className="fas fa-trash-alt"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr>
                                                    <td colSpan="6" className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center italic">
                                                        No hay clases registradas.
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                    {showConfirmModal && <ConfirmModal />}
                </div>
            );
        };
        
        // Renderizar la aplicación usando createRoot
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
</body>
</html>
