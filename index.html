import { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, updateDoc, writeBatch, where } from 'firebase/firestore';

// -- Hooks personalizados
// Un custom hook para manejar toda la lógica de Firebase.
const useFirebase = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [configError, setConfigError] = useState(null);
  const [userFirebaseConfig, setUserFirebaseConfig] = useState(null);

  useEffect(() => {
    // Si la configuración no está disponible, no se inicializa Firebase.
    if (!userFirebaseConfig) return;

    try {
      const firebaseApp = initializeApp(userFirebaseConfig);
      const firestore = getFirestore(firebaseApp);
      const authService = getAuth(firebaseApp);

      setDb(firestore);
      setAuth(authService);

      const unsubscribe = onAuthStateChanged(authService, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          try {
            // Manejar token de autenticación personalizado o iniciar sesión anónimamente
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialAuthToken) {
              await signInWithCustomToken(authService, initialAuthToken);
              setUserId(authService.currentUser.uid);
            } else {
              const anonymousUser = await signInAnonymously(authService);
              setUserId(anonymousUser.user.uid);
            }
          } catch (error) {
            console.error("Error signing in:", error);
            // Si hay un error, aún podemos usar un ID temporal para datos no persistentes.
            setUserId(crypto.randomUUID());
          }
        }
        setIsAuthReady(true);
      });

      return () => unsubscribe();
    } catch (error) {
      console.error("Error initializing Firebase:", error);
      setConfigError("Error al inicializar Firebase. Revise la configuración.");
    }
  }, [userFirebaseConfig]);

  return { db, auth, userId, isAuthReady, configError, setUserFirebaseConfig };
};

// -- Componentes de la aplicación
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
      <div className="relative p-8 border w-96 rounded-md shadow-lg bg-white">
        <h3 className="text-xl font-bold mb-4">{title}</h3>
        {children}
        <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
          <i className="fas fa-times"></i>
        </button>
      </div>
    </div>
  );
};

const ClassForm = ({ newEntry, handleInputChange, handleAddClass }) => (
  <div className="bg-white p-6 rounded-lg shadow-md mb-8">
    <h2 className="text-2xl font-bold mb-4 text-center text-blue-600">Ingresar nueva clase</h2>
    <form className="space-y-4" onSubmit={handleAddClass}>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">Nombre del Alumno</label>
          <input
            type="text"
            name="name"
            value={newEntry.name}
            onChange={handleInputChange}
            placeholder="Nombre del Alumno"
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">Horario</label>
          <input
            type="text"
            name="time"
            value={newEntry.time}
            onChange={handleInputChange}
            placeholder="Horario (ej. 10-11)"
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">Fecha</label>
          <input
            type="date"
            name="date"
            value={newEntry.date}
            onChange={handleInputChange}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">Precio</label>
          <input
            type="number"
            name="price"
            value={newEntry.price}
            onChange={handleInputChange}
            placeholder="Precio"
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            required
          />
        </div>
      </div>
      <button
        type="submit"
        className="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        Agregar Clase
      </button>
    </form>
  </div>
);

const ClassTable = ({
  groupedClasses,
  handleSearch,
  handleDeleteGroupedClass,
  handleEditClass,
  editingClass,
  setEditingClass,
  handleUpdateClass,
  formatCurrency,
  availableMonths,
  handleMonthChange,
  handleDateRangeChange,
  searchQuery,
  handleSearchChange
}) => (
  <div className="bg-white p-6 rounded-lg shadow-md mb-8">
    <h2 className="text-2xl font-bold mb-4 text-center text-blue-600">Clases Registradas</h2>
    <div className="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-4 sm:space-y-0 sm:space-x-4">
      <div className="flex-1 w-full">
        <label htmlFor="search-month" className="sr-only">Filtrar por Mes</label>
        <select
          id="search-month"
          onChange={handleMonthChange}
          className="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
        >
          <option value="">Filtrar por Mes...</option>
          {availableMonths.map((month, index) => (
            <option key={index} value={month}>{month}</option>
          ))}
        </select>
      </div>
      <div className="flex-1 w-full">
        <label htmlFor="search-input" className="sr-only">Buscar por Alumno</label>
        <div className="relative">
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i className="fas fa-search text-gray-400"></i>
          </div>
          <input
            id="search-input"
            type="text"
            value={searchQuery}
            onChange={handleSearchChange}
            placeholder="Buscar por Alumno..."
            className="block w-full pl-10 pr-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
          />
        </div>
      </div>
    </div>
    {/* Filtro por rango de fechas (opcional) */}
    <div className="mb-4">
      <h3 className="text-lg font-bold mb-2">Filtrar por rango de fechas:</h3>
      <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
        <input
          type="date"
          onChange={(e) => handleDateRangeChange(e.target.value, 'start')}
          className="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 w-full"
        />
        <input
          type="date"
          onChange={(e) => handleDateRangeChange(e.target.value, 'end')}
          className="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 w-full"
        />
      </div>
    </div>

    {/* Tabla de clases */}
    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          <tr>
            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alumno</th>
            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horario</th>
            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clases</th>
            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
            <th scope="col" className="relative px-6 py-3"><span className="sr-only">Acciones</span></th>
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {groupedClasses.length > 0 ? (
            groupedClasses.map((cls, index) => (
              <tr key={index}>
                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  {editingClass && editingClass.name === cls.name ? (
                    <input
                      type="text"
                      value={editingClass.name}
                      onChange={(e) => setEditingClass({ ...editingClass, name: e.target.value })}
                      className="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  ) : (
                    cls.name
                  )}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {editingClass && editingClass.name === cls.name ? (
                    <input
                      type="text"
                      value={editingClass.time}
                      onChange={(e) => setEditingClass({ ...editingClass, time: e.target.value })}
                      className="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  ) : (
                    cls.time
                  )}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {editingClass && editingClass.name === cls.name ? (
                    <input
                      type="number"
                      value={editingClass.count}
                      onChange={(e) => setEditingClass({ ...editingClass, count: parseInt(e.target.value) })}
                      className="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  ) : (
                    cls.count
                  )}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {formatCurrency(cls.totalPrice)}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  {editingClass && editingClass.name === cls.name ? (
                    <button onClick={() => handleUpdateClass(editingClass)} className="text-green-600 hover:text-green-900 mr-2">
                      <i className="fas fa-save"></i>
                    </button>
                  ) : (
                    <button onClick={() => handleEditClass(cls)} className="text-blue-600 hover:text-blue-900 mr-2">
                      <i className="fas fa-edit"></i>
                    </button>
                  )}
                  <button onClick={() => handleDeleteGroupedClass(cls.ids)} className="text-red-600 hover:text-red-900">
                    <i className="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colSpan="5" className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center italic">
                No hay clases registradas.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>
);

const Reports = ({ weeklyReports, monthlyReports, formatCurrency }) => (
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div className="bg-white p-6 rounded-lg shadow-md">
      <h2 className="text-2xl font-bold mb-4 text-center text-blue-600">Informes Semanales</h2>
      <div className="space-y-4">
        {Object.entries(weeklyReports).map(([week, report]) => (
          <div key={week} className="border-b pb-2 last:border-b-0">
            <h3 className="font-bold text-gray-700">Semana del {report.startDate} al {report.endDate}</h3>
            <p>Clases: <span className="font-medium">{report.count}</span></p>
            <p>Total: <span className="font-medium text-green-600">{formatCurrency(report.totalPrice)}</span></p>
          </div>
        ))}
      </div>
    </div>

    <div className="bg-white p-6 rounded-lg shadow-md">
      <h2 className="text-2xl font-bold mb-4 text-center text-blue-600">Informes Mensuales</h2>
      <div className="space-y-4">
        {Object.entries(monthlyReports).map(([month, report]) => (
          <div key={month} className="border-b pb-2 last:border-b-0">
            <h3 className="font-bold text-gray-700">{report.month}</h3>
            <p>Clases: <span className="font-medium">{report.count}</span></p>
            <p>Total: <span className="font-medium text-green-600">{formatCurrency(report.totalPrice)}</span></p>
          </div>
        ))}
      </div>
    </div>
  </div>
);

const App = () => {
  const [classes, setClasses] = useState([]);
  const [newEntry, setNewEntry] = useState({ name: '', time: '', date: '', price: '' });
  const [editingClass, setEditingClass] = useState(null);
  const [showConfigModal, setShowConfigModal] = useState(true);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [deletingClassIds, setDeletingClassIds] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedMonth, setSelectedMonth] = useState('');
  const [startDate, setStartDate] = useState(null);
  const [endDate, setEndDate] = useState(null);

  // Hook personalizado para Firebase
  const { db, auth, userId, isAuthReady, configError, setUserFirebaseConfig } = useFirebase();

  // Funciones y lógica de la aplicación
  const formatCurrency = (amount) => `$${amount.toFixed(2)}`;

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setNewEntry(prev => ({ ...prev, [name]: value }));
  };

  const handleAddClass = async (e) => {
    e.preventDefault();
    if (!isAuthReady || !db || !userId) {
      console.error("Firebase no está listo o el usuario no está autenticado.");
      return;
    }
    const classData = {
      ...newEntry,
      price: parseFloat(newEntry.price),
      date: newEntry.date,
      timestamp: new Date(newEntry.date).toISOString()
    };
    try {
      await addDoc(collection(db, `/artifacts/${__app_id}/users/${userId}/classes`), classData);
      setNewEntry({ name: '', time: '', date: '', price: '' });
    } catch (e) {
      console.error("Error adding document: ", e);
    }
  };

  const handleDeleteGroupedClass = (ids) => {
    setDeletingClassIds(ids);
    setShowDeleteModal(true);
  };

  const confirmDelete = async () => {
    if (!isAuthReady || !db || !userId || !deletingClassIds) return;

    try {
      const batch = writeBatch(db);
      deletingClassIds.forEach(id => {
        const docRef = doc(db, `/artifacts/${__app_id}/users/${userId}/classes`, id);
        batch.delete(docRef);
      });
      await batch.commit();
      setShowDeleteModal(false);
    } catch (e) {
      console.error("Error deleting documents: ", e);
    }
  };

  const handleEditClass = (cls) => {
    setEditingClass(cls);
  };

  const handleUpdateClass = async (updatedClass) => {
    if (!isAuthReady || !db || !userId || !updatedClass) return;

    try {
      const batch = writeBatch(db);
      updatedClass.ids.forEach(id => {
        const docRef = doc(db, `/artifacts/${__app_id}/users/${userId}/classes`, id);
        batch.update(docRef, { name: updatedClass.name, time: updatedClass.time });
      });
      await batch.commit();
      setEditingClass(null);
    } catch (e) {
      console.error("Error updating documents: ", e);
    }
  };
  
  const handleConfigSubmit = async (e) => {
    e.preventDefault();
    try {
      const config = JSON.parse(e.target.firebaseConfig.value);
      setUserFirebaseConfig(config);
      setShowConfigModal(false);
    } catch (error) {
      console.error("Invalid Firebase config:", error);
      setConfigError("La configuración de Firebase no es un JSON válido.");
    }
  };

  // Se encarga de suscribirse a los cambios en la base de datos de Firestore
  useEffect(() => {
    if (!isAuthReady || !db || !userId) return;

    const q = query(collection(db, `/artifacts/${__app_id}/users/${userId}/classes`));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const classesData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        timestamp: new Date(doc.data().timestamp)
      }));
      setClasses(classesData);
    });

    return () => unsubscribe();
  }, [db, userId, isAuthReady]);

  // Lógica de filtrado y reportes
  const filteredClasses = useMemo(() => {
    let filtered = classes;

    if (searchQuery) {
      filtered = filtered.filter(cls =>
        cls.name.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    if (selectedMonth) {
      filtered = filtered.filter(cls => {
        const classDate = new Date(cls.timestamp);
        return classDate.toLocaleString('es-ES', { month: 'long' }) === selectedMonth;
      });
    }

    if (startDate && endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      filtered = filtered.filter(cls => {
        const classDate = new Date(cls.date);
        return classDate >= start && classDate <= end;
      });
    }

    return filtered;
  }, [classes, searchQuery, selectedMonth, startDate, endDate]);

  const groupedClasses = useMemo(() => {
    const grouped = filteredClasses.reduce((acc, cls) => {
      const key = `${cls.name}-${cls.time}`;
      if (!acc[key]) {
        acc[key] = {
          name: cls.name,
          time: cls.time,
          count: 0,
          totalPrice: 0,
          ids: []
        };
      }
      acc[key].count += 1;
      acc[key].totalPrice += cls.price;
      acc[key].ids.push(cls.id);
      return acc;
    }, {});
    return Object.values(grouped);
  }, [filteredClasses]);

  const availableMonths = useMemo(() => {
    const months = [...new Set(classes.map(cls =>
      new Date(cls.timestamp).toLocaleString('es-ES', { month: 'long' })
    ))];
    return months.sort((a, b) => {
      const monthOrder = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
      return monthOrder.indexOf(a) - monthOrder.indexOf(b);
    });
  }, [classes]);

  const weeklyReports = useMemo(() => {
    const reports = {};
    filteredClasses.forEach(cls => {
      const date = new Date(cls.timestamp);
      const day = date.getDay(); // 0 = Domingo, 1 = Lunes
      const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Empezar la semana en Lunes
      const weekStart = new Date(date.setDate(diff));
      weekStart.setHours(0, 0, 0, 0);

      const weekKey = weekStart.toISOString().split('T')[0];
      if (!reports[weekKey]) {
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        reports[weekKey] = {
          count: 0,
          totalPrice: 0,
          startDate: weekStart.toLocaleDateString('es-ES'),
          endDate: weekEnd.toLocaleDateString('es-ES')
        };
      }
      reports[weekKey].count += 1;
      reports[weekKey].totalPrice += cls.price;
    });
    return reports;
  }, [filteredClasses]);

  const monthlyReports = useMemo(() => {
    const reports = {};
    filteredClasses.forEach(cls => {
      const date = new Date(cls.timestamp);
      const month = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
      if (!reports[month]) {
        reports[month] = { count: 0, totalPrice: 0, month };
      }
      reports[month].count += 1;
      reports[month].totalPrice += cls.price;
    });
    return reports;
  }, [filteredClasses]);

  return (
    <div className="bg-gray-100 min-h-screen p-8 font-sans">
      <div className="container mx-auto">
        <h1 className="text-4xl font-extrabold text-center text-blue-800 mb-8">
          Reporte de Clases de Pádel
        </h1>

        {/* Modal de Configuración de Firebase */}
        <Modal isOpen={showConfigModal} title="Configuración de Firebase" onClose={() => setShowConfigModal(false)}>
          <form onSubmit={handleConfigSubmit} className="space-y-4">
            <p className="text-sm text-gray-500">
              Por favor, ingrese su configuración de Firebase. Esto es necesario para guardar sus datos. Si el campo está vacío, la aplicación funcionará de forma anónima, pero los datos no serán persistentes.
            </p>
            <div>
              <label htmlFor="firebaseConfig" className="block text-sm font-medium text-gray-700">
                Configuración JSON
              </label>
              <textarea
                id="firebaseConfig"
                name="firebaseConfig"
                rows="5"
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                placeholder='Ej: {"apiKey": "...", "authDomain": "..."}'
              ></textarea>
            </div>
            {configError && <div className="text-red-500 text-sm">{configError}</div>}
            <button type="submit" className="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
              Guardar Configuración
            </button>
          </form>
        </Modal>

        {/* Modal de confirmación de eliminación */}
        <Modal isOpen={showDeleteModal} title="Confirmar Eliminación" onClose={() => setShowDeleteModal(false)}>
          <p className="mb-4">
            ¿Está seguro de que desea eliminar todas las clases de este alumno? Esta acción no se puede deshacer.
          </p>
          <div className="flex justify-end space-x-4">
            <button onClick={() => setShowDeleteModal(false)} className="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">
              Cancelar
            </button>
            <button onClick={confirmDelete} className="px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
              Eliminar
            </button>
          </div>
        </Modal>

        {userId && (
          <div className="bg-gray-200 p-4 rounded-lg shadow-inner mb-8">
            <p className="text-center text-sm text-gray-600">
              **ID de Usuario:** {userId}
            </p>
          </div>
        )}

        <ClassForm
          newEntry={newEntry}
          handleInputChange={handleInputChange}
          handleAddClass={handleAddClass}
        />

        <Reports
          weeklyReports={weeklyReports}
          monthlyReports={monthlyReports}
          formatCurrency={formatCurrency}
        />

        <ClassTable
          groupedClasses={groupedClasses}
          handleSearchChange={(e) => setSearchQuery(e.target.value)}
          handleMonthChange={(e) => setSelectedMonth(e.target.value)}
          handleDateRangeChange={(value, type) => {
            if (type === 'start') setStartDate(value);
            else setEndDate(value);
          }}
          handleDeleteGroupedClass={handleDeleteGroupedClass}
          handleEditClass={handleEditClass}
          editingClass={editingClass}
          setEditingClass={setEditingClass}
          handleUpdateClass={handleUpdateClass}
          formatCurrency={formatCurrency}
          availableMonths={availableMonths}
          searchQuery={searchQuery}
        />
      </div>
    </div>
  );
};

export default App;
