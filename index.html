<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe de Clases de Padel</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail, browserSessionPersistence, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, onSnapshot, writeBatch, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getFirestore = getFirestore;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.doc = doc;
    window.deleteDoc = deleteDoc;
    window.setDoc = setDoc;
    window.query = query;
    window.onSnapshot = onSnapshot;
    window.writeBatch = writeBatch;
    window.Timestamp = Timestamp;
    window.getDoc = getDoc;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.sendPasswordResetEmail = sendPasswordResetEmail;
    window.browserSessionPersistence = browserSessionPersistence;
    window.browserLocalPersistence = browserLocalPersistence;
    window.setPersistence = setPersistence;
</script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>
    <script type="text/babel">
// Componente aislado para el input con autocompletado (teclado + click + cierre al hacer clic fuera)
const AutocompleteStudentInput = ({ index, value, newEntry, setNewEntry, students }) => {
  const [activeIndex, setActiveIndex] = React.useState(-1);
  const [open, setOpen] = React.useState(false);
  const containerRef = React.useRef(null);

  const filteredStudents = React.useMemo(() => {
    const term = (newEntry.studentNames[index] || "").toLowerCase();
    if (!term) return [];
    return students
      .filter(stu => (`${stu.firstName} ${stu.lastName}`).toLowerCase().includes(term))
      .slice(0, 5);
  }, [students, newEntry.studentNames, index]);

  // Cerrar al hacer clic fuera
  React.useEffect(() => {
    const handleClickOutside = (e) => {
      if (containerRef.current && !containerRef.current.contains(e.target)) {
        setOpen(false);
        setActiveIndex(-1);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleKeyDown = (e) => {
    if (!open || filteredStudents.length === 0) return;
    if (e.key === "ArrowDown") {
      e.preventDefault();
      setActiveIndex((prev) => (prev + 1) % filteredStudents.length);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      setActiveIndex((prev) => (prev <= 0 ? filteredStudents.length - 1 : prev - 1));
    } else if (e.key === "Enter" && activeIndex >= 0) {
      e.preventDefault();
      const stu = filteredStudents[activeIndex];
      const newNames = [...newEntry.studentNames];
      newNames[index] = `${stu.firstName} ${stu.lastName}`;
      const newIds = [...(newEntry.studentIds || [])];
      newIds[index] = stu.id;
      setNewEntry((prev) => ({ ...prev, studentNames: newNames, studentIds: newIds }));
      setActiveIndex(-1);
      setOpen(false);
    }
  };

  const handleSelect = (stu) => {
    const newNames = [...newEntry.studentNames];
    newNames[index] = `${stu.firstName} ${stu.lastName}`;
    const newIds = [...(newEntry.studentIds || [])];
    newIds[index] = stu.id;
    setNewEntry((prev) => ({ ...prev, studentNames: newNames, studentIds: newIds }));
    setActiveIndex(-1);
    setOpen(false);
  };

  return (
    <div className="relative mb-2" ref={containerRef}>
      <input
        type="text"
        placeholder={`Alumno ${index + 1}`}
        value={newEntry.studentNames[index] || ""}
        onChange={(e) => {
          const val = e.target.value;
          const newNames = [...newEntry.studentNames];
          newNames[index] = val;
          setNewEntry((prev) => ({ ...prev, studentNames: newNames }));
          setActiveIndex(-1);
          setOpen(true);
        }}
        onFocus={() => setOpen(true)}
        onKeyDown={handleKeyDown}
        className="peer p-3 w-full border rounded-lg focus:ring-2 focus:ring-blue-500 transition-shadow"
      />

      {/* Contenedor de sugerencias */}
      {open && newEntry.studentNames[index] && filteredStudents.length > 0 && (
        <div
          className="absolute left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto z-50
                     opacity-0 translate-y-1 scale-95 pointer-events-none
                     transition-all duration-200 ease-out
                     peer-focus:opacity-100 peer-focus:translate-y-0 peer-focus:scale-100 peer-focus:pointer-events-auto"
        >
          {filteredStudents.map((stu, i) => (
            <div
              key={stu.id}
              onMouseDown={(e) => { e.preventDefault(); handleSelect(stu); }}
              onTouchStart={(e) => { e.preventDefault(); handleSelect(stu); }}
              className={`px-3 py-2 cursor-pointer transition-colors ${
                i === activeIndex ? "bg-blue-100 text-blue-800 font-semibold" : "hover:bg-gray-100"
              }`}
            >
              {stu.firstName} {stu.lastName}
            </div>
          ))}
        </div>
      )}
    </div>
  );
};
const ScheduleInput = ({ schedule, setSchedule }) => {
    const daysOfWeek = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
    const timesOfDay = [
        '8:00 a. m.', '9:00 a. m.', '10:00 a. m.', '11:00 a. m.', '12:00 p. m.',
        '1:00 p. m.', '2:00 p. m.', '3:00 p. m.', '4:00 p. m.', '5:00 p. m.',
        '6:00 p. m.', '7:00 p. m.', '8:00 p. m.', '9:00 p. m.', '10:00 p. m.',
    ];
    const handleDayToggle = (day) => {
        const newSchedule = schedule.some(s => s.day === day)
            ? schedule.filter(s => s.day !== day)
            : [...schedule, { day, time: timesOfDay[0] }];
        setSchedule(newSchedule);
    };

    const handleTimeChange = (day, time) => {
        setSchedule(schedule.map(s => s.day === day ? { ...s, time } : s));
    };

    return (
        <div className="space-y-4">
            <h4 className="text-lg font-semibold text-gray-700">Horario Semanal (Opcional)</h4>
            <div className="flex flex-wrap gap-2 mb-2">
                {daysOfWeek.map(day => (
                    <button
                        key={day}
                        type="button"
                        onClick={() => handleDayToggle(day)}
                        className={`px-4 py-2 rounded-full font-bold transition-colors text-sm
                            ${schedule.some(s => s.day === day) ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                        {day}
                    </button>
                ))}
            </div>
            {schedule.map(item => (
                <div key={item.day} className="flex items-center space-x-2">
                    <span className="font-semibold text-gray-800">{item.day}:</span>
                    <select
                        value={item.time}
                        onChange={(e) => handleTimeChange(item.day, e.target.value)}
                        className="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                        {timesOfDay.map(time => (
                            <option key={time} value={time}>{time}</option>
                        ))}
                    </select>
                </div>
            ))}
        </div>
    );
};

        const firebaseConfig = {
            apiKey: "AIzaSyAvk1yOsxXfc2w4YwZ1R1tQFrQuM2AbEYk",
            authDomain: "app-de-padel.firebaseapp.com",
            projectId: "app-de-padel",
            storageBucket: "app-de-padel.firebasestorage.app",
            messagingSenderId: "731771747398",
            appId: "1:731771747398:web:ebc8b723fe220869fade47"
        };
        const appId = typeof firebaseConfig.appId !== 'undefined' ? firebaseConfig.appId : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const { useState, useEffect, useRef, useMemo } = React;
        const daysOfWeek = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
        const defaultClassPrices = {
            1: 5000,
            2: 3000,
            3: 2500,
            4: 2000,
        };
        const peopleOptions = [1, 2, 3, 4];
        const timesOfDay = [
            '8:00 a. m.', '9:00 a. m.', '10:00 a. m.', '11:00 a. m.', '12:00 p. m.',
            '1:00 p. m.', '2:00 p. m.', '3:00 p. m.', '4:00 p. m.', '5:00 p. m.',
            '6:00 p. m.', '7:00 p. m.', '8:00 p. m.', '9:00 p. m.', '10:00 p. m.',
        ];
        const colorMap = {
            1: 'bg-yellow-100',
            2: 'bg-green-100',
            3: 'bg-blue-100',
            4: 'bg-purple-100',
        };
        const MessageBox = ({ show, title, content, type, onConfirm, onClose }) => {
            if (!show) return null;
            let icon, bgColor, titleColor;
            switch (type) {
                case 'success':
                    icon = <i className="fas fa-check-circle text-4xl text-green-600"></i>;
                    bgColor = 'bg-white';
                    titleColor = 'text-green-600';
                    break;
                case 'error':
                    icon = <i className="fas fa-times-circle text-4xl text-red-500"></i>;
                    bgColor = 'bg-white';
                    titleColor = 'text-red-600';
                    break;
                case 'confirm':
                    icon = <i className="fas fa-question-circle text-4xl text-blue-800"></i>;
                    bgColor = 'bg-white';
                    titleColor = 'text-blue-800';
                    break;
                default:
                    icon = null;
            }

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div className={`p-6 rounded-xl shadow-xl w-full max-w-sm text-center ${bgColor} transform transition-all duration-300 ease-in-out scale-100`}>
                        <div className="mb-4">{icon}</div>
                        <h3 className={`text-lg font-bold mb-2 ${titleColor}`}>{title}</h3>
                        <p className="text-sm text-gray-500 mb-4">{content}</p>
                        <div className="mt-4">
                            {type === 'confirm' && (
                                <button
                                    onClick={onConfirm}
                                    className={`py-2 px-4 rounded-lg font-bold transition-colors text-white bg-blue-800 hover:bg-blue-900 shadow-md mr-2`}
                                >
                                    Aceptar
                                </button>
                            )}
                            <button
                                onClick={onClose}
                                className={`py-2 px-4 rounded-lg font-bold transition-colors text-white ${type === 'confirm' ? 'bg-gray-400 hover:bg-gray-500' : type === 'success' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-500 hover:bg-red-600'} shadow-md`}
                            >
                                {type === 'confirm' ? 'Cancelar' : 'Cerrar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        const App = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [userId, setUserId] = useState(null);
            const [userEmail, setUserEmail] = useState('');
            const [loading, setLoading] = useState(true);
            const [classes, setClasses] = useState([]);
            const [students, setStudents] = useState([]);
            const [payments, setPayments] = useState([]);
            const [activityLog, setActivityLog] = useState([]);
            const [customPrices, setCustomPrices] = useState(defaultClassPrices);
            const [currentPage, setCurrentPage] = useState(1);
            const [classesPerPage, setClassesPerPage] = useState(10);
            const [newEntry, setNewEntry] = useState({
                studentCount: 1,
                studentNames: [''],
                studentIds: [''],
                date: new Date().toISOString().split('T')[0],
                day: daysOfWeek[new Date().getDay()],
                time: timesOfDay[0],
                price: defaultClassPrices[1] || 0,
            });
            const [newStudent, setNewStudent] = useState({
                firstName: '',
                lastName: '',
                phone: '',
                description: '',
                status: 'Activo',
                schedule: [],
            });
            const [replaceData, setReplaceData] = useState({ classId: null, studentIndex: null });
            const [isEditingStudent, setIsEditingStudent] = useState(false);
            const [editedStudentId, setEditedStudentId] = useState(null);
            const [filterStatus, setFilterStatus] = useState('Todos');
            const [studentSearch, setStudentSearch] = useState('');
            const filteredStudentsList = React.useMemo(() => {
                const term = (studentSearch || '').toLowerCase();
                return students.filter(s => {
                    const status = s.status || 'Activo';
                    const matchesStatus = filterStatus === 'Todos' || status === filterStatus;
                    const haystack = `${s.firstName || ''} ${s.lastName || ''} ${s.phone || ''} ${s.description || ''}`.toLowerCase();
                    const matchesSearch = !term || haystack.includes(term);
                    return matchesStatus && matchesSearch;
                });
            }, [students, studentSearch, filterStatus]);
            const [newPayment, setNewPayment] = useState({
                date: new Date().toISOString().split('T')[0],
                amount: 0,
                description: '',
            });
            const [isEditingPayment, setIsEditingPayment] = useState(false);
            const [editedPaymentId, setEditedPaymentId] = useState(null);

            const [monthlyReports, setMonthlyReports] = useState({});
            const [annualPaymentsReport, setAnnualPaymentsReport] = useState({});
            const [selectedMonthYear, setSelectedMonthYear] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [editedClassId, setEditedClassId] = useState(null);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [view, setView] = useState('list');
            const [filterText, setFilterText] = useState('');
            const [isSigningUp, setIsSigningUp] = useState(false);
            const [messageBox, setMessageBox] = useState({
                show: false,
                title: '',
                content: '',
                type: 'confirm',
                onConfirm: null,
            });

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const fileInputRef = useRef(null);
            const reportTableRef = useRef(null);
            const annualPaymentsReportRef = useRef(null);

            const formatPrice = (price) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(price);
            const formatMonthYear = (monthYearString) => {
                const [year, month] = monthYearString.split('-');
                return new Date(year, month - 1).toLocaleString('es-AR', { month: 'long', year: 'numeric' });
            };
            const formatDate = (timestamp) => {
                const date = new Date(timestamp.seconds * 1000);
                return date.toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            };

            const initializeFirebase = async () => {
                try {
                    const app = window.initializeApp(firebaseConfig);
                    dbRef.current = window.getFirestore(app);
                    authRef.current = window.getAuth(app);

                    const unsubscribe = window.onAuthStateChanged(authRef.current, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setUserEmail(user.email);
                        } else {
                            setUserId(null);
                            setUserEmail('');
                        }
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    setMessageBox({
                        show: true,
                        title: 'Error de configuración',
                        content: 'Error al inicializar Firebase. Revisa tu configuración.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    setLoading(false);
                }
            };

            useEffect(() => {
                initializeFirebase();
            }, []);

            const signIn = async () => {
    try {
        setLoading(true);
        const auth = authRef.current;
        await window.setPersistence(auth, window.browserLocalPersistence);
        await window.signInWithEmailAndPassword(auth, email, password);
        // Agregado: Muestra una alerta de éxito con el mensaje
        setMessageBox({
            show: true,
            title: 'Inicio de Sesión Exitoso',
            content: 'La sesión se mantendrá iniciada en este dispositivo.',
            type: 'success',
            onClose: () => setMessageBox({ ...messageBox, show: false })
        });

    } catch (error) {
        setMessageBox({
            show: true,
            title: 'Error de autenticación',
            content: 'Usuario o contraseña incorrectos. Por favor, inténtalo de nuevo.',
            type: 'error',
            onClose: () => setMessageBox({ ...messageBox, show: false })
        });
        console.error("Error signing in:", error);
    } finally {
        setLoading(false);
    }
};

            const signUp = async () => {
                try {
                    setLoading(true);
                    const auth = authRef.current;
                    await window.createUserWithEmailAndPassword(auth, email, password);
                    setMessageBox({
                        show: true,
                        title: 'Cuenta creada',
                        content: 'Tu cuenta se ha creado exitosamente. ¡Ya puedes iniciar sesión!',
                        type: 'success',
                        onClose: () => {
                            setMessageBox({ ...messageBox, show: false });
                            setIsSigningUp(false);
                        }
                    });
                } catch (error) {
                    setMessageBox({
                        show: true,
                        title: 'Error de registro',
                        content: 'Hubo un error al crear la cuenta. Puede que el email ya esté en uso o la contraseña sea demasiado débil.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    console.error("Error signing up:", error);
                } finally {
                    setLoading(false);
                }
            };

            const handlePasswordReset = async () => {
                if (!email) {
                    setMessageBox({
                        show: true,
                        title: 'Error de validación',
                        content: 'Por favor, ingresa tu email para restablecer la contraseña.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    return;
                }
                try {
                    setLoading(true);
                    await window.sendPasswordResetEmail(authRef.current, email);
                    setMessageBox({
                        show: true,
                        title: 'Correo enviado',
                        content: 'Se ha enviado un correo para restablecer tu contraseña. Revisa tu bandeja de entrada.',
                        type: 'success',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                } catch (error) {
                    setMessageBox({
                        show: true,
                        title: 'Error al enviar correo',
                        content: 'Hubo un error al enviar el correo. Asegúrate de que el email sea correcto.',
                        type: 'error',
                        onClose: () => setMessageBox({ ...messageBox, show: false })
                    });
                    console.error("Error sending password reset email:", error);
                } finally {
                    setLoading(false);
                }
            };

            const signOutUser = async () => {
                try {
                    await window.signOut(authRef.current);
                    setUserId(null);
                    setClasses([]);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };

            const saveCustomPrices = async () => {
                if (!dbRef.current || !userId) return;
                try {
                    setLoading(true);
                    const userDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'config', 'prices');
                    await window.setDoc(userDocRef, { prices: customPrices });
                    setMessageBox({ show: true, title: 'Precios guardados', content: 'Los precios de las clases se han guardado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar', content: 'Hubo un error al guardar los precios.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error saving custom prices:", error);
                } finally {
                    setLoading(false);
                }
            };

            const loadCustomPrices = async () => {
                if (!dbRef.current || !userId) return;
                try {
                    const userDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'config', 'prices');
                    const docSnap = await window.getDoc(userDocRef);
                    if (docSnap.exists()) {
                        setCustomPrices(docSnap.data().prices);
                    }
                } catch (error) {
                    console.error("Error loading custom prices:", error);
                }
            };
            const addLogEntry = async (action, details) => {
                if (!dbRef.current || !userId) return;
                try {
                    const logColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'activityLog');
                    await window.addDoc(logColRef, {
                        action,
                        details,
                        timestamp: window.Timestamp.now()
                    });
                } catch (error) {
                    console.error("Error adding log entry:", error);
                }
            };

            const addStudent = async () => {
                if (!dbRef.current || !userId) return;
                if (!newStudent.firstName || !newStudent.lastName || !newStudent.phone) {
                    setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, completa todos los campos del alumno.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    return;
                }
                try {
                    setLoading(true);
                    const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                    if (isEditingStudent) {
                        const studentDocRef = window.doc(studentsColRef, editedStudentId);
                        await window.setDoc(studentDocRef, newStudent);
                        setMessageBox({ show: true, title: 'Alumno actualizado', content: 'El alumno se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    } else {
                        await window.addDoc(studentsColRef, newStudent);
                        setMessageBox({ show: true, title: 'Alumno añadido', content: 'El nuevo alumno se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    }
                    setNewStudent({ firstName: '', lastName: '', phone: '', description: '', status: 'Activo', schedule: [] });
                    setIsEditingStudent(false);
                    setEditedStudentId(null);
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar el alumno', content: 'Hubo un error al guardar los datos del alumno. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error adding/updating student:", error);
                } finally {
                    setLoading(false);
                }
            };
            const editStudent = (studentToEdit) => {
                setNewStudent({ ...studentToEdit, schedule: studentToEdit.schedule || [] });
                setIsEditingStudent(true);
                setEditedStudentId(studentToEdit.id);
            };

            const deleteStudent = (studentId) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar eliminación',
                    content: '¿Estás seguro de que quieres eliminar a este alumno? Esta acción es irreversible.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        try {
                                                     setLoading(true);
                            const studentDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'students', studentId);
                            await window.deleteDoc(studentDocRef);
                            setMessageBox({ show: true, title: 'Alumno eliminado', content: 'El alumno ha sido eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } catch (error) {
                            setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar al alumno. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            console.error("Error deleting student:", error);
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            const sendWhatsApp = (phone) => {
                const formattedPhone = phone.replace(/\D/g, '');
                const url = `https://wa.me/${formattedPhone}`;
                window.open(url, '_blank');
            };

            const addPayment = async () => {
                if (!dbRef.current || !userId) return;
                if (!newPayment.date || !newPayment.amount || newPayment.amount <= 0) {
                    setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, ingresa una fecha y un monto válido para el pago.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    return;
                }
                try {
                    setLoading(true);
                    const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');
                    const paymentData = {
                        ...newPayment,
                        amount: parseFloat(newPayment.amount),
                        date: newPayment.date,
                        timestamp: window.Timestamp.fromDate(new Date(newPayment.date))
                    };
                    if (isEditingPayment) {
                        const paymentDocRef = window.doc(paymentsColRef, editedPaymentId);
                        await window.setDoc(paymentDocRef, paymentData);
                        setMessageBox({ show: true, title: 'Pago actualizado', content: 'El pago se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    } else {
                        await window.addDoc(paymentsColRef, paymentData);
                        setMessageBox({ show: true, title: 'Pago añadido', content: 'El nuevo pago se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    }
                    setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' });
                    setIsEditingPayment(false);
                    setEditedPaymentId(null);
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar el pago', content: 'Hubo un error al guardar los datos del pago. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error adding/updating payment:", error);
                } finally {
                    setLoading(false);
                }
            };
            const editPayment = (paymentToEdit) => {
                setNewPayment({ ...paymentToEdit, amount: paymentToEdit.amount.toString() });
                setIsEditingPayment(true);
                setEditedPaymentId(paymentToEdit.id);
            };
            const deletePayment = (paymentId) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar eliminación',
                    content: '¿Estás seguro de que quieres eliminar este pago? Esta acción es irreversible.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        try {
                                                     setLoading(true);
                            const paymentDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments', paymentId);
                            await window.deleteDoc(paymentDocRef);
                            setMessageBox({ show: true, title: 'Pago eliminado', content: 'El pago ha sido eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        } catch (error) {
                            setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar el pago. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            console.error("Error deleting payment:", error);
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            useEffect(() => {
                if (userId && dbRef.current) {
                    loadCustomPrices();

                    const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                    const classesQuery = window.query(classesColRef);
                                 const unsubscribeClasses = window.onSnapshot(classesQuery, (snapshot) => {
                        const fetchedClasses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const sortedClasses = fetchedClasses.sort((a, b) => new Date(b.date) - new Date(a.date));
                                     setClasses(sortedClasses);
                    });

                    const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                    const studentsQuery = window.query(studentsColRef);
                     const unsubscribeStudents = window.onSnapshot(studentsQuery, (snapshot) => {
                        const fetchedStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStudents(fetchedStudents.sort((a, b) => a.lastName.localeCompare(b.lastName)));
                    });

                    const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');
                    const paymentsQuery = window.query(paymentsColRef);
                    const unsubscribePayments = window.onSnapshot(paymentsQuery, (snapshot) => {
                        const fetchedPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const sortedPayments = fetchedPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                        setPayments(sortedPayments);
                    });

                    const logColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'activityLog');
                    const logQuery = window.query(logColRef);
                    const unsubscribeLog = window.onSnapshot(logQuery, (snapshot) => {
                        const fetchedLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const sortedLog = fetchedLog.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                        setActivityLog(sortedLog);
                    });

                    return () => {
                        unsubscribeClasses();
                        unsubscribeStudents();
                        unsubscribePayments();
                        unsubscribeLog();
                    };
                } else {
                    setClasses([]);
                    setStudents([]);
                    setPayments([]);
                    setActivityLog([]);
                }
            }, [userId]);

            useEffect(() => {
                if (Object.keys(customPrices).length > 0) {
                    setNewEntry(prev => ({ ...prev, price: customPrices[prev.studentCount] || 0 }));
                }
            }, [customPrices]);

            useEffect(() => {
                const report = {};
                classes.forEach(cls => {
                    const date = new Date(`${cls.date}T00:00:00Z`);
                    const monthYear = `${date.getUTCFullYear()}-${(date.getUTCMonth() + 1).toString().padStart(2, '0')}`;
                    if (!report[monthYear]) {
                        report[monthYear] = { totalIncome: 0, classCount: 0, classCountByStudent: {} };
                    }
                    report[monthYear].totalIncome += cls.price;
                    report[monthYear].classCount += 1;
                    const studentCount = cls.studentCount;
                    report[monthYear].classCountByStudent[studentCount] = (report[monthYear].classCountByStudent[studentCount] || 0) + 1;
                });
                setMonthlyReports(report);
            }, [classes]);

            useEffect(() => {
                const report = {};
                payments.forEach(payment => {
                    const year = new Date(payment.date).getUTCFullYear();
                    if (!report[year]) {
                        report[year] = { totalAmount: 0, paymentCount: 0 };
                    }
                    report[year].totalAmount += payment.amount;
                    report[year].paymentCount += 1;
                });
                setAnnualPaymentsReport(report);
            }, [payments]);

            const handleNewEntryChange = (e) => {
                const { name, value } = e.target;
                if (name === 'studentCount') {
                    const count = parseInt(value);
                    const newNames = Array(count).fill('');
                    const newPrice = customPrices[count] || 0;
                    setNewEntry(prev => ({ ...prev, studentCount: count, studentNames: newNames, price: newPrice }));
                } else if (name.startsWith('studentName-')) {
                    const index = parseInt(name.split('-')[1]);
                    const newNames = [...newEntry.studentNames];
                    newNames[index] = value;
                    setNewEntry(prev => ({ ...prev, studentNames: newNames }));
                } else {
                    setNewEntry(prev => ({ ...prev, [name]: value }));
                }
            };
            const handleDateChange = (e) => {
                const dateString = e.target.value;
                const dateObj = new Date(`${dateString}T00:00:00Z`);
                const dayOfWeek = daysOfWeek[dateObj.getUTCDay()];
                setNewEntry(prev => ({ ...prev, date: dateString, day: dayOfWeek }));
            };
            const handleCustomPriceChange = (studentCount, price) => setCustomPrices(prev => ({ ...prev, [studentCount]: parseInt(price) || 0 }));

            const addClass = async () => {
                if (!dbRef.current || !userId) return;
                if (newEntry.studentNames.some(name => name.trim() === '') || newEntry.price <= 0) {
                    setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, completa todos los campos de los alumnos y el precio.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    return;
                }
                try {
                    setLoading(true);
                    const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                    const selectedStudents = newEntry.studentIds.map(id => {
                        const stu = students.find(s => s.id === id);
                        return stu ? `${stu.firstName} ${stu.lastName}` : "";
                    });
                    const classData = {
                        ...newEntry,
                        studentIds: newEntry.studentIds,
                        studentNames: selectedStudents,
                        timestamp: window.Timestamp.fromDate(new Date(newEntry.date)),
                    };
                    if (isEditing) {
                        const classDocRef = window.doc(classesColRef, editedClassId);
                        await window.setDoc(classDocRef, classData);
                        setMessageBox({ show: true, title: 'Clase actualizada', content: 'La clase se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        addLogEntry('Clase editada', `Clase con ${classData.studentNames.join(', ')} editada el día ${classData.date} a las ${classData.time}.`);
                    } else {
                        await window.addDoc(classesColRef, classData);
                        setMessageBox({ show: true, title: 'Clase añadida', content: 'La nueva clase se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        addLogEntry('Clase añadida', `Clase con ${classData.studentNames.join(', ')} añadida para el día ${classData.date} a las ${classData.time}.`);
                    }
                    setNewEntry({
                        studentCount: 1,
                        studentNames: [''],
                        studentIds: [''],
                        date: new Date().toISOString().split('T')[0],
                        day: daysOfWeek[new Date().getDay()],
                        time: timesOfDay[0],
                        price: customPrices[1] || 0,
                    });
                    setIsEditing(false);
                    setEditedClassId(null);
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error al guardar la clase', content: 'Hubo un error al guardar los datos de la clase. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    console.error("Error adding/updating class:", error);
                } finally {
                    setLoading(false);
                }
            };

            const deleteClass = (id, classData) => {
                setMessageBox({
                    show: true,
                    title: 'Confirmar eliminación',
                    content: '¿Estás seguro de que quieres eliminar esta clase? Esta acción es irreversible.',
                    type: 'confirm',
                    onConfirm: async () => {
                        if (!dbRef.current || !userId) return;
                        try {
                            setLoading(true);
                            const classDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'classes', id);
                            await window.deleteDoc(classDocRef);
                            setMessageBox({ show: true, title: 'Clase eliminada', content: 'La clase ha sido eliminada exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            addLogEntry('Clase eliminada', `Clase con ${classData.studentNames.join(', ')} del día ${classData.date} a las ${classData.time} ha sido eliminada.`);
                        } catch (error) {
                            setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar la clase. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            console.error("Error deleting class:", error);
                        } finally {
                            setLoading(false);
                        }
                    },
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            };

            const editClass = (classToEdit) => {
                setNewEntry({
                    studentCount: classToEdit.studentCount,
                    studentNames: classToEdit.studentNames,
                    date: classToEdit.date,
                    day: classToEdit.day,
                    time: classToEdit.time,
                    price: classToEdit.price,
                });
                setIsEditing(true);
                setEditedClassId(classToEdit.id);
                setView('list');
            };

            // ---- NUEVAS FUNCIONES: Reemplazar y quitar alumno en clase ----
            const replaceStudentInClass = async (classId, studentIndex, studentObj) => {
                if (!dbRef.current || !userId) return;
                try {
                    const classDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'classes', classId);
                    const snap = await window.getDoc(classDocRef);
                    if (snap.exists()) {
                        const data = snap.data() || {};
                        data.studentIds = data.studentIds || [];
                        data.studentNames = data.studentNames || [];
                        data.studentIds[studentIndex] = studentObj.id;
                        data.studentNames[studentIndex] = `${studentObj.firstName} ${studentObj.lastName}`;
                        await window.setDoc(classDocRef, data);
                    }
                } catch (e) {
                    console.error('Error reemplazando alumno:', e);
                }
            };
            const removeStudentFromClass = async (classId, studentIndex) => {
                if (!dbRef.current || !userId) return;
                try {
                    const classDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'classes', classId);
                    const snap = await window.getDoc(classDocRef);
                    if (snap.exists()) {
                        const data = snap.data() || {};
                        data.studentIds = (data.studentIds || []).filter((_, i) => i !== studentIndex);
                        data.studentNames = (data.studentNames || []).filter((_, i) => i !== studentIndex);
                        await window.setDoc(classDocRef, data);
                    }
                } catch (e) {
                    console.error('Error quitando alumno:', e);
                }
            };

            const ReplaceModal = () => (
                replaceData.classId !== null && (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
                            <h3 className="text-xl font-bold mb-4">Reemplazar Alumno</h3>
                            <p className="mb-2">Seleccioná un nuevo alumno de la lista:</p>
                            <select
                                className="w-full p-3 border rounded-lg mb-4"
                                onChange={async (e) => {
                                    const newStudentId = e.target.value;
                                    if (!newStudentId) return;
                                    const selectedStudent = students.find(s => s.id === newStudentId);
                                    await replaceStudentInClass(replaceData.classId, replaceData.studentIndex, selectedStudent);
                                    setReplaceData({ classId: null, studentIndex: null });
                                }}
                            >
                                <option value="">-- Seleccionar alumno --</option>
                                {students.map(s => (
                                    <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>
                                ))}
                            </select>
                            <div className="flex justify-end">
                                <button
                                    onClick={() => setReplaceData({ classId: null, studentIndex: null })}
                                    className="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500"
                                >
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                )
            );

            // ---- NUEVAS FUNCIONES PARA REPORTE MENSUAL Y EXPORTAR PDF ----
            const generateReport = async () => {
                setLoading(true);
                const input = reportTableRef.current;
                const canvas = await window.html2canvas(input);
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Reporte_Clases_${selectedMonthYear}.pdf`);
                setLoading(false);
            };

            const generateAnnualPaymentsReport = async () => {
                setLoading(true);
                const input = annualPaymentsReportRef.current;
                const canvas = await window.html2canvas(input);
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Reporte_Pagos_Anual.pdf`);
                setLoading(false);
            };

            // ---- NUEVA FUNCIÓN: Obtener la fecha de mañana y filtrar clases ----
            const getTomorrow = () => {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0); // Normalizar a la medianoche
                return tomorrow;
            };

            const tomorrowDay = daysOfWeek[getTomorrow().getDay()];
            const tomorrowScheduledStudents = useMemo(() => {
                return students.filter(stu =>
                    stu.schedule && stu.schedule.some(s => s.day === tomorrowDay)
                );
            }, [students, tomorrowDay]);

            const tomorrowScheduleGrouped = useMemo(() => {
                const grouped = {};
                tomorrowScheduledStudents.forEach(stu => {
                    stu.schedule.forEach(s => {
                        if (s.day === tomorrowDay) {
                            if (!grouped[s.time]) {
                                grouped[s.time] = [];
                            }
                            grouped[s.time].push({ studentName: `${stu.firstName} ${stu.lastName}`, studentId: stu.id });
                        }
                    });
                });
                return grouped;
            }, [tomorrowScheduledStudents, tomorrowDay]);


            const totalMonthlyIncome = useMemo(() => {
                if (!selectedMonthYear || !monthlyReports[selectedMonthYear]) return 0;
                return monthlyReports[selectedMonthYear].totalIncome;
            }, [selectedMonthYear, monthlyReports]);

            const totalAnnualPayments = useMemo(() => {
                const total = Object.values(annualPaymentsReport).reduce((sum, report) => sum + report.totalAmount, 0);
                return total;
            }, [annualPaymentsReport]);

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.classes && data.students && data.payments) {
                                // Clear current data
                                setClasses([]);
                                setStudents([]);
                                setPayments([]);
                                setLoading(true);

                                // Use a batch to write data efficiently
                                const batch = window.writeBatch(dbRef.current);
                                const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                                const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                                const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');

                                // Add classes from file
                                data.classes.forEach(cls => {
                                    const newClassRef = window.doc(classesColRef);
                                    batch.set(newClassRef, cls);
                                });

                                // Add students from file
                                data.students.forEach(stu => {
                                    const newStudentRef = window.doc(studentsColRef);
                                    batch.set(newStudentRef, stu);
                                });

                                // Add payments from file
                                data.payments.forEach(pay => {
                                    const newPaymentRef = window.doc(paymentsColRef);
                                    batch.set(newPaymentRef, pay);
                                });

                                batch.commit().then(() => {
                                    setMessageBox({ show: true, title: 'Importación exitosa', content: 'Datos importados correctamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                                    setLoading(false);
                                }).catch(error => {
                                    setMessageBox({ show: true, title: 'Error de importación', content: 'Hubo un problema al importar los datos.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                                    console.error("Error writing batch:", error);
                                    setLoading(false);
                                });
                            } else {
                                setMessageBox({ show: true, title: 'Formato de archivo incorrecto', content: 'El archivo JSON no contiene el formato esperado.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                            }
                        } catch (e) {
                            setMessageBox({ show: true, title: 'Archivo inválido', content: 'El archivo seleccionado no es un JSON válido.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        }
                    };
                    reader.readAsText(file);
                }
            };
            const exportData = async () => {
                if (!dbRef.current || !userId) return;
                setLoading(true);
                try {
                    const classesSnapshot = await window.getDocs(window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes'));
                    const studentsSnapshot = await window.getDocs(window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students'));
                    const paymentsSnapshot = await window.getDocs(window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments'));

                    const dataToExport = {
                        classes: classesSnapshot.docs.map(doc => doc.data()),
                        students: studentsSnapshot.docs.map(doc => doc.data()),
                        payments: paymentsSnapshot.docs.map(doc => doc.data()),
                    };

                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "reporte_padel.json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();

                    setMessageBox({ show: true, title: 'Exportación exitosa', content: 'Datos exportados a reporte_padel.json', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } catch (error) {
                    setMessageBox({ show: true, title: 'Error de exportación', content: 'Hubo un error al exportar los datos.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } finally {
                    setLoading(false);
                }
            };

            const LogoutButton = () => (
                <button
                    onClick={signOutUser}
                    className="flex-shrink-0 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors"
                >
                    <i className="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
                </button>
            );

            const Navigation = ({ currentView, setView, userId, students }) => (
                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-6">
                    <button
                        onClick={() => setView('list')}
                        className={`py-2 px-4 rounded-lg font-bold transition-colors ${currentView === 'list' ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Clases
                    </button>
                    <button
                        onClick={() => setView('students')}
                        className={`py-2 px-4 rounded-lg font-bold transition-colors ${currentView === 'students' ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Alumnos ({students.length})
                    </button>
                    <button
                        onClick={() => setView('reports')}
                        className={`py-2 px-4 rounded-lg font-bold transition-colors ${currentView === 'reports' ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Reportes
                    </button>
                    <button
                        onClick={() => setView('log')}
                        className={`py-2 px-4 rounded-lg font-bold transition-colors ${currentView === 'log' ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Registro de Actividad
                    </button>
                    <button
                        onClick={() => setView('club-payments')}
                        className={`py-2 px-4 rounded-lg font-bold transition-colors ${currentView === 'club-payments' ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Pagos del Club
                    </button>
                    <button
                        onClick={() => setShowConfigModal(true)}
                        className="py-2 px-4 rounded-lg font-bold bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors"
                    >
                        <i className="fas fa-cogs mr-2"></i> Configurar
                    </button>
                    <LogoutButton />
                </div>
            );

            const ClassList = ({ filteredClasses, classesPerPage, currentPage, setCurrentPage, totalPages }) => {
                const indexOfLastClass = currentPage * classesPerPage;
                const indexOfFirstClass = indexOfLastClass - classesPerPage;
                const currentClasses = filteredClasses.slice(indexOfFirstClass, indexOfLastClass);

                const paginate = (pageNumber) => setCurrentPage(pageNumber);

                return (
                    <div>
                        <div className="overflow-x-auto bg-white rounded-xl shadow-md p-4">
                            <table className="min-w-full table-auto">
                                <thead className="text-left text-gray-600">
                                    <tr className="border-b">
                                        <th className="py-2 px-4">Fecha</th>
                                        <th className="py-2 px-4">Día</th>
                                        <th className="py-2 px-4">Hora</th>
                                        <th className="py-2 px-4">Alumnos</th>
                                        <th className="py-2 px-4">Cantidad</th>
                                        <th className="py-2 px-4 text-right">Precio</th>
                                        <th className="py-2 px-4">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {currentClasses.map((cls) => (
                                        <tr key={cls.id} className="border-b hover:bg-gray-50 transition-colors">
                                            <td className="py-2 px-4 text-gray-700">{cls.date}</td>
                                            <td className="py-2 px-4 text-gray-700">{cls.day}</td>
                                            <td className="py-2 px-4 text-gray-700">{cls.time}</td>
                                            <td className="py-2 px-4 text-gray-700">
                                                {cls.studentNames.length > 0 ? (
                                                    <ul className="list-disc pl-5">
                                                        {cls.studentNames.map((name, index) => (
                                                            <li key={index}>{name}</li>
                                                        ))}
                                                    </ul>
                                                ) : 'N/A'}
                                            </td>
                                            <td className="py-2 px-4 text-gray-700">{cls.studentCount}</td>
                                            <td className="py-2 px-4 text-gray-700 text-right">{formatPrice(cls.price)}</td>
                                            <td className="py-2 px-4 text-gray-700 whitespace-nowrap">
                                                <button onClick={() => editClass(cls)} className="text-blue-600 hover:text-blue-800 mr-2"><i className="fas fa-edit"></i></button>
                                                <button onClick={() => deleteClass(cls.id, cls)} className="text-red-500 hover:text-red-700"><i className="fas fa-trash-alt"></i></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {totalPages > 1 && (
                            <div className="flex justify-center mt-4 space-x-2">
                                {[...Array(totalPages).keys()].map(number => (
                                    <button
                                        key={number + 1}
                                        onClick={() => paginate(number + 1)}
                                        className={`px-4 py-2 rounded-lg font-bold transition-colors ${currentPage === number + 1 ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                                    >
                                        {number + 1}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const StudentList = () => (
                <div className="bg-white rounded-xl shadow-md p-6">
                    <h2 className="text-2xl font-bold mb-4">Lista de Alumnos</h2>
                    <div className="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                        <input
                            type="text"
                            placeholder="Buscar alumno..."
                            value={studentSearch}
                            onChange={(e) => setStudentSearch(e.target.value)}
                            className="p-3 border rounded-lg flex-grow focus:ring-2 focus:ring-blue-500"
                        />
                        <select
                            value={filterStatus}
                            onChange={(e) => setFilterStatus(e.target.value)}
                            className="p-3 border rounded-lg"
                        >
                            <option value="Todos">Todos</option>
                            <option value="Activo">Activos</option>
                            <option value="Inactivo">Inactivos</option>
                        </select>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full table-auto">
                            <thead>
                                <tr className="text-left text-gray-600 border-b">
                                    <th className="py-2 px-4">Nombre Completo</th>
                                    <th className="py-2 px-4">Teléfono</th>
                                    <th className="py-2 px-4">Estado</th>
                                    <th className="py-2 px-4">Descripción</th>
                                    <th className="py-2 px-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredStudentsList.map(student => (
                                    <tr key={student.id} className="border-b hover:bg-gray-50 transition-colors">
                                        <td className="py-2 px-4 text-gray-700">{student.firstName} {student.lastName}</td>
                                        <td className="py-2 px-4 text-gray-700">{student.phone}</td>
                                        <td className="py-2 px-4 text-gray-700">{student.status}</td>
                                        <td className="py-2 px-4 text-gray-700">{student.description}</td>
                                        <td className="py-2 px-4 whitespace-nowrap">
                                            <button onClick={() => editStudent(student)} className="text-blue-600 hover:text-blue-800 mr-2"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => deleteStudent(student.id)} className="text-red-500 hover:text-red-700 mr-2"><i className="fas fa-trash-alt"></i></button>
                                            <button onClick={() => sendWhatsApp(student.phone)} className="text-green-500 hover:text-green-700"><i className="fab fa-whatsapp"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const StudentForm = () => (
                <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h2 className="text-2xl font-bold mb-4">{isEditingStudent ? 'Editar Alumno' : 'Añadir Nuevo Alumno'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); addStudent(); }} className="space-y-4">
                        <div className="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                            <input
                                type="text"
                                placeholder="Nombre"
                                value={newStudent.firstName}
                                onChange={(e) => setNewStudent({ ...newStudent, firstName: e.target.value })}
                                className="p-3 border rounded-lg flex-1 focus:ring-2 focus:ring-blue-500"
                            />
                            <input
                                type="text"
                                placeholder="Apellido"
                                value={newStudent.lastName}
                                onChange={(e) => setNewStudent({ ...newStudent, lastName: e.target.value })}
                                className="p-3 border rounded-lg flex-1 focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                        <div className="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                            <input
                                type="tel"
                                placeholder="Teléfono"
                                value={newStudent.phone}
                                onChange={(e) => setNewStudent({ ...newStudent, phone: e.target.value })}
                                className="p-3 border rounded-lg flex-1 focus:ring-2 focus:ring-blue-500"
                            />
                            <select
                                value={newStudent.status}
                                onChange={(e) => setNewStudent({ ...newStudent, status: e.target.value })}
                                className="p-3 border rounded-lg flex-1 focus:ring-2 focus:ring-blue-500"
                            >
                                <option>Activo</option>
                                <option>Inactivo</option>
                            </select>
                        </div>
                        <textarea
                            placeholder="Descripción (opcional)"
                            value={newStudent.description}
                            onChange={(e) => setNewStudent({ ...newStudent, description: e.target.value })}
                            className="p-3 border rounded-lg w-full focus:ring-2 focus:ring-blue-500"
                        ></textarea>
                        <ScheduleInput
                            schedule={newStudent.schedule}
                            setSchedule={(newSchedule) => setNewStudent({ ...newStudent, schedule: newSchedule })}
                        />
                        <div className="flex justify-end space-x-2">
                            {isEditingStudent && (
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsEditingStudent(false);
                                        setEditedStudentId(null);
                                        setNewStudent({ firstName: '', lastName: '', phone: '', description: '', status: 'Activo', schedule: [] });
                                    }}
                                    className="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors"
                                >
                                    Cancelar
                                </button>
                            )}
                            <button
                                type="submit"
                                className="px-6 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors"
                                disabled={loading}
                            >
                                {isEditingStudent ? 'Guardar Cambios' : 'Añadir Alumno'}
                            </button>
                        </div>
                    </form>
                </div>
            );

            const ClassForm = () => (
                <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h2 className="text-2xl font-bold mb-4">{isEditing ? 'Editar Clase' : 'Añadir Nueva Clase'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); addClass(); }} className="space-y-4">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input
                                type="date"
                                name="date"
                                value={newEntry.date}
                                onChange={handleDateChange}
                                className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                            <select
                                name="time"
                                value={newEntry.time}
                                onChange={handleNewEntryChange}
                                className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                {timesOfDay.map((time) => (
                                    <option key={time} value={time}>{time}</option>
                                ))}
                            </select>
                            <select
                                name="studentCount"
                                value={newEntry.studentCount}
                                onChange={handleNewEntryChange}
                                className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                {peopleOptions.map((count) => (
                                    <option key={count} value={count}>{count} alumno{count > 1 ? 's' : ''}</option>
                                ))}
                            </select>
                            <div className="relative">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                                <input
                                    type="number"
                                    name="price"
                                    value={newEntry.price}
                                    onChange={handleNewEntryChange}
                                    placeholder="Precio"
                                    className="p-3 pl-8 w-full border rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {Array.from({ length: newEntry.studentCount }).map((_, index) => (
                                <AutocompleteStudentInput
                                    key={index}
                                    index={index}
                                    newEntry={newEntry}
                                    setNewEntry={setNewEntry}
                                    students={students}
                                />
                            ))}
                        </div>
                        <div className="flex justify-end space-x-2">
                            {isEditing && (
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsEditing(false);
                                        setEditedClassId(null);
                                        setNewEntry({
                                            studentCount: 1,
                                            studentNames: [''],
                                            studentIds: [''],
                                            date: new Date().toISOString().split('T')[0],
                                            day: daysOfWeek[new Date().getDay()],
                                            time: timesOfDay[0],
                                            price: customPrices[1] || 0,
                                        });
                                    }}
                                    className="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors"
                                >
                                    Cancelar
                                </button>
                            )}
                            <button
                                type="submit"
                                className="px-6 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors"
                                disabled={loading}
                            >
                                {isEditing ? 'Guardar Cambios' : 'Añadir Clase'}
                            </button>
                        </div>
                    </form>
                </div>
            );

            const MonthlyReport = () => (
                <div className="bg-white rounded-xl shadow-md p-6">
                    <h2 className="text-2xl font-bold mb-4">Reporte Mensual</h2>
                    <div className="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                        <select
                            value={selectedMonthYear}
                            onChange={(e) => setSelectedMonthYear(e.target.value)}
                            className="p-3 border rounded-lg flex-grow focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Selecciona un mes</option>
                            {Object.keys(monthlyReports).sort().reverse().map(monthYear => (
                                <option key={monthYear} value={monthYear}>
                                    {formatMonthYear(monthYear)}
                                </option>
                            ))}
                        </select>
                        <button
                            onClick={generateReport}
                            disabled={!selectedMonthYear || loading}
                            className="px-6 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors disabled:opacity-50"
                        >
                            Exportar a PDF
                        </button>
                    </div>

                    {selectedMonthYear && monthlyReports[selectedMonthYear] ? (
                        <div ref={reportTableRef} className="p-4 bg-white">
                            <h3 className="text-xl font-bold text-center mb-4">Informe de Clases - {formatMonthYear(selectedMonthYear)}</h3>
                            <div className="text-center mb-4">
                                <p className="text-sm font-bold">Total de Clases: <span className="font-normal">{monthlyReports[selectedMonthYear].classCount}</span></p>
                                <p className="text-sm font-bold">Ingresos Totales: <span className="font-normal">{formatPrice(totalMonthlyIncome)}</span></p>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="min-w-full table-auto border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100 text-gray-700">
                                            <th className="py-2 px-4 border border-gray-300">Tipo de Clase</th>
                                            <th className="py-2 px-4 border border-gray-300">Cantidad</th>
                                            <th className="py-2 px-4 border border-gray-300 text-right">Precio por Clase</th>
                                            <th className="py-2 px-4 border border-gray-300 text-right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.keys(monthlyReports[selectedMonthYear].classCountByStudent).sort().map(studentCount => {
                                            const count = monthlyReports[selectedMonthYear].classCountByStudent[studentCount];
                                            const price = customPrices[studentCount];
                                            return (
                                                <tr key={studentCount}>
                                                    <td className="py-2 px-4 border border-gray-300">{studentCount} {studentCount > 1 ? 'alumnos' : 'alumno'}</td>
                                                    <td className="py-2 px-4 border border-gray-300">{count}</td>
                                                    <td className="py-2 px-4 border border-gray-300 text-right">{formatPrice(price)}</td>
                                                    <td className="py-2 px-4 border border-gray-300 text-right">{formatPrice(count * price)}</td>
                                                </tr>
                                            );
                                        })}
                                        <tr className="font-bold">
                                            <td colSpan="3" className="py-2 px-4 border border-gray-300 text-right">TOTAL</td>
                                            <td className="py-2 px-4 border border-gray-300 text-right">{formatPrice(totalMonthlyIncome)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ) : (
                        <p className="text-center text-gray-500 p-8">Selecciona un mes para ver el reporte.</p>
                    )}
                </div>
            );

            const AnnualPaymentsReport = () => (
                <div className="bg-white rounded-xl shadow-md p-6">
                    <h2 className="text-2xl font-bold mb-4">Reporte Anual de Pagos</h2>
                    <div className="flex justify-end mb-4">
                        <button
                            onClick={generateAnnualPaymentsReport}
                            disabled={Object.keys(annualPaymentsReport).length === 0 || loading}
                            className="px-6 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors disabled:opacity-50"
                        >
                            Exportar a PDF
                        </button>
                    </div>

                    {Object.keys(annualPaymentsReport).length > 0 ? (
                        <div ref={annualPaymentsReportRef} className="p-4 bg-white">
                            <h3 className="text-xl font-bold text-center mb-4">Informe Anual de Pagos</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full table-auto border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100 text-gray-700">
                                            <th className="py-2 px-4 border border-gray-300">Año</th>
                                            <th className="py-2 px-4 border border-gray-300 text-right">Cantidad de Pagos</th>
                                            <th className="py-2 px-4 border border-gray-300 text-right">Total Pagado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.keys(annualPaymentsReport).sort().reverse().map(year => (
                                            <tr key={year}>
                                                <td className="py-2 px-4 border border-gray-300">{year}</td>
                                                <td className="py-2 px-4 border border-gray-300 text-right">{annualPaymentsReport[year].paymentCount}</td>
                                                <td className="py-2 px-4 border border-gray-300 text-right">{formatPrice(annualPaymentsReport[year].totalAmount)}</td>
                                            </tr>
                                        ))}
                                        <tr className="font-bold">
                                            <td colSpan="2" className="py-2 px-4 border border-gray-300 text-right">TOTAL GENERAL</td>
                                            <td className="py-2 px-4 border border-gray-300 text-right">{formatPrice(totalAnnualPayments)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ) : (
                        <p className="text-center text-gray-500 p-8">No hay datos de pagos para mostrar.</p>
                    )}
                </div>
            );

            const PaymentsForm = () => (
                <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h2 className="text-2xl font-bold mb-4">{isEditingPayment ? 'Editar Pago' : 'Añadir Nuevo Pago'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); addPayment(); }} className="space-y-4">
                        <input
                            type="date"
                            name="date"
                            value={newPayment.date}
                            onChange={(e) => setNewPayment({ ...newPayment, date: e.target.value })}
                            className="p-3 border rounded-lg w-full focus:ring-2 focus:ring-blue-500"
                        />
                        <div className="relative">
                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                            <input
                                type="number"
                                name="amount"
                                value={newPayment.amount}
                                onChange={(e) => setNewPayment({ ...newPayment, amount: e.target.value })}
                                placeholder="Monto"
                                className="p-3 pl-8 w-full border rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                        <textarea
                            placeholder="Descripción (opcional)"
                            value={newPayment.description}
                            onChange={(e) => setNewPayment({ ...newPayment, description: e.target.value })}
                            className="p-3 border rounded-lg w-full focus:ring-2 focus:ring-blue-500"
                        ></textarea>
                        <div className="flex justify-end space-x-2">
                            {isEditingPayment && (
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsEditingPayment(false);
                                        setEditedPaymentId(null);
                                        setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' });
                                    }}
                                    className="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors"
                                >
                                    Cancelar
                                </button>
                            )}
                            <button
                                type="submit"
                                className="px-6 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors"
                                disabled={loading}
                            >
                                {isEditingPayment ? 'Guardar Cambios' : 'Añadir Pago'}
                            </button>
                        </div>
                    </form>
                </div>
            );

            const PaymentsList = () => (
                <div className="bg-white rounded-xl shadow-md p-6">
                    <h2 className="text-2xl font-bold mb-4">Pagos Registrados</h2>
                    <div className="overflow-x-auto">
                        <table className="min-w-full table-auto">
                            <thead>
                                <tr className="text-left text-gray-600 border-b">
                                    <th className="py-2 px-4">Fecha</th>
                                    <th className="py-2 px-4 text-right">Monto</th>
                                    <th className="py-2 px-4">Descripción</th>
                                    <th className="py-2 px-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {payments.map(payment => (
                                    <tr key={payment.id} className="border-b hover:bg-gray-50 transition-colors">
                                        <td className="py-2 px-4 text-gray-700">{payment.date}</td>
                                        <td className="py-2 px-4 text-gray-700 text-right">{formatPrice(payment.amount)}</td>
                                        <td className="py-2 px-4 text-gray-700">{payment.description}</td>
                                        <td className="py-2 px-4 whitespace-nowrap">
                                            <button onClick={() => editPayment(payment)} className="text-blue-600 hover:text-blue-800 mr-2"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => deletePayment(payment.id)} className="text-red-500 hover:text-red-700"><i className="fas fa-trash-alt"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const ConfigModal = () => (
                showConfigModal && (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-2xl font-bold">Configuración</h3>
                                <button onClick={() => setShowConfigModal(false)} className="text-gray-500 hover:text-gray-700">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            <div className="space-y-6">
                                <div>
                                    <h4 className="text-xl font-semibold mb-2">Precios de Clases</h4>
                                    <p className="text-sm text-gray-500 mb-4">Define el precio predeterminado para las clases según la cantidad de alumnos.</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        {Object.keys(defaultClassPrices).map(count => (
                                            <div key={count} className="flex items-center space-x-2">
                                                <span className="text-gray-700">{count} alumno{count > 1 ? 's' : ''}:</span>
                                                <div className="relative flex-grow">
                                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                                                    <input
                                                        type="number"
                                                        value={customPrices[count]}
                                                        onChange={(e) => handleCustomPriceChange(count, e.target.value)}
                                                        className="p-3 pl-8 w-full border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-end mt-4">
                                        <button onClick={saveCustomPrices} className="px-6 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors">
                                            Guardar Precios
                                        </button>
                                    </div>
                                </div>
                                <hr />
                                <div>
                                    <h4 className="text-xl font-semibold mb-2">Copia de Seguridad</h4>
                                    <p className="text-sm text-gray-500 mb-2">Exporta tus datos a un archivo JSON.</p>
                                    <button onClick={exportData} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i className="fas fa-download mr-2"></i> Exportar Datos
                                    </button>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-500 mb-2">Importa datos desde un archivo JSON.</p>
                                    <div className="flex items-center space-x-2">
                                        <input
                                            type="file"
                                            ref={fileInputRef}
                                            onChange={handleFileChange}
                                            accept=".json"
                                            className="hidden"
                                        />
                                        <button
                                            type="button"
                                            onClick={() => fileInputRef.current.click()}
                                            className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            <i className="fas fa-upload mr-2"></i> Importar Datos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            );

            const LoginView = () => (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-6 text-blue-800">
                            {isSigningUp ? 'Registrarse' : 'Iniciar Sesión'}
                        </h1>
                        <form onSubmit={(e) => { e.preventDefault(); isSigningUp ? signUp() : signIn(); }}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">
                                    Email
                                </label>
                                <input
                                    id="email"
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="email@ejemplo.com"
                                    required
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                                    Contraseña
                                </label>
                                <input
                                    id="password"
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="********"
                                    required
                                />
                            </div>
                            <div className="flex flex-col space-y-3">
                                <button
                                    type="submit"
                                    className="bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors disabled:opacity-50"
                                    disabled={loading}
                                >
                                    {isSigningUp ? 'Crear Cuenta' : 'Iniciar Sesión'}
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setIsSigningUp(!isSigningUp)}
                                    className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors"
                                >
                                    {isSigningUp ? 'Ya tengo una cuenta' : 'Crear una cuenta'}
                                </button>
                                <button
                                    type="button"
                                    onClick={handlePasswordReset}
                                    className="text-sm text-blue-600 hover:text-blue-800 transition-colors mt-2"
                                >
                                    Olvidé mi contraseña
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );

            const ClassReport = () => {
                const filteredClasses = classes.filter(cls => {
                    if (!filterText) return true;
                    return cls.studentNames.some(name => name.toLowerCase().includes(filterText.toLowerCase())) ||
                           cls.time.toLowerCase().includes(filterText.toLowerCase()) ||
                           cls.date.toLowerCase().includes(filterText.toLowerCase());
                });

                const totalPages = Math.ceil(filteredClasses.length / classesPerPage);
                const currentReportClasses = filteredClasses.slice((currentPage - 1) * classesPerPage, currentPage * classesPerPage);
                
                // Ordenar las clases por hora para una mejor visualización
                const sortedGroupedTimes = Object.keys(tomorrowScheduleGrouped).sort((a, b) => {
                    const timeA = new Date(`2000/01/01 ${a.replace(' a. m.', ' AM').replace(' p. m.', ' PM')}`);
                    const timeB = new Date(`2000/01/01 ${b.replace(' a. m.', ' AM').replace(' p. m.', ' PM')}`);
                    return timeA - timeB;
                });
                
                return (
                    <>
                        <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                            <div className="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                                <h2 className="text-2xl font-bold flex-grow">Clases Registradas ({classes.length})</h2>
                                <input
                                    type="text"
                                    placeholder="Filtrar por nombre o fecha..."
                                    value={filterText}
                                    onChange={(e) => {
                                        setFilterText(e.target.value);
                                        setCurrentPage(1);
                                    }}
                                    className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                                <select
                                    value={classesPerPage}
                                    onChange={(e) => {
                                        setClassesPerPage(parseInt(e.target.value));
                                        setCurrentPage(1);
                                    }}
                                    className="p-3 border rounded-lg"
                                >
                                    <option value="10">10 por página</option>
                                    <option value="25">25 por página</option>
                                    <option value="50">50 por página</option>
                                </select>
                            </div>
                            <ClassForm />
                            {filteredClasses.length > 0 ? (
                                <ClassList
                                    filteredClasses={filteredClasses}
                                    classesPerPage={classesPerPage}
                                    currentPage={currentPage}
                                    setCurrentPage={setCurrentPage}
                                    totalPages={totalPages}
                                />
                            ) : (
                                <p className="text-center text-gray-500 p-8">No hay clases registradas. Añade una para empezar.</p>
                            )}
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <h3 className="text-xl font-bold mb-4">Próxima Clase (Mañana)</h3>
                            {Object.keys(tomorrowScheduleGrouped).length > 0 ? (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {sortedGroupedTimes.map(time => (
                                        <div key={time} className={`p-4 rounded-lg shadow-sm bg-gray-100`}>
                                            <p className="font-bold">{tomorrowDay}, {time}</p>
                                            <p className="text-sm font-semibold">Alumnos:</p>
                                            <ul className="list-disc list-inside text-sm">
                                                {tomorrowScheduleGrouped[time].map(student => (
                                                    <li key={student.studentId}>{student.studentName}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-center text-gray-500">No hay clases programadas para mañana.</p>
                            )}
                        </div>
                    </>
                );
            };

            const ReportsView = () => (
                <>
                    <MonthlyReport />
                    <div className="mt-8">
                        <AnnualPaymentsReport />
                    </div>
                </>
            );

            const PaymentsView = () => (
                <>
                    <PaymentsForm />
                    <PaymentsList />
                </>
            );

            const LogView = () => (
                <div className="bg-white rounded-xl shadow-md p-6">
                    <h2 className="text-2xl font-bold mb-4">Registro de Actividad</h2>
                    {activityLog.length > 0 ? (
                        <div className="overflow-y-auto max-h-96">
                            <ul className="space-y-4">
                                {activityLog.map(log => (
                                    <li key={log.id} className="border-b pb-4 last:border-b-0 last:pb-0">
                                        <p className="text-gray-800">{log.action}: {log.details}</p>
                                        <span className="text-gray-500 text-xs">{formatDate(log.timestamp)}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    ) : (
                        <p className="text-center text-gray-500 p-8 bg-white">No hay actividad reciente.</p>
                    )}
                </div>
            );


            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <i className="fas fa-spinner fa-spin text-4xl text-blue-800"></i>
                    </div>
                );
            }

            if (!userId) {
                return (
                    <>
                        <LoginView />
                        <MessageBox
                            show={messageBox.show}
                            title={messageBox.title}
                            content={messageBox.content}
                            type={messageBox.type}
                            onConfirm={messageBox.onConfirm}
                            onClose={messageBox.onClose}
                        />
                    </>
                );
            }

            return (
                <div className="container mx-auto p-4 sm:p-8">
                    <MessageBox
                        show={messageBox.show}
                        title={messageBox.title}
                        content={messageBox.content}
                        type={messageBox.type}
                        onConfirm={messageBox.onConfirm}
                        onClose={messageBox.onClose}
                    />
                    <ConfigModal />
                    <ReplaceModal />
                    <div className="flex flex-col sm:flex-row items-center justify-between mb-8 space-y-4 sm:space-y-0">
                        <h1 className="text-4xl font-extrabold text-blue-800">
                            Gestión de Clases
                        </h1>
                    </div>
                    <Navigation currentView={view} setView={setView} userId={userId} students={students} />
                    <div className="mt-6">
                        {view === 'list' && <ClassReport />}
                        {view === 'students' && (
                            <>
                                <StudentForm />
                                <StudentList />
                            </>
                        )}
                        {view === 'reports' && <ReportsView />}
                        {view === 'club-payments' && <PaymentsView />}
                        {view === 'log' && <LogView />}
                    </div>
                    {userId && (
                        <div className="mt-8 text-center text-gray-500">
                            ID de Usuario: <span className="font-mono">{userId}</span>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
