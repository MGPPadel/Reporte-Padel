<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Informe de Clases de Padel</title>
  
  <!-- Librerías necesarias -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
  
  <!-- Importaciones de Firebase corregidas para que el objeto global "firebase" esté disponible -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

</head>
<body class="bg-gray-100 font-sans">

  <div id="root"></div>

  <script type="text/babel">
    // Ahora 'firebase' está disponible globalmente, por lo que podemos acceder a sus servicios
    const { useState, useEffect } = React;
    
    // Asegúrate de que estas variables globales están disponibles en el entorno
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Se agrega una verificación para la configuración de Firebase antes de inicializar la app
    let app, db, auth;
    if (firebaseConfig && firebaseConfig.projectId) {
      // Inicializa Firebase con la sintaxis correcta para la versión "compat"
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
    } else {
      console.error('Firebase Error: "projectId" no fue proporcionado en la configuración.');
    }
    
    // Componente principal de la aplicación
    const App = () => {
      const [classes, setClasses] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [editingClass, setEditingClass] = useState(null);
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [userId, setUserId] = useState(null);
      const [isLoading, setIsLoading] = useState(true);

      // Estados para la nueva autenticación
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isRegistering, setIsRegistering] = useState(false);
      const [authError, setAuthError] = useState('');

      // -------------------------------------------------------------
      // FUNCIÓN DE AUTENTICACIÓN
      // -------------------------------------------------------------
      useEffect(() => {
        if (!auth) {
          setIsLoading(false);
          return;
        }

        // Escucha los cambios en el estado de autenticación
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          if (user) {
            setUserId(user.uid);
            setIsAuthReady(true);
          } else {
            // Si no hay token personalizado, la app se queda en el formulario de login.
            if (initialAuthToken) {
              try {
                await auth.signInWithCustomToken(initialAuthToken);
                setUserId(auth.currentUser.uid);
              } catch (error) {
                console.error('Error al iniciar sesión con token personalizado:', error);
                // Si falla, el usuario no está autenticado, se muestra el formulario de login.
              }
            }
            setUserId(null);
            setIsAuthReady(true);
          }
          setIsLoading(false);
        });

        return () => unsubscribe();
      }, []);

      // -------------------------------------------------------------
      // LÓGICA DE LA APLICACIÓN (Mismo que tu código original)
      // -------------------------------------------------------------
      const classesPath = userId ? `artifacts/${appId}/users/${userId}/classes` : null;

      useEffect(() => {
        if (!isAuthReady || !userId || !db) return;

        const q = db.collection(classesPath);
        const unsubscribe = q.onSnapshot((querySnapshot) => {
          const allClasses = [];
          querySnapshot.forEach((doc) => {
            allClasses.push({ id: doc.id, ...doc.data() });
          });

          // Lógica para agrupar clases (igual que tu código)
          const grouped = allClasses.reduce((acc, currentClass) => {
            const key = `${currentClass.date}-${currentClass.time}`;
            if (!acc[key]) {
              acc[key] = {
                ids: [],
                date: currentClass.date,
                time: currentClass.time,
                students: []
              };
            }
            acc[key].ids.push(currentClass.id);
            acc[key].students.push(currentClass.studentName);
            return acc;
          }, {});
          setClasses(Object.values(grouped));
        });

        return () => unsubscribe();
      }, [isAuthReady, userId, classesPath]);

      // Otras funciones (agregar, editar, eliminar) son las mismas.
      const handleDeleteGroupedClass = async (classIds) => {
        if (!userId || !db) return;
        const batch = db.batch();
        classIds.forEach(id => {
          batch.delete(db.collection(classesPath).doc(id));
        });
        try {
          await batch.commit();
          console.log('Clases eliminadas con éxito');
        } catch (e) {
          console.error('Error al eliminar las clases:', e);
        }
      };

      const handleEditClass = (cls) => {
        setEditingClass({
          date: cls.date,
          time: cls.time,
          students: cls.students.join(', '),
          ids: cls.ids
        });
        setShowForm(true);
      };

      const handleSaveEdit = async () => {
        if (!userId || !editingClass || !db) return;
        const { ids, date, time, students } = editingClass;
        const newStudents = students.split(',').map(s => s.trim()).filter(s => s);

        const batch = db.batch();
        ids.forEach(id => {
          const docRef = db.collection(classesPath).doc(id);
          batch.delete(docRef);
        });
        await batch.commit();

        const newBatch = db.batch();
        newStudents.forEach(studentName => {
          const newDocRef = db.collection(classesPath).doc();
          newBatch.set(newDocRef, { studentName, date, time });
        });
        try {
          await newBatch.commit();
          console.log('Clase editada y guardada con éxito.');
        } catch (e) {
          console.error('Error al editar la clase:', e);
        }

        setEditingClass(null);
        setShowForm(false);
      };

      // -------------------------------------------------------------
      // NUEVAS FUNCIONES DE AUTENTICACIÓN
      // -------------------------------------------------------------
      const handleAuthAction = async () => {
        if (!auth) return;
        setAuthError('');
        try {
          if (isRegistering) {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
        } catch (error) {
          setAuthError(error.message);
        }
      };

      const handleLogout = async () => {
        if (!auth) return;
        try {
          await auth.signOut();
          console.log('Sesión cerrada con éxito');
        } catch (error) {
          console.error('Error al cerrar sesión:', error);
        }
      };
      
      // -------------------------------------------------------------
      // RENDERIZADO CONDICIONAL
      // -------------------------------------------------------------
      if (isLoading) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gray-100">
            <p className="text-gray-500">Cargando...</p>
          </div>
        );
      }

      // Si no hay un usuario logueado, muestra el formulario de autenticación
      if (!userId) {
        // Si no hay configuración de Firebase, mostrar un mensaje de error
        if (!firebaseConfig || !firebaseConfig.projectId) {
          return (
            <div className="min-h-screen bg-red-100 flex items-center justify-center p-4">
              <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
                <h1 className="text-2xl font-bold mb-4 text-red-800">Error de Configuración</h1>
                <p className="text-red-700">No se pudo inicializar Firebase. El `projectId` no fue proporcionado. Por favor, asegúrate de que la configuración sea correcta.</p>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
              <h1 className="text-2xl font-bold mb-6 text-center text-gray-800">
                {isRegistering ? 'Crear Cuenta' : 'Iniciar Sesión'}
              </h1>
              {authError && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">{authError}</div>}
              <div className="space-y-4">
                <input
                  type="email"
                  placeholder="Correo electrónico"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <input
                  type="password"
                  placeholder="Contraseña"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div className="mt-6">
                <button
                  onClick={handleAuthAction}
                  className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                  {isRegistering ? 'Registrarse' : 'Iniciar Sesión'}
                </button>
              </div>
              <p className="mt-4 text-center text-gray-600">
                {isRegistering ? '¿Ya tienes una cuenta?' : '¿No tienes una cuenta?'}
                <button onClick={() => setIsRegistering(!isRegistering)} className="text-blue-600 hover:text-blue-800 ml-1">
                  {isRegistering ? 'Iniciar sesión' : 'Regístrate'}
                </button>
              </p>
            </div>
          </div>
        );
      }

      // Si el usuario está logueado, se muestra la aplicación normal
      return (
        <div className="min-h-screen bg-gray-100 p-4">
          <div className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div className="bg-white shadow-xl rounded-2xl p-6 md:p-8">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-extrabold text-gray-900">
                  Informe de Clases de Padel
                </h1>
                <div className="flex items-center space-x-4">
                  <span className="text-sm text-gray-600">
                    <i className="fas fa-user-circle mr-2"></i>
                    <span className="font-bold">Usuario ID:</span> {userId}
                  </span>
                  <button
                    onClick={handleLogout}
                    className="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors duration-200"
                  >
                    Cerrar Sesión
                  </button>
                </div>
              </div>
              <p className="mb-6 text-gray-600">
                Aquí puedes ver y gestionar las clases de padel registradas.
              </p>

              <div className="space-y-8">
                {/* Lógica del formulario de agregar/editar clase, es la misma que tu código original */}
                {showForm ? (
                  <div className="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">
                      {editingClass ? 'Editar Clase' : 'Registrar Nueva Clase'}
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Fecha</label>
                        <input
                          type="date"
                          value={editingClass?.date || ''}
                          onChange={(e) => setEditingClass({ ...editingClass, date: e.target.value })}
                          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Hora</label>
                        <input
                          type="time"
                          value={editingClass?.time || ''}
                          onChange={(e) => setEditingClass({ ...editingClass, time: e.target.value })}
                          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Alumnos (separados por coma)</label>
                        <input
                          type="text"
                          value={editingClass?.students || ''}
                          onChange={(e) => setEditingClass({ ...editingClass, students: e.target.value })}
                          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        />
                      </div>
                    </div>
                    <div className="flex justify-end space-x-2">
                      <button
                        onClick={() => { setShowForm(false); setEditingClass(null); }}
                        className="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors"
                      >
                        Cancelar
                      </button>
                      <button
                        onClick={handleSaveEdit}
                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                      >
                        Guardar
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className="flex justify-end">
                    <button
                      onClick={() => setShowForm(true)}
                      className="px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors"
                    >
                      <i className="fas fa-plus-circle mr-2"></i>
                      Registrar Nueva Clase
                    </button>
                  </div>
                )}

                {/* Lógica de la tabla, es la misma que tu código original */}
                {classes.length > 0 && (
                  <div className="mt-8 overflow-hidden border border-gray-200 shadow-lg rounded-2xl">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Fecha</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Hora</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Alumnos</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {classes.map((cls, index) => (
                          <tr key={index}>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{cls.date}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{cls.time}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{cls.students.join(', ')}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                              <button onClick={() => handleEditClass(cls)} className="text-blue-600 hover:text-blue-900 mr-2">
                                <i className="fas fa-edit"></i>
                              </button>
                              <button onClick={() => handleDeleteGroupedClass(cls.ids)} className="text-red-600 hover:text-red-900">
                                <i className="fas fa-trash-alt"></i>
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Renderizar la aplicación en el DOM
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);

  </script>
</body>
</html>
