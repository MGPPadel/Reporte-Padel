<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Informe de Clases de Padel</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Iconos y librerÃ­as -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, 
      createUserWithEmailAndPassword, sendPasswordResetEmail, 
      browserSessionPersistence, browserLocalPersistence, setPersistence 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, 
      query, onSnapshot, writeBatch, Timestamp, getDoc 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Exponer Firebase en window (para usar dentro de Babel)
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.sendPasswordResetEmail = sendPasswordResetEmail;
    window.browserSessionPersistence = browserSessionPersistence;
    window.browserLocalPersistence = browserLocalPersistence;
    window.setPersistence = setPersistence;

    window.getFirestore = getFirestore;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.doc = doc;
    window.deleteDoc = deleteDoc;
    window.setDoc = setDoc;
    window.query = query;
    window.onSnapshot = onSnapshot;
    window.writeBatch = writeBatch;
    window.Timestamp = Timestamp;
    window.getDoc = getDoc;
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root"></div>
  
  <!-- Todo el React se escribe en este bloque -->
  <script type="text/babel">
   // =========================
   // CONFIGURACIÃ“N Y CONSTANTES
   // =========================

   const firebaseConfig = {
     apiKey: "AIzaSyAvk1yOsxXfc2w4YwZ1R1tQFrQuM2AbEYk",
     authDomain: "app-de-padel.firebaseapp.com",
     projectId: "app-de-padel",
     storageBucket: "app-de-padel.firebasestorage.app",
     messagingSenderId: "731771747398",
     appId: "1:731771747398:web:ebc8b723fe220869fade47"
   };

   const { useState, useEffect, useRef, useMemo } = React;

   const daysOfWeek = ["Domingo","Lunes","Martes","MiÃ©rcoles","Jueves","Viernes","SÃ¡bado"];
   const defaultClassPrices = { 1: 5000, 2: 3000, 3: 2500, 4: 2000 };
   const peopleOptions = [1, 2, 3, 4];
   const timesOfDay = [
     '8:00 a. m.', '9:00 a. m.', '10:00 a. m.', '11:00 a. m.', '12:00 p. m.',
     '1:00 p. m.', '2:00 p. m.', '3:00 p. m.', '4:00 p. m.', '5:00 p. m.',
     '6:00 p. m.', '7:00 p. m.', '8:00 p. m.', '9:00 p. m.', '10:00 p. m.',
   ];
   const colorMap = { 1: 'bg-yellow-100', 2: 'bg-green-100', 3: 'bg-blue-100', 4: 'bg-purple-100' };

   const formatPrice = (amount) => `$${amount.toLocaleString("es-AR")}`;

   // =========================
   // COMPONENTES REUTILIZABLES
   // =========================

   const MessageBox = ({ show, title, content, type, onConfirm, onClose }) => {
     if (!show) return null;
     let icon, bgColor, titleColor;
     switch (type) {
       case "success":
         icon = <i className="fas fa-check-circle text-4xl text-green-600"></i>;
         titleColor = "text-green-600"; bgColor = "bg-white"; break;
       case "error":
         icon = <i className="fas fa-times-circle text-4xl text-red-500"></i>;
         titleColor = "text-red-600"; bgColor = "bg-white"; break;
       case "confirm":
         icon = <i className="fas fa-question-circle text-4xl text-blue-800"></i>;
         titleColor = "text-blue-800"; bgColor = "bg-white"; break;
       default:
         icon = null; bgColor = "bg-white";
     }
     return (
       <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
         <div className={`p-6 rounded-xl shadow-xl w-full max-w-sm text-center ${bgColor}`}>
           <div className="mb-4">{icon}</div>
           <h3 className={`text-lg font-bold mb-2 ${titleColor}`}>{title}</h3>
           <p className="text-sm text-gray-500 mb-4">{content}</p>
           <div className="mt-4">
             {type === "confirm" && (
               <button onClick={onConfirm} className="py-2 px-4 mr-2 rounded-lg font-bold text-white bg-blue-800 hover:bg-blue-900">
                 Aceptar
               </button>
             )}
             <button
               onClick={onClose}
               className={`py-2 px-4 rounded-lg font-bold text-white ${
                 type === "confirm" ? "bg-gray-400 hover:bg-gray-500" :
                 type === "success" ? "bg-blue-600 hover:bg-blue-700" : "bg-red-500 hover:bg-red-600"
               }`}
             >
               {type === "confirm" ? "Cancelar" : "Cerrar"}
             </button>
           </div>
         </div>
       </div>
     );
   };

   // ðŸ‘¤ Autocomplete de alumnos
   const AutocompleteStudentInput = ({ index, newEntry, setNewEntry, students }) => {
     const [activeIndex, setActiveIndex] = useState(-1);
     const [open, setOpen] = useState(false);
     const containerRef = useRef(null);
     const filteredStudents = useMemo(() => {
       const term = (newEntry.studentNames[index] || "").toLowerCase();
       if (!term) return [];
       return students.filter(stu => (`${stu.firstName} ${stu.lastName}`).toLowerCase().includes(term)).slice(0, 5);
     }, [students, newEntry.studentNames, index]);
     useEffect(() => {
       const handleClickOutside = (e) => {
         if (containerRef.current && !containerRef.current.contains(e.target)) {
           setOpen(false); setActiveIndex(-1);
         }
       };
       document.addEventListener("mousedown", handleClickOutside);
       return () => document.removeEventListener("mousedown", handleClickOutside);
     }, []);
     const handleSelect = (stu) => {
       const newNames = [...newEntry.studentNames];
       newNames[index] = `${stu.firstName} ${stu.lastName}`;
       const newIds = [...(newEntry.studentIds || [])];
       newIds[index] = stu.id;
       setNewEntry(prev => ({ ...prev, studentNames: newNames, studentIds: newIds }));
       setActiveIndex(-1); setOpen(false);
     };
     return (
       <div className="relative mb-2" ref={containerRef}>
         <input
           type="text"
           placeholder={`Alumno ${index + 1}`}
           value={newEntry.studentNames[index] || ""}
           onChange={(e) => {
             const val = e.target.value;
             const newNames = [...newEntry.studentNames];
             newNames[index] = val;
             setNewEntry(prev => ({ ...prev, studentNames: newNames }));
             setActiveIndex(-1); setOpen(true);
           }}
           onFocus={() => setOpen(true)}
           className="peer p-3 w-full border rounded-lg focus:ring-2 focus:ring-blue-500"
         />
         {open && newEntry.studentNames[index] && filteredStudents.length > 0 && (
           <div className="absolute left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto z-50">
             {filteredStudents.map((stu, i) => (
               <div key={stu.id} onMouseDown={(e) => { e.preventDefault(); handleSelect(stu); }}
                 className={`px-3 py-2 cursor-pointer ${i === activeIndex ? "bg-blue-100 text-blue-800 font-semibold" : "hover:bg-gray-100"}`}>
                 {stu.firstName} {stu.lastName}
               </div>
             ))}
           </div>
         )}
       </div>
     );
   };

   // =========================
   // VISTAS
   // =========================

   const DailyReportView = ({ classes, formatPrice }) => {
     const today = new Date().toISOString().split("T")[0];
     const todayClasses = classes.filter(c => c.date === today);
     const totalEarnings = todayClasses.reduce((sum, c) => sum + (c.price || 0), 0);
     return (
       <div className="bg-white p-6 rounded-xl shadow-md w-full max-w-2xl mx-auto">
         <h2 className="text-2xl font-bold mb-4">ðŸ“… Reporte Diario</h2>
         <p className="mb-2 text-gray-600">Clases de hoy ({today})</p>
         {todayClasses.length === 0 ? (
           <p className="text-gray-500">No hay clases cargadas para hoy.</p>
         ) : (
           <ul className="space-y-2">
             {todayClasses.map((c, idx) => (
               <li key={idx} className="p-3 bg-gray-100 rounded-lg">
                 {c.time} â€“ {c.studentNames?.join(", ")} â€“ {formatPrice(c.price)}
               </li>
             ))}
           </ul>
         )}
         <div className="mt-4 font-bold text-lg">
           Total del dÃ­a: {formatPrice(totalEarnings)}
         </div>
       </div>
     );
   };

   // CRUD de alumnos
   const StudentsView = ({ students, setStudents, dbRef, userId }) => {
     const [newStudent, setNewStudent] = useState({ firstName: "", lastName: "" });
     const addStudent = async () => {
       if (!newStudent.firstName || !newStudent.lastName) return;
       const docRef = await window.addDoc(window.collection(dbRef.current,"users",userId,"students"), newStudent);
       setStudents([...students, { ...newStudent, id: docRef.id }]);
       setNewStudent({ firstName: "", lastName: "" });
     };
     const deleteStudent = async (id) => {
       await window.deleteDoc(window.doc(dbRef.current,"users",userId,"students",id));
       setStudents(students.filter(s => s.id !== id));
     };
     return (
       <div className="bg-white p-6 rounded-xl shadow-md w-full max-w-2xl mx-auto">
         <h2 className="text-2xl font-bold mb-4">ðŸ‘¤ Alumnos</h2>
         <div className="flex space-x-2 mb-4">
           <input type="text" placeholder="Nombre" value={newStudent.firstName}
             onChange={(e) => setNewStudent({ ...newStudent, firstName: e.target.value })}
             className="p-2 border rounded-lg flex-1"/>
           <input type="text" placeholder="Apellido" value={newStudent.lastName}
             onChange={(e) => setNewStudent({ ...newStudent, lastName: e.target.value })}
             className="p-2 border rounded-lg flex-1"/>
           <button onClick={addStudent} className="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700">Agregar</button>
         </div>
         <ul className="space-y-2">
           {students.map((s) => (
             <li key={s.id} className="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
               <span>{s.firstName} {s.lastName}</span>
               <button onClick={() => deleteStudent(s.id)} className="text-red-500 hover:text-red-700">
                 <i className="fas fa-trash"></i>
               </button>
             </li>
           ))}
         </ul>
       </div>
     );
   };

   // CRUD de clases
   const ClassesView = ({ classes, setClasses, students, dbRef, userId, formatPrice }) => {
     const [newClass, setNewClass] = useState({ date: "", time: "", studentNames: [], price: defaultClassPrices[2] });
     const addClass = async () => {
       if (!newClass.date || !newClass.time || newClass.studentNames.length === 0) return;
       const docRef = await window.addDoc(window.collection(dbRef.current,"users",userId,"classes"), newClass);
       setClasses([...classes, { ...newClass, id: docRef.id }]);
       setNewClass({ date: "", time: "", studentNames: [], price: defaultClassPrices[2] });
     };
     const deleteClass = async (id) => {
       await window.deleteDoc(window.doc(dbRef.current,"users",userId,"classes",id));
       setClasses(classes.filter(c => c.id !== id));
     };
     return (
       <div className="bg-white p-6 rounded-xl shadow-md w-full max-w-3xl mx-auto">
         <h2 className="text-2xl font-bold mb-4">ðŸ“š Clases</h2>
         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
           <input type="date" value={newClass.date}
             onChange={(e) => setNewClass({ ...newClass, date: e.target.value })}
             className="p-2 border rounded-lg"/>
           <select value={newClass.time}
             onChange={(e) => setNewClass({ ...newClass, time: e.target.value })}
             className="p-2 border rounded-lg">
             <option value="">Seleccionar horario</option>
             {timesOfDay.map(t => <option key={t} value={t}>{t}</option>)}
           </select>
           <input type="text" placeholder="Alumnos (separados por coma)" value={newClass.studentNames.join(", ")}
             onChange={(e) => setNewClass({ ...newClass, studentNames: e.target.value.split(",") })}
             className="p-2 border rounded-lg col-span-2"/>
           <input type="number" placeholder="Precio" value={newClass.price}
             onChange={(e) => setNewClass({ ...newClass, price: parseInt(e.target.value) })}
             className="p-2 border rounded-lg"/>
         </div>
         <button onClick={addClass} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Agregar Clase</button>
         <ul className="mt-6 space-y-2">
           {classes.map((c) => (
             <li key={c.id} className="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
               <span>{c.date} â€“ {c.time} â€“ {c.studentNames.join(", ")} â€“ {formatPrice(c.price)}</span>
               <button onClick={() => deleteClass(c.id)} className="text-red-500 hover:text-red-700">
                 <i className="fas fa-trash"></i>
               </button>
             </li>
           ))}
         </ul>
       </div>
     );
   };

   // CRUD de pagos
   const PaymentsView = ({ payments, setPayments, dbRef, userId, formatPrice }) => {
     const [newPayment, setNewPayment] = useState({ date: "", amount: "" });
     const addPayment = async () => {
       if (!newPayment.date || !newPayment.amount) return;
       const docRef = await window.addDoc(window.collection(dbRef.current,"users",userId,"payments"), newPayment);
       setPayments([...payments, { ...newPayment, id: docRef.id }]);
       setNewPayment({ date: "", amount: "" });
     };
     const deletePayment = async (id) => {
       await window.deleteDoc(window.doc(dbRef.current,"users",userId,"payments",id));
       setPayments(payments.filter(p => p.id !== id));
     };
     return (
       <div className="bg-white p-6 rounded-xl shadow-md w-full max-w-2xl mx-auto">
         <h2 className="text-2xl font-bold mb-4">ðŸ’° Pagos del Club</h2>
         <div className="flex space-x-2 mb-4">
           <input type="date" value={newPayment.date}
             onChange={(e) => setNewPayment({ ...newPayment, date: e.target.value })}
             className="p-2 border rounded-lg flex-1"/>
           <input type="number" placeholder="Monto" value={newPayment.amount}
             onChange={(e) => setNewPayment({ ...newPayment, amount: parseInt(e.target.value) })}
             className="p-2 border rounded-lg flex-1"/>
           <button onClick={addPayment} className="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700">Agregar</button>
         </div>
         <ul className="space-y-2">
           {payments.map((p) => (
             <li key={p.id} className="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
               <span>{p.date} â€“ {formatPrice(p.amount)}</span>
               <button onClick={() => deletePayment(p.id)} className="text-red-500 hover:text-red-700">
                 <i className="fas fa-trash"></i>
               </button>
             </li>
           ))}
         </ul>
       </div>
     );
   };

   // =========================
   // APP PRINCIPAL
   // =========================

   const App = () => {
     const [user, setUser] = useState(null);
     const [view, setView] = useState("dashboard");
     const [students, setStudents] = useState([]);
     const [classes, setClasses] = useState([]);
     const [payments, setPayments] = useState([]);
     const dbRef = useRef(null);
     const userId = user?.uid;

     useEffect(() => {
       const app = window.initializeApp(firebaseConfig);
       const auth = window.getAuth(app);
       dbRef.current = window.getFirestore(app);
       window.onAuthStateChanged(auth, (usr) => setUser(usr));
     }, []);

     if (!user) {
       return (
         <div className="flex items-center justify-center h-screen">
           <div className="bg-white p-6 rounded-xl shadow-md w-full max-w-sm">
             <h2 className="text-2xl font-bold mb-4">Iniciar SesiÃ³n</h2>
             {/* login simple */}
           </div>
         </div>
       );
     }

     return (
       <div>
         <nav className="bg-blue-800 text-white p-4 flex justify-between">
           <h1 className="font-bold">App de Padel</h1>
           <div className="space-x-4">
             <button onClick={() => setView("dashboard")}>Dashboard</button>
             <button onClick={() => setView("students")}>Alumnos</button>
             <button onClick={() => setView("list")}>Clases</button>
             <button onClick={() => setView("clubPayments")}>Pagos</button>
             <button onClick={() => setView("reports")}>Reportes</button>
             <button onClick={() => window.signOut(window.getAuth())}>Salir</button>
           </div>
         </nav>
         <main className="p-4">
           {view === "dashboard" && <DailyReportView classes={classes} formatPrice={formatPrice}/>}
           {view === "students" && <StudentsView students={students} setStudents={setStudents} dbRef={dbRef} userId={userId}/>}
           {view === "list" && <ClassesView classes={classes} setClasses={setClasses} students={students} dbRef={dbRef} userId={userId} formatPrice={formatPrice}/>}
           {view === "clubPayments" && <PaymentsView payments={payments} setPayments={setPayments} dbRef={dbRef} userId={userId} formatPrice={formatPrice}/>}
           {view === "reports" && (
             <div className="bg-white p-6 rounded-xl shadow-md w-full max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold mb-4">ðŸ“Š Reportes</h2>
               <p className="text-gray-600">AquÃ­ podrÃ¡s generar informes.</p>
             </div>
           )}
         </main>
       </div>
     );
   };

   ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
