<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe de Clases de Padel</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // NOTA IMPORTANTE: Para una mejor seguridad, estas variables deberían manejarse en un entorno de servidor.
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- FUNCIONES DE AYUDA ---

        const formatNumber = (num) => num.toString().padStart(2, '0');

        const formatDate = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return `${formatNumber(date.getDate())}/${formatNumber(date.getMonth() + 1)}/${date.getFullYear()} ${formatNumber(date.getHours())}:${formatNumber(date.getMinutes())}`;
        };

        const getCurrentMonth = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // getMonth() es 0-indexado
            return `${year}-${formatNumber(month)}`;
        };

        // --- COMPONENTE DE PÁGINA DE INICIO DE SESIÓN ---

        const LoginPage = ({ setUserId }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [isRegistering, setIsRegistering] = React.useState(false);
            const [isResettingPassword, setIsResettingPassword] = React.useState(false);
            const [successMessage, setSuccessMessage] = React.useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMessage('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError('Error de inicio de sesión. Revisa tu email y contraseña.');
                    console.error("Error al iniciar sesión:", err.code);
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMessage('');
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    setSuccessMessage('Registro exitoso. ¡Ahora puedes iniciar sesión!');
                    setIsRegistering(false);
                } catch (err) {
                    setError('Error de registro. Revisa el formato del email o la contraseña (debe tener al menos 6 caracteres).');
                    console.error("Error al registrar:", err.code);
                }
            };

            const handlePasswordReset = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMessage('');
                try {
                    await sendPasswordResetEmail(auth, email);
                    setSuccessMessage('Se ha enviado un correo electrónico para restablecer la contraseña.');
                    setIsResettingPassword(false);
                } catch (err) {
                    setError('Error al restablecer la contraseña. Asegúrate de que el correo electrónico sea válido.');
                    console.error("Error al restablecer contraseña:", err.code);
                }
            };

            const renderForm = () => {
                if (isResettingPassword) {
                    return (
                        <form onSubmit={handlePasswordReset} className="space-y-4">
                            <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" required className="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600">Restablecer Contraseña</button>
                            <button type="button" onClick={() => setIsResettingPassword(false)} className="w-full px-4 py-2 mt-2 font-bold text-blue-500 rounded-md hover:underline">Volver al inicio de sesión</button>
                        </form>
                    );
                }

                if (isRegistering) {
                    return (
                        <form onSubmit={handleRegister} className="space-y-4">
                            <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" required className="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Contraseña" required className="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600">Registrar</button>
                            <button type="button" onClick={() => setIsRegistering(false)} className="w-full px-4 py-2 mt-2 font-bold text-blue-500 rounded-md hover:underline">Volver al inicio de sesión</button>
                        </form>
                    );
                }

                return (
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" required className="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Contraseña" required className="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600">Iniciar Sesión</button>
                        <button type="button" onClick={() => setIsRegistering(true)} className="w-full px-4 py-2 mt-2 font-bold text-blue-500 rounded-md hover:underline">Crear Cuenta</button>
                        <button type="button" onClick={() => setIsResettingPassword(true)} className="w-full px-4 py-2 mt-2 font-bold text-blue-500 rounded-md hover:underline">¿Olvidaste tu contraseña?</button>
                    </form>
                );
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100">
                    <div className="w-full max-w-md p-8 bg-white rounded-lg shadow-xl">
                        <h1 className="mb-6 text-2xl font-bold text-center text-gray-800">
                            {isRegistering ? 'Crear Cuenta' : isResettingPassword ? 'Restablecer Contraseña' : 'Iniciar Sesión'}
                        </h1>
                        {error && <div className="p-3 mb-4 text-sm text-center text-red-700 bg-red-100 rounded-md">{error}</div>}
                        {successMessage && <div className="p-3 mb-4 text-sm text-center text-green-700 bg-green-100 rounded-md">{successMessage}</div>}
                        {renderForm()}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL DE LA APLICACIÓN ---

        const App = () => {
            const [userId, setUserId] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [currentPage, setCurrentPage] = React.useState('home');
            const [classes, setClasses] = React.useState([]);
            const [students, setStudents] = React.useState([]); // AÑADIDO: Estado para guardar la lista de alumnos
            const [payments, setPayments] = React.useState([]);
            const [logs, setLogs] = React.useState([]);
            const [editClass, setEditClass] = React.useState(null);
            const [editStudent, setEditStudent] = React.useState(null);
            const [editPayment, setEditPayment] = React.useState(null);
            const [studentSearch, setStudentSearch] = React.useState('');
            const [paymentSearch, setPaymentSearch] = React.useState('');
            const [paymentDate, setPaymentDate] = React.useState(getCurrentMonth());
            const [studentFilter, setStudentFilter] = React.useState('all');
            const [monthlyReport, setMonthlyReport] = React.useState(null);
            const [isLoadingReport, setIsLoadingReport] = React.useState(false);

            React.useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, user => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                if (userId) {
                    const fetchData = async () => {
                        // Cargar clases
                        const qClasses = query(collection(db, `users/${userId}/classes`), orderBy('timestamp', 'desc'));
                        const classesSnapshot = await getDocs(qClasses);
                        setClasses(classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                        // AÑADIDO: Cargar alumnos al iniciar
                        const qStudents = query(collection(db, `users/${userId}/students`), orderBy('name'));
                        const studentsSnapshot = await getDocs(qStudents);
                        setStudents(studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                        // Cargar pagos
                        const qPayments = query(collection(db, `users/${userId}/payments`), orderBy('timestamp', 'desc'));
                        const paymentsSnapshot = await getDocs(qPayments);
                        setPayments(paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                        // Cargar logs
                        const qLogs = query(collection(db, `users/${userId}/logs`), orderBy('timestamp', 'desc'));
                        const logsSnapshot = await getDocs(qLogs);
                        setLogs(logsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    };
                    fetchData();
                }
            }, [userId]);

            // --- FUNCIONES DE CLASES ---

            const handleNewClass = async (newClass) => {
                try {
                    const docRef = await addDoc(collection(db, `users/${userId}/classes`), {
                        ...newClass,
                        timestamp: new Date()
                    });
                    setClasses([{ id: docRef.id, ...newClass, timestamp: new Date() }, ...classes]);
                    addLog('Clase Agregada', `Se agregó la clase del ${newClass.date} con ${newClass.studentNames.join(', ')}.`);
                    setCurrentPage('home');
                } catch (e) {
                    console.error("Error al añadir clase:", e);
                }
            };

            const handleEditClass = async (id, updatedClass) => {
                try {
                    const docRef = doc(db, `users/${userId}/classes`, id);
                    await updateDoc(docRef, updatedClass);
                    setClasses(classes.map(c => c.id === id ? { ...updatedClass, id } : c));
                    addLog('Clase Editada', `Se editó la clase del ${updatedClass.date}.`);
                    setEditClass(null);
                    setCurrentPage('home');
                } catch (e) {
                    console.error("Error al editar clase:", e);
                }
            };

            const handleDeleteClass = async (id) => {
                if (window.confirm("¿Estás seguro de que quieres eliminar esta clase?")) {
                    try {
                        await deleteDoc(doc(db, `users/${userId}/classes`, id));
                        setClasses(classes.filter(c => c.id !== id));
                        addLog('Clase Eliminada', 'Se eliminó una clase.');
                    } catch (e) {
                        console.error("Error al eliminar clase:", e);
                    }
                }
            };

            const getStudentPayments = (studentName) => {
                return payments.filter(p => p.studentName === studentName).reduce((sum, p) => sum + p.amount, 0);
            };

            const getStudentClasses = (studentName) => {
                return classes.filter(c => c.studentNames.includes(studentName)).length;
            };

            // --- FUNCIONES DE ALUMNOS ---

            const handleNewStudent = async (newStudent) => {
                try {
                    const docRef = await addDoc(collection(db, `users/${userId}/students`), {
                        ...newStudent,
                        timestamp: new Date()
                    });
                    setStudents([{ id: docRef.id, ...newStudent, timestamp: new Date() }, ...students]);
                    addLog('Alumno Agregado', `Se agregó a ${newStudent.name}.`);
                    setCurrentPage('students');
                } catch (e) {
                    console.error("Error al añadir alumno:", e);
                }
            };

            const handleEditStudent = async (id, updatedStudent) => {
                try {
                    const docRef = doc(db, `users/${userId}/students`, id);
                    await updateDoc(docRef, updatedStudent);
                    setStudents(students.map(s => s.id === id ? { ...updatedStudent, id } : s));
                    addLog('Alumno Editado', `Se editó la información de ${updatedStudent.name}.`);
                    setEditStudent(null);
                    setCurrentPage('students');
                } catch (e) {
                    console.error("Error al editar alumno:", e);
                }
            };

            const handleDeleteStudent = async (id) => {
                if (window.confirm("¿Estás seguro de que quieres eliminar a este alumno?")) {
                    try {
                        await deleteDoc(doc(db, `users/${userId}/students`, id));
                        setStudents(students.filter(s => s.id !== id));
                        addLog('Alumno Eliminado', 'Se eliminó un alumno.');
                    } catch (e) {
                        console.error("Error al eliminar alumno:", e);
                    }
                }
            };

            const handleNewPayment = async (newPayment) => {
                try {
                    const docRef = await addDoc(collection(db, `users/${userId}/payments`), {
                        ...newPayment,
                        timestamp: new Date()
                    });
                    setPayments([{ id: docRef.id, ...newPayment, timestamp: new Date() }, ...payments]);
                    addLog('Pago Agregado', `Se registró un pago de ${newPayment.amount} de ${newPayment.studentName}.`);
                    setCurrentPage('payments');
                } catch (e) {
                    console.error("Error al añadir pago:", e);
                }
            };

            const handleEditPayment = async (id, updatedPayment) => {
                try {
                    const docRef = doc(db, `users/${userId}/payments`, id);
                    await updateDoc(docRef, updatedPayment);
                    setPayments(payments.map(p => p.id === id ? { ...updatedPayment, id } : p));
                    addLog('Pago Editado', 'Se editó un pago.');
                    setEditPayment(null);
                    setCurrentPage('payments');
                } catch (e) {
                    console.error("Error al editar pago:", e);
                }
            };

            const handleDeletePayment = async (id) => {
                if (window.confirm("¿Estás seguro de que quieres eliminar este pago?")) {
                    try {
                        await deleteDoc(doc(db, `users/${userId}/payments`, id));
                        setPayments(payments.filter(p => p.id !== id));
                        addLog('Pago Eliminado', 'Se eliminó un pago.');
                    } catch (e) {
                        console.error("Error al eliminar pago:", e);
                    }
                }
            };

            const addLog = async (action, details) => {
                try {
                    const newLog = {
                        action,
                        details,
                        timestamp: new Date()
                    };
                    const docRef = await addDoc(collection(db, `users/${userId}/logs`), newLog);
                    setLogs([{ id: docRef.id, ...newLog }, ...logs]);
                } catch (e) {
                    console.error("Error al añadir log:", e);
                }
            };

            // --- COMPONENTES DE VISTA ---

            const Header = () => (
                <div className="flex items-center justify-between p-4 mb-8 bg-blue-600 text-white rounded-b-lg shadow-lg">
                    <h1 className="text-2xl font-bold">Gestión Padel</h1>
                    <nav className="space-x-4">
                        <button onClick={() => setCurrentPage('home')} className={`font-semibold ${currentPage === 'home' ? 'text-yellow-300' : 'hover:text-yellow-300'}`}>Clases</button>
                        <button onClick={() => setCurrentPage('students')} className={`font-semibold ${currentPage === 'students' ? 'text-yellow-300' : 'hover:text-yellow-300'}`}>Alumnos</button>
                        <button onClick={() => setCurrentPage('payments')} className={`font-semibold ${currentPage === 'payments' ? 'text-yellow-300' : 'hover:text-yellow-300'}`}>Pagos</button>
                        <button onClick={() => setCurrentPage('monthlyReport')} className={`font-semibold ${currentPage === 'monthlyReport' ? 'text-yellow-300' : 'hover:text-yellow-300'}`}>Reporte Mensual</button>
                        <button onClick={() => setCurrentPage('logs')} className={`font-semibold ${currentPage === 'logs' ? 'text-yellow-300' : 'hover:text-yellow-300'}`}>Actividad</button>
                        <button onClick={() => {
                            signOut(auth);
                            setCurrentPage('home');
                        }} className="font-semibold hover:text-red-300">Salir</button>
                    </nav>
                </div>
            );

            // AÑADIDO: COMPONENTE DE SELECCIÓN DE ALUMNOS CON MULTI-SELECT
            const StudentSelector = ({ students, selectedStudents, setSelectedStudents }) => {
                const handleSelectChange = (e) => {
                    const selectedOptions = Array.from(e.target.selectedOptions).map(option => option.value);
                    setSelectedStudents(selectedOptions);
                };

                return (
                    <div className="mb-4">
                        <label className="block mb-2 text-sm font-bold text-gray-700">Alumnos</label>
                        <select
                            multiple
                            value={selectedStudents}
                            onChange={handleSelectChange}
                            className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline h-32"
                        >
                            {students.map(student => (
                                <option key={student.id} value={student.name}>{student.name}</option>
                            ))}
                        </select>
                        <p className="mt-1 text-xs text-gray-500">Mantén presionada la tecla Ctrl (o Cmd en Mac) para seleccionar varios alumnos.</p>
                    </div>
                );
            };

            // MODIFICADO: COMPONENTE DE FORMULARIO PARA NUEVAS CLASES
            const NewClassForm = ({ onNewClass, students, editingClass, onEditClass }) => {
                const initialFormState = {
                    totalStudents: '',
                    date: '',
                    time: '',
                    paymentStatus: 'pending',
                    price: '',
                    studentNames: [], // AHORA ES UN ARRAY
                };

                const [formData, setFormData] = React.useState(editingClass || initialFormState);

                React.useEffect(() => {
                    if (editingClass) {
                        setFormData(editingClass);
                    } else {
                        setFormData(initialFormState);
                    }
                }, [editingClass]);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setFormData(prev => ({ ...prev, [name]: value }));
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (formData.studentNames.length === 0) {
                        alert("Por favor, selecciona al menos un alumno.");
                        return;
                    }

                    const classToSubmit = {
                        ...formData,
                        totalStudents: formData.studentNames.length, // Se calcula automáticamente
                    };

                    if (editingClass) {
                        onEditClass(editingClass.id, classToSubmit);
                    } else {
                        onNewClass(classToSubmit);
                    }
                };

                return (
                    <form onSubmit={handleSubmit} className="p-6 bg-white rounded-lg shadow-lg">
                        <h2 className="mb-4 text-xl font-bold">{editingClass ? 'Editar Clase' : 'Añadir Clase'}</h2>
                        <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div className="mb-4">
                                <label className="block mb-2 text-sm font-bold text-gray-700">Fecha</label>
                                <input type="date" name="date" value={formData.date} onChange={handleChange} required className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                            </div>
                            <div className="mb-4">
                                <label className="block mb-2 text-sm font-bold text-gray-700">Hora</label>
                                <input type="time" name="time" value={formData.time} onChange={handleChange} required className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                            </div>
                        </div>
                        {/* AÑADIDO: Uso del componente StudentSelector */}
                        <StudentSelector
                            students={students}
                            selectedStudents={formData.studentNames}
                            setSelectedStudents={(selected) => setFormData(prev => ({ ...prev, studentNames: selected }))}
                        />

                        <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div className="mb-4">
                                <label className="block mb-2 text-sm font-bold text-gray-700">Precio</label>
                                <input type="number" name="price" value={formData.price} onChange={handleChange} required className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                            </div>
                            <div className="mb-4">
                                <label className="block mb-2 text-sm font-bold text-gray-700">Estado de Pago</label>
                                <select name="paymentStatus" value={formData.paymentStatus} onChange={handleChange} required className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline">
                                    <option value="pending">Pendiente</option>
                                    <option value="paid">Pagado</option>
                                </select>
                            </div>
                        </div>
                        <div className="flex items-center justify-between">
                            <button type="submit" className="px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline">
                                {editingClass ? 'Guardar Cambios' : 'Añadir Clase'}
                            </button>
                            {editingClass && (
                                <button type="button" onClick={() => {
                                    setEditClass(null);
                                    setFormData(initialFormState);
                                }} className="px-4 py-2 font-bold text-red-500 rounded-md hover:bg-red-100 focus:outline-none focus:shadow-outline">
                                    Cancelar
                                </button>
                            )}
                        </div>
                    </form>
                );
            };

            // MODIFICADO: SECCIÓN DE CLASES PARA MOSTRAR LA LISTA DE ALUMNOS SELECCIONADOS
            const ClassesSection = () => (
                <>
                    <h2 className="mb-4 text-2xl font-bold text-gray-800">Listado de Clases</h2>
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        {classes.length > 0 ? (
                            <ul className="space-y-4">
                                {classes.map(clase => (
                                    <li key={clase.id} className="p-4 border rounded-lg bg-gray-50 shadow-sm flex items-center justify-between">
                                        <div>
                                            <p className="font-bold text-gray-800 text-lg">
                                                <i className="fa-solid fa-calendar-check mr-2 text-blue-500"></i>
                                                Clase del {clase.date} a las {clase.time}
                                            </p>
                                            <p className="text-gray-600 mt-1">
                                                <i className="fa-solid fa-users mr-2 text-blue-500"></i>
                                                Alumnos: <span className="font-semibold">{clase.studentNames.join(', ')}</span>
                                            </p>
                                            <p className="text-gray-600">
                                                <i className="fa-solid fa-money-bill-wave mr-2 text-blue-500"></i>
                                                Precio: ${clase.price}
                                            </p>
                                            <p className={`font-semibold mt-1 ${clase.paymentStatus === 'paid' ? 'text-green-600' : 'text-red-600'}`}>
                                                Estado: {clase.paymentStatus === 'paid' ? 'Pagado' : 'Pendiente'}
                                            </p>
                                        </div>
                                        <div className="flex space-x-2">
                                            <button onClick={() => {
                                                setEditClass(clase);
                                                setCurrentPage('new-class');
                                            }} className="p-2 text-blue-600 hover:text-blue-800">
                                                <i className="fa-solid fa-edit"></i>
                                            </button>
                                            <button onClick={() => handleDeleteClass(clase.id)} className="p-2 text-red-600 hover:text-red-800">
                                                <i className="fa-solid fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-center text-gray-500 p-8">No hay clases registradas.</p>
                        )}
                        <div className="mt-6 text-center">
                            <button onClick={() => setCurrentPage('new-class')} className="px-6 py-2 font-bold text-white bg-green-500 rounded-md hover:bg-green-600 focus:outline-none focus:shadow-outline">
                                Añadir Nueva Clase
                            </button>
                        </div>
                    </div>
                </>
            );

            const StudentsSection = () => {
                const [newStudentName, setNewStudentName] = React.useState('');
                const [newStudentPhone, setNewStudentPhone] = React.useState('');
                const [newStudentEmail, setNewStudentEmail] = React.useState('');
                const [showAddForm, setShowAddForm] = React.useState(false);

                const handleAddStudentSubmit = async (e) => {
                    e.preventDefault();
                    await handleNewStudent({ name: newStudentName, phone: newStudentPhone, email: newStudentEmail });
                    setNewStudentName('');
                    setNewStudentPhone('');
                    setNewStudentEmail('');
                    setShowAddForm(false);
                };

                const filteredStudents = students.filter(student =>
                    student.name.toLowerCase().includes(studentSearch.toLowerCase())
                );

                return (
                    <>
                        <h2 className="mb-4 text-2xl font-bold text-gray-800">Gestión de Alumnos</h2>
                        <div className="bg-white p-6 rounded-lg shadow-lg">
                            <div className="flex items-center justify-between mb-4">
                                <input
                                    type="text"
                                    placeholder="Buscar por nombre..."
                                    value={studentSearch}
                                    onChange={(e) => setStudentSearch(e.target.value)}
                                    className="w-full md:w-1/2 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button onClick={() => setShowAddForm(!showAddForm)} className="px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline">
                                    {showAddForm ? 'Cerrar Formulario' : 'Añadir Alumno'}
                                </button>
                            </div>
                            {showAddForm && (
                                <form onSubmit={handleAddStudentSubmit} className="p-4 mb-4 bg-gray-100 rounded-lg shadow-inner">
                                    <div className="mb-2">
                                        <label className="block mb-1 text-sm font-bold text-gray-700">Nombre</label>
                                        <input type="text" value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} placeholder="Nombre del alumno" required className="w-full px-3 py-2 border rounded-md" />
                                    </div>
                                    <div className="mb-2">
                                        <label className="block mb-1 text-sm font-bold text-gray-700">Teléfono</label>
                                        <input type="tel" value={newStudentPhone} onChange={(e) => setNewStudentPhone(e.target.value)} placeholder="Teléfono" className="w-full px-3 py-2 border rounded-md" />
                                    </div>
                                    <div className="mb-2">
                                        <label className="block mb-1 text-sm font-bold text-gray-700">Email</label>
                                        <input type="email" value={newStudentEmail} onChange={(e) => setNewStudentEmail(e.target.value)} placeholder="Email" className="w-full px-3 py-2 border rounded-md" />
                                    </div>
                                    <button type="submit" className="w-full px-4 py-2 mt-2 font-bold text-white bg-green-500 rounded-md hover:bg-green-600">Guardar Alumno</button>
                                </form>
                            )}

                            {filteredStudents.length > 0 ? (
                                <ul className="space-y-4">
                                    {filteredStudents.map(student => (
                                        <li key={student.id} className="p-4 border rounded-lg bg-gray-50 shadow-sm flex items-center justify-between">
                                            <div>
                                                <p className="font-bold text-gray-800 text-lg">
                                                    <i className="fa-solid fa-user mr-2 text-blue-500"></i>{student.name}
                                                </p>
                                                {student.phone && <p className="text-gray-600"><i className="fa-solid fa-phone mr-2 text-blue-500"></i>{student.phone}</p>}
                                                {student.email && <p className="text-gray-600"><i className="fa-solid fa-envelope mr-2 text-blue-500"></i>{student.email}</p>}
                                                <p className="text-gray-600">
                                                    <i className="fa-solid fa-list-ol mr-2 text-blue-500"></i>
                                                    Clases tomadas: <span className="font-semibold">{getStudentClasses(student.name)}</span>
                                                </p>
                                                <p className="text-gray-600">
                                                    <i className="fa-solid fa-coins mr-2 text-blue-500"></i>
                                                    Pagos registrados: <span className="font-semibold">${getStudentPayments(student.name)}</span>
                                                </p>
                                            </div>
                                            <div className="flex space-x-2">
                                                <button onClick={() => {
                                                    setEditStudent(student);
                                                    setCurrentPage('edit-student');
                                                }} className="p-2 text-blue-600 hover:text-blue-800">
                                                    <i className="fa-solid fa-edit"></i>
                                                </button>
                                                <button onClick={() => handleDeleteStudent(student.id)} className="p-2 text-red-600 hover:text-red-800">
                                                    <i className="fa-solid fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-center text-gray-500 p-8">No se encontraron alumnos.</p>
                            )}
                        </div>
                    </>
                );
            };

            const EditStudentForm = ({ student, onEditStudent, setEditStudent }) => {
                const [formData, setFormData] = React.useState(student);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setFormData(prev => ({ ...prev, [name]: value }));
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onEditStudent(student.id, formData);
                };

                return (
                    <form onSubmit={handleSubmit} className="p-6 bg-white rounded-lg shadow-lg">
                        <h2 className="mb-4 text-xl font-bold">Editar Alumno</h2>
                        <div className="mb-4">
                            <label className="block mb-2 text-sm font-bold text-gray-700">Nombre</label>
                            <input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                        </div>
                        <div className="mb-4">
                            <label className="block mb-2 text-sm font-bold text-gray-700">Teléfono</label>
                            <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                        </div>
                        <div className="mb-4">
                            <label className="block mb-2 text-sm font-bold text-gray-700">Email</label>
                            <input type="email" name="email" value={formData.email} onChange={handleChange} className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                        </div>
                        <div className="flex items-center justify-between">
                            <button type="submit" className="px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline">
                                Guardar Cambios
                            </button>
                            <button type="button" onClick={() => {
                                setEditStudent(null);
                                setCurrentPage('students');
                            }} className="px-4 py-2 font-bold text-red-500 rounded-md hover:bg-red-100 focus:outline-none focus:shadow-outline">
                                Cancelar
                            </button>
                        </div>
                    </form>
                );
            };

            const PaymentsSection = () => {
                const [showAddForm, setShowAddForm] = React.useState(false);
                const [newPayment, setNewPayment] = React.useState({ studentName: '', amount: '', notes: '' });

                const handleAddPaymentSubmit = async (e) => {
                    e.preventDefault();
                    await handleNewPayment(newPayment);
                    setNewPayment({ studentName: '', amount: '', notes: '' });
                    setShowAddForm(false);
                };

                const filteredPayments = payments.filter(payment =>
                    payment.studentName.toLowerCase().includes(paymentSearch.toLowerCase())
                );

                return (
                    <>
                        <h2 className="mb-4 text-2xl font-bold text-gray-800">Gestión de Pagos</h2>
                        <div className="bg-white p-6 rounded-lg shadow-lg">
                            <div className="flex items-center justify-between mb-4">
                                <input
                                    type="text"
                                    placeholder="Buscar por alumno..."
                                    value={paymentSearch}
                                    onChange={(e) => setPaymentSearch(e.target.value)}
                                    className="w-full md:w-1/2 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button onClick={() => setShowAddForm(!showAddForm)} className="px-4 py-2 font-bold text-white bg-green-500 rounded-md hover:bg-green-600 focus:outline-none focus:shadow-outline">
                                    {showAddForm ? 'Cerrar Formulario' : 'Añadir Pago'}
                                </button>
                            </div>
                            {showAddForm && (
                                <form onSubmit={handleAddPaymentSubmit} className="p-4 mb-4 bg-gray-100 rounded-lg shadow-inner">
                                    <div className="mb-2">
                                        <label className="block mb-1 text-sm font-bold text-gray-700">Alumno</label>
                                        <select
                                            name="studentName"
                                            value={newPayment.studentName}
                                            onChange={(e) => setNewPayment({ ...newPayment, studentName: e.target.value })}
                                            required
                                            className="w-full px-3 py-2 border rounded-md"
                                        >
                                            <option value="">Seleccione un alumno</option>
                                            {students.map(student => (
                                                <option key={student.id} value={student.name}>{student.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="mb-2">
                                        <label className="block mb-1 text-sm font-bold text-gray-700">Monto</label>
                                        <input type="number" name="amount" value={newPayment.amount} onChange={(e) => setNewPayment({ ...newPayment, amount: Number(e.target.value) })} placeholder="Monto" required className="w-full px-3 py-2 border rounded-md" />
                                    </div>
                                    <div className="mb-2">
                                        <label className="block mb-1 text-sm font-bold text-gray-700">Notas (opcional)</label>
                                        <input type="text" name="notes" value={newPayment.notes} onChange={(e) => setNewPayment({ ...newPayment, notes: e.target.value })} placeholder="Notas adicionales" className="w-full px-3 py-2 border rounded-md" />
                                    </div>
                                    <button type="submit" className="w-full px-4 py-2 mt-2 font-bold text-white bg-green-500 rounded-md hover:bg-green-600">Guardar Pago</button>
                                </form>
                            )}

                            {filteredPayments.length > 0 ? (
                                <ul className="space-y-4">
                                    {filteredPayments.map(payment => (
                                        <li key={payment.id} className="p-4 border rounded-lg bg-gray-50 shadow-sm flex items-center justify-between">
                                            <div>
                                                <p className="font-bold text-gray-800 text-lg">
                                                    <i className="fa-solid fa-user-circle mr-2 text-blue-500"></i>{payment.studentName}
                                                </p>
                                                <p className="text-gray-600">
                                                    <i className="fa-solid fa-dollar-sign mr-2 text-blue-500"></i>
                                                    Monto: ${payment.amount}
                                                </p>
                                                {payment.notes && <p className="text-gray-600"><i className="fa-solid fa-sticky-note mr-2 text-blue-500"></i>Notas: {payment.notes}</p>}
                                                <p className="text-gray-600 text-xs">Registrado el {formatDate(payment.timestamp)}</p>
                                            </div>
                                            <div className="flex space-x-2">
                                                <button onClick={() => {
                                                    setEditPayment(payment);
                                                    setCurrentPage('edit-payment');
                                                }} className="p-2 text-blue-600 hover:text-blue-800">
                                                    <i className="fa-solid fa-edit"></i>
                                                </button>
                                                <button onClick={() => handleDeletePayment(payment.id)} className="p-2 text-red-600 hover:text-red-800">
                                                    <i className="fa-solid fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-center text-gray-500 p-8">No se encontraron pagos.</p>
                            )}
                        </div>
                    </>
                );
            };

            const EditPaymentForm = ({ payment, onEditPayment, setEditPayment }) => {
                const [formData, setFormData] = React.useState(payment);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setFormData(prev => ({ ...prev, [name]: value }));
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onEditPayment(payment.id, formData);
                };

                return (
                    <form onSubmit={handleSubmit} className="p-6 bg-white rounded-lg shadow-lg">
                        <h2 className="mb-4 text-xl font-bold">Editar Pago</h2>
                        <div className="mb-4">
                            <label className="block mb-2 text-sm font-bold text-gray-700">Alumno</label>
                            <input type="text" name="studentName" value={formData.studentName} onChange={handleChange} required className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" readOnly />
                        </div>
                        <div className="mb-4">
                            <label className="block mb-2 text-sm font-bold text-gray-700">Monto</label>
                            <input type="number" name="amount" value={formData.amount} onChange={handleChange} required className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                        </div>
                        <div className="mb-4">
                            <label className="block mb-2 text-sm font-bold text-gray-700">Notas (opcional)</label>
                            <input type="text" name="notes" value={formData.notes} onChange={handleChange} className="w-full px-3 py-2 leading-tight text-gray-700 border rounded shadow appearance-none focus:outline-none focus:shadow-outline" />
                        </div>
                        <div className="flex items-center justify-between">
                            <button type="submit" className="px-4 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline">
                                Guardar Cambios
                            </button>
                            <button type="button" onClick={() => {
                                setEditPayment(null);
                                setCurrentPage('payments');
                            }} className="px-4 py-2 font-bold text-red-500 rounded-md hover:bg-red-100 focus:outline-none focus:shadow-outline">
                                Cancelar
                            </button>
                        </div>
                    </form>
                );
            };

            const MonthlyReport = () => {
                const [reportData, setReportData] = React.useState({ classes: [], totalIncome: 0, studentsPaid: 0, totalClasses: 0, totalStudents: 0 });
                const [isLoading, setIsLoading] = React.useState(false);
                const [reportMonth, setReportMonth] = React.useState(getCurrentMonth());

                const generateReport = async () => {
                    setIsLoading(true);
                    const [year, month] = reportMonth.split('-').map(Number);
                    const startDate = new Date(year, month - 1, 1);
                    const endDate = new Date(year, month, 0);

                    const qClasses = query(
                        collection(db, `users/${userId}/classes`),
                        where('timestamp', '>=', startDate),
                        where('timestamp', '<=', endDate)
                    );
                    const classesSnapshot = await getDocs(qClasses);
                    const monthClasses = classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const totalIncome = monthClasses
                        .filter(c => c.paymentStatus === 'paid')
                        .reduce((sum, c) => sum + Number(c.price), 0);

                    const totalClasses = monthClasses.length;

                    const allStudents = new Set();
                    monthClasses.forEach(c => c.studentNames.forEach(s => allStudents.add(s)));
                    const totalStudents = allStudents.size;

                    const studentsWithPayments = new Set(
                        payments
                            .filter(p => new Date(p.timestamp.toDate()).getFullYear() === year && new Date(p.timestamp.toDate()).getMonth() + 1 === month)
                            .map(p => p.studentName)
                    );

                    const studentsPaid = studentsWithPayments.size;

                    setReportData({
                        classes: monthClasses,
                        totalIncome,
                        totalClasses,
                        totalStudents,
                        studentsPaid
                    });
                    setIsLoading(false);
                };

                const generatePDF = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const reportElement = document.getElementById('report-content');

                    if (!reportElement) {
                        alert("No se encontró el contenido del reporte para generar el PDF.");
                        return;
                    }

                    doc.html(reportElement, {
                        callback: function (pdf) {
                            pdf.save(`Reporte_Padel_${reportMonth}.pdf`);
                        },
                        x: 15,
                        y: 15,
                        width: 170,
                        windowWidth: 650
                    });
                };

                React.useEffect(() => {
                    generateReport();
                }, [reportMonth]);

                return (
                    <>
                        <h2 className="mb-4 text-2xl font-bold text-gray-800">Reporte Mensual</h2>
                        <div className="p-6 bg-white rounded-lg shadow-lg">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-semibold">Resumen de {reportMonth}</h3>
                                <div className="flex items-center space-x-2">
                                    <label htmlFor="reportMonth">Mes:</label>
                                    <input type="month" id="reportMonth" value={reportMonth} onChange={(e) => setReportMonth(e.target.value)} className="border rounded px-2 py-1" />
                                </div>
                            </div>
                            {isLoading ? (
                                <p className="text-center text-gray-500 p-8">Generando reporte...</p>
                            ) : (
                                <div id="report-content" className="p-4 bg-gray-50 rounded-md">
                                    <p className="text-lg font-bold mb-2">Clases en el mes: <span className="text-blue-600">{reportData.totalClasses}</span></p>
                                    <p className="text-lg font-bold mb-2">Total de alumnos únicos: <span className="text-blue-600">{reportData.totalStudents}</span></p>
                                    <p className="text-lg font-bold mb-2">Ingresos totales por pagos: <span className="text-green-600">${reportData.totalIncome}</span></p>
                                    <p className="text-lg font-bold mb-2">Alumnos que pagaron: <span className="text-green-600">{reportData.studentsPaid}</span></p>

                                    <h4 className="font-semibold text-lg mt-4 mb-2">Detalle de Clases</h4>
                                    {reportData.classes.length > 0 ? (
                                        <ul className="space-y-2">
                                            {reportData.classes.map(clase => (
                                                <li key={clase.id} className="p-2 border-b">
                                                    <p className="font-semibold">
                                                        {clase.date} ({clase.time}) - {clase.studentNames.join(', ')}
                                                    </p>
                                                    <p className="text-sm">Precio: ${clase.price} | Estado: {clase.paymentStatus}</p>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <p className="text-center text-gray-500">No hay clases en este mes.</p>
                                    )}
                                </div>
                            )}
                            <div className="mt-6 flex justify-center space-x-4">
                                <button onClick={generatePDF} className="px-6 py-2 font-bold text-white bg-red-500 rounded-md hover:bg-red-600 focus:outline-none focus:shadow-outline">
                                    Exportar a PDF
                                </button>
                                <button onClick={generateReport} className="px-6 py-2 font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline">
                                    Recalcular Reporte
                                </button>
                            </div>
                        </div>
                    </>
                );
            };

            const LogsSection = () => (
                <>
                    <h2 className="mb-4 text-2xl font-bold text-gray-800">Registro de Actividad Reciente</h2>
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        {logs.length > 0 ? (
                            <div className="space-y-4 max-h-[500px] overflow-y-auto">
                                <ul className="list-disc pl-5">
                                    {logs.map(log => (
                                        <li key={log.id} className="mb-2 p-2 border-b">
                                            <div className="flex items-baseline justify-between">
                                                <span className="font-bold text-blue-800 uppercase mr-2">{log.action}:</span>
                                                <span className="text-gray-700">{log.details}</span>
                                            </div>
                                            <span className="text-gray-500 text-xs">{formatDate(log.timestamp)}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ) : (
                            <p className="text-center text-gray-500 p-8 bg-white">No hay actividad reciente.</p>
                        )}
                    </div>
                </>
            );

            // --- RENDERIZADO PRINCIPAL ---

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-center text-xl text-gray-700">Cargando...</div>
                    </div>
                );
            }

            if (!userId) {
                return <LoginPage setUserId={setUserId} />;
            }

            return (
                <div className="bg-gray-100 min-h-screen p-4 md:p-8">
                    <Header />
                    <div className="max-w-4xl mx-auto">
                        {currentPage === 'home' && (
                            <>
                                <ClassesSection />
                            </>
                        )}
                        {currentPage === 'new-class' && (
                            <NewClassForm onNewClass={handleNewClass} students={students} editingClass={editClass} onEditClass={handleEditClass} />
                        )}
                        {currentPage === 'students' && (
                            <StudentsSection />
                        )}
                        {currentPage === 'edit-student' && (
                            <EditStudentForm student={editStudent} onEditStudent={handleEditStudent} setEditStudent={setEditStudent} />
                        )}
                        {currentPage === 'payments' && (
                            <PaymentsSection />
                        )}
                        {currentPage === 'edit-payment' && (
                            <EditPaymentForm payment={editPayment} onEditPayment={handleEditPayment} setEditPayment={setEditPayment} />
                        )}
                        {currentPage === 'monthlyReport' && (
                            <MonthlyReport />
                        )}
                        {currentPage === 'logs' && (
                            <LogsSection />
                        )}
                    </div>
                    {userId && (
                        <div className="mt-8 text-center text-gray-500">
                            ID de Usuario: <span className="font-mono">{userId}</span>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
