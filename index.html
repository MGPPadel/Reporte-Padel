<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Padel Manager Pro</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail, browserSessionPersistence, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, onSnapshot, writeBatch, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.writeBatch = writeBatch;
        window.Timestamp = Timestamp;
        window.getDoc = getDoc;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.browserSessionPersistence = browserSessionPersistence;
        window.browserLocalPersistence = browserLocalPersistence;
        window.setPersistence = setPersistence;
    </script>
</head>
<body class="bg-gray-900 font-sans text-gray-200">
    <div id="root"></div>
    <script type="text/babel">
    const AutocompleteStudentInput = ({ index, value, newEntry, setNewEntry, students }) => {
        const [activeIndex, setActiveIndex] = React.useState(-1);
        const [open, setOpen] = React.useState(false);
        const containerRef = React.useRef(null);
      
        const filteredStudents = React.useMemo(() => {
          const term = (newEntry.studentNames[index] || "").toLowerCase();
          if (!term) return [];
          return students
            .filter(stu => (`${stu.firstName} ${stu.lastName}`).toLowerCase().includes(term))
            .slice(0, 5);
        }, [students, newEntry.studentNames, index]);
      
        React.useEffect(() => {
          const handleClickOutside = (e) => {
            if (containerRef.current && !containerRef.current.contains(e.target)) {
              setOpen(false);
              setActiveIndex(-1);
            }
          };
          document.addEventListener("mousedown", handleClickOutside);
          return () => document.removeEventListener("mousedown", handleClickOutside);
        }, []);
        
        const handleKeyDown = (e) => {
          if (!open || filteredStudents.length === 0) return;
          if (e.key === "ArrowDown") {
            e.preventDefault();
            setActiveIndex((prev) => (prev + 1) % filteredStudents.length);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            setActiveIndex((prev) => (prev <= 0 ? filteredStudents.length - 1 : prev - 1));
          } else if (e.key === "Enter" && activeIndex >= 0) {
            e.preventDefault();
            const stu = filteredStudents[activeIndex];
            const newNames = [...newEntry.studentNames];
            newNames[index] = `${stu.firstName} ${stu.lastName}`;
            const newIds = [...(newEntry.studentIds || [])];
            newIds[index] = stu.id;
            setNewEntry((prev) => ({ ...prev, studentNames: newNames, studentIds: newIds }));
            setActiveIndex(-1);
            setOpen(false);
          }
        };
        const handleSelect = (stu) => {
          const newNames = [...newEntry.studentNames];
          newNames[index] = `${stu.firstName} ${stu.lastName}`;
          const newIds = [...(newEntry.studentIds || [])];
          newIds[index] = stu.id;
          setNewEntry((prev) => ({ ...prev, studentNames: newNames, studentIds: newIds }));
          setActiveIndex(-1);
          setOpen(false);
        };
      
        return (
          <div className="relative mb-2" ref={containerRef}>
            <input
              type="text"
              placeholder={`Alumno ${index + 1}`}
              value={newEntry.studentNames[index] || ""}
              onChange={(e) => {
                const val = e.target.value;
                const newNames = [...newEntry.studentNames];
                newNames[index] = val;
                setNewEntry((prev) => ({ ...prev, studentNames: newNames }));
                setActiveIndex(-1);
              }}
              onFocus={() => setOpen(true)}
              onKeyDown={handleKeyDown}
              className="peer p-3 w-full border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all"
            />
      
            {open 
            && newEntry.studentNames[index] && filteredStudents.length > 0 && (
              <div
                className="absolute left-0 right-0 mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow-xl max-h-48 overflow-y-auto z-50
                           opacity-0 translate-y-2 scale-95 pointer-events-none
                           transition-all duration-200 ease-out
                           peer-focus:opacity-100 peer-focus:translate-y-0 peer-focus:scale-100 peer-focus:pointer-events-auto"
              >
                {filteredStudents.map((stu, i) => (
                  <div
                    key={stu.id}
                    onMouseDown={(e) => { e.preventDefault(); handleSelect(stu); }}
                    onTouchStart={(e) => { e.preventDefault(); handleSelect(stu); }}
                    className={`px-4 py-3 cursor-pointer text-sm transition-colors ${
                      i === activeIndex ? "bg-teal-700 text-white font-semibold" : "hover:bg-gray-700"
                    }`}
                  >
                    {stu.firstName} {stu.lastName}
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };
      
    const ReplaceModal = ({ replaceData, setReplaceData, students, replaceStudentInClass }) => {
        if (replaceData.classId === null) return null;
      
        const onClose = () => setReplaceData({ classId: null, studentIndex: null });
      
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
              <div className="p-6">
                <h3 className="text-2xl font-bold mb-4 text-teal-400">Reemplazar Alumno</h3>
                <p className="mb-4 text-gray-400 text-sm">Seleccioná un nuevo alumno de la lista:</p>
                <select
                  className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 mb-4"
                  onChange={async (e) => {
                    const newStudentId = e.target.value;
                    if (!newStudentId) return;
                    const selectedStudent = students.find(s => s.id === newStudentId);
                    await replaceStudentInClass(replaceData.classId, replaceData.studentIndex, selectedStudent);
                    onClose();
                  }}
                >
                  <option value="">-- Seleccionar alumno --</option>
                  {students.map(s => (
                    <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>
                  ))}
                </select>
                <div className="flex justify-end space-x-2">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 text-sm bg-gray-600 text-gray-200 rounded-md hover:bg-gray-700 transition-colors"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };
      
    const App = () => {
        const { useState, useEffect, useRef, useMemo } = React;
        const daysOfWeek = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
        const defaultClassPrices = {
            1: 5000,
            2: 3000,
            3: 2500,
            4: 2000,
        };
        const peopleOptions = [1, 2, 3, 4];
        const timesOfDay = [
            '8:00 a.m.', '9:00 a.m.', '10:00 a.m.', '11:00 a.m.', '12:00 p.m.',
            '1:00 p.m.', '2:00 p.m.', '3:00 p.m.', '4:00 p.m.', '5:00 p.m.',
            '6:00 p.m.', '7:00 p.m.', '8:00 p.m.', '9:00 p.m.', '10:00 p.m.',
        ];
        const MessageBox = ({ show, title, content, type, onConfirm, onClose }) => {
            if (!show) return null;
            let icon, bgColor, titleColor, buttonColor;
            switch (type) {
                case 'success':
                    icon = <i className="fas fa-check-circle text-5xl text-green-400"></i>;
                    titleColor = 'text-green-400';
                    buttonColor = 'bg-teal-600 hover:bg-teal-700';
                    break;
                case 'error':
                    icon = <i className="fas fa-times-circle text-5xl text-red-500"></i>;
                    titleColor = 'text-red-500';
                    buttonColor = 'bg-red-500 hover:bg-red-600';
                    break;
                case 'confirm':
                    icon = <i className="fas fa-question-circle text-5xl text-yellow-400"></i>;
                    titleColor = 'text-yellow-400';
                    buttonColor = 'bg-teal-600 hover:bg-teal-700';
                    break;
                default:
                    icon = null;
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-center transform transition-all duration-300 ease-in-out scale-100">
                        <div className="mb-4">{icon}</div>
                        <h3 className={`text-xl font-bold mb-2 ${titleColor}`}>{title}</h3>
                        <p className="text-sm text-gray-400 mb-4">{content}</p>
                        <div className="mt-4 flex justify-center space-x-2">
                            {type === 'confirm' && (
                                <button
                                    onClick={onConfirm}
                                    className={`py-2 px-5 rounded-md font-bold transition-colors text-white ${buttonColor} shadow-md text-sm`}
                                >
                                    Aceptar
                                </button>
                            )}
                            <button
                                onClick={onClose}
                                className={`py-2 px-5 rounded-md font-bold transition-colors text-gray-200 ${type === 'confirm' ? 'bg-gray-600 hover:bg-gray-700' : buttonColor} shadow-md text-sm`}
                            >
                                {type === 'confirm' ? 'Cancelar' : 'Cerrar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const firebaseConfig = {
            apiKey: "AIzaSyAvk1yOsxXfc2w4YwZ1R1tQFrQuM2AbEYk",
            authDomain: "app-de-padel.firebaseapp.com",
            projectId: "app-de-padel",
            storageBucket: "app-de-padel.firebasestorage.app",
            messagingSenderId: "731771747398",
            appId: "1:731771747398:web:ebc8b723fe220869fade47"
        };
        const appId = typeof firebaseConfig.appId !== 'undefined' ? firebaseConfig.appId : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [userId, setUserId] = useState(null);
        const [userEmail, setUserEmail] = useState('');
        const [loading, setLoading] = useState(true);
        const [classes, setClasses] = useState([]);
        const [students, setStudents] = useState([]);
        const [payments, setPayments] = useState([]);
        const [activityLog, setActivityLog] = useState([]);
        const [customPrices, setCustomPrices] = useState(defaultClassPrices);
        const [currentPage, setCurrentPage] = useState(1);
        const [classesPerPage, setClassesPerPage] = useState(10);
        const [newEntry, setNewEntry] = useState({
            studentCount: 1,
            studentNames: [''],
            studentIds: [''],
            date: new Date().toISOString().split('T')[0],
            day: daysOfWeek[new Date().getDay()],
            time: timesOfDay[0],
            price: defaultClassPrices[1] || 0,
        });
        const [newStudent, setNewStudent] = useState({
            firstName: '',
            lastName: '',
            phone: '',
            description: '',
            status: 'Activo',
            schedule: [],
        });
        const [replaceData, setReplaceData] = useState({ classId: null, studentIndex: null });
        const [isEditingStudent, setIsEditingStudent] = useState(false);
        const [editedStudentId, setEditedStudentId] = useState(null);
        const [filterStatus, setFilterStatus] = useState('Todos');
        const [studentSearch, setStudentSearch] = useState('');
        const filteredStudentsList = React.useMemo(() => {
            const term = (studentSearch || '').toLowerCase();
            return students.filter(s => {
                const status = s.status || 'Activo';
                const matchesStatus = filterStatus === 'Todos' || status === filterStatus;
                const haystack = `${s.firstName || ''} ${s.lastName || ''} ${s.phone || ''} ${s.description || ''}`.toLowerCase();
                const matchesSearch = !term || haystack.includes(term);
                return matchesStatus && matchesSearch;
            });
        }, [students, studentSearch, filterStatus]);
        const [newPayment, setNewPayment] = useState({
            date: new Date().toISOString().split('T')[0],
            amount: 0,
            description: '',
        });
        const [isEditingPayment, setIsEditingPayment] = useState(false);
        const [editedPaymentId, setEditedPaymentId] = useState(null);

        const [monthlyReports, setMonthlyReports] = useState({});
        const [annualPaymentsReport, setAnnualPaymentsReport] = useState({});
        const [selectedMonthYear, setSelectedMonthYear] = useState('');
        const [isEditing, setIsEditing] = useState(false);
        const [editedClassId, setEditedClassId] = useState(null);
        const [showConfigModal, setShowConfigModal] = useState(false);
        const [view, setView] = useState('list');
        const [filterText, setFilterText] = useState('');
        const [isSigningUp, setIsSigningUp] = useState(false);
        const [messageBox, setMessageBox] = useState({
            show: false,
            title: '',
            content: '',
            type: 'confirm',
            onConfirm: null,
        });

        const dbRef = useRef(null);
        const authRef = useRef(null);
        const fileInputRef = useRef(null);
        const reportTableRef = useRef(null);
        const annualPaymentsReportRef = useRef(null);
        
        const formatPrice = (price) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(price);
        const formatMonthYear = (monthYearString) => {
            const [year, month] = monthYearString.split('-');
            return new Date(year, month - 1).toLocaleString('es-AR', { month: 'long', year: 'numeric' });
        };
        const formatDate = (timestamp) => {
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        };
        
        const replaceStudentInClass = async (classId, studentIndex, studentObj) => {
            if (!dbRef.current || !userId) return;
            try {
                const classDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'classes', classId);
                const snap = await window.getDoc(classDocRef);
                if (snap.exists()) {
                    const data = snap.data() || {};
                    data.studentIds = data.studentIds || [];
                    data.studentNames = data.studentNames || [];
                    data.studentIds[studentIndex] = studentObj.id;
                    data.studentNames[studentIndex] = `${studentObj.firstName} ${studentObj.lastName}`;
                    await window.setDoc(classDocRef, data);
                }
            } catch (e) {
                console.error('Error reemplazando alumno:', e);
            }
        };

        const removeStudentFromClass = async (classId, studentIndex) => {
            if (!dbRef.current || !userId) return;
            try {
                const classDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'classes', classId);
                const snap = await window.getDoc(classDocRef);
                if (snap.exists()) {
                    const data = snap.data() || {};
                    data.studentIds = (data.studentIds || []).filter((_, i) => i !== studentIndex);
                    data.studentNames = (data.studentNames || []).filter((_, i) => i !== studentIndex);
                    await window.setDoc(classDocRef, data);
                }
            } catch (e) {
                console.error('Error quitando alumno:', e);
            }
        };

        const initializeFirebase = async () => {
            try {
                const app = window.initializeApp(firebaseConfig);
                dbRef.current = window.getFirestore(app);
                authRef.current = window.getAuth(app);

                const unsubscribe = window.onAuthStateChanged(authRef.current, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setUserEmail(user.email);
                    } else {
                        setUserId(null);
                        setUserEmail('');
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                setMessageBox({
                    show: true,
                    title: 'Error de configuración',
                    content: 'Error al inicializar Firebase. Revisa tu configuración.',
                    type: 'error',
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
                setLoading(false);
            }
        };
        useEffect(() => {
            initializeFirebase();
        }, []);

        const signIn = async () => {
            try {
                setLoading(true);
                const auth = authRef.current;
                await window.setPersistence(auth, window.browserLocalPersistence);
                await window.signInWithEmailAndPassword(auth, email, password);
                setMessageBox({
                    show: true,
                    title: 'Inicio de Sesión Exitoso',
                    content: 'La sesión se mantendrá iniciada en este dispositivo.',
                    type: 'success',
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            } catch (error) {
                setMessageBox({
                    show: true,
                    title: 'Error de autenticación',
                    content: 'Usuario o contraseña incorrectos. Por favor, inténtalo de nuevo.',
                    type: 'error',
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
                console.error("Error signing in:", error);
            } finally {
                setLoading(false);
            }
        };
        const signUp = async () => {
            try {
                setLoading(true);
                const auth = authRef.current;
                await window.createUserWithEmailAndPassword(auth, email, password);
                setMessageBox({
                    show: true,
                    title: 'Cuenta creada',
                    content: 'Tu cuenta se ha creado exitosamente. ¡Ya puedes iniciar sesión!',
                    type: 'success',
                    onClose: () => {
                        setMessageBox({ ...messageBox, show: false });
                        setIsSigningUp(false);
                    }
                });
            } catch (error) {
                setMessageBox({
                    show: true,
                    title: 'Error de registro',
                    content: 'Hubo un error al crear la cuenta. Puede que el email ya esté en uso o la contraseña sea demasiado débil.',
                    type: 'error',
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
                console.error("Error signing up:", error);
            } finally {
                setLoading(false);
            }
        };
        const handlePasswordReset = async () => {
            if (!email) {
                setMessageBox({
                    show: true,
                    title: 'Error de validación',
                    content: 'Por favor, ingresa tu email para restablecer la contraseña.',
                    type: 'error',
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
                return;
            }
            try {
                setLoading(true);
                await window.sendPasswordResetEmail(authRef.current, email);
                setMessageBox({
                    show: true,
                    title: 'Correo enviado',
                    content: 'Se ha enviado un correo para restablecer tu contraseña. Revisa tu bandeja de entrada.',
                    type: 'success',
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
            } catch (error) {
                setMessageBox({
                    show: true,
                    title: 'Error al enviar correo',
                    content: 'Hubo un error al enviar el correo. Asegúrate de que el email sea correcto.',
                    type: 'error',
                    onClose: () => setMessageBox({ ...messageBox, show: false })
                });
                console.error("Error sending password reset email:", error);
            } finally {
                setLoading(false);
            }
        };
        const signOutUser = async () => {
            try {
                await window.signOut(authRef.current);
                setUserId(null);
                setClasses([]);
            } catch (error) {
                console.error("Error signing out:", error);
            }
        };
        const saveCustomPrices = async () => {
            if (!dbRef.current || !userId) return;
            try {
                setLoading(true);
                const userDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'config', 'prices');
                await window.setDoc(userDocRef, { prices: customPrices });
                setMessageBox({ show: true, title: 'Precios guardados', content: 'Los precios de las clases se han guardado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
            } catch (error) {
                setMessageBox({ show: true, title: 'Error al guardar', content: 'Hubo un error al guardar los precios.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                console.error("Error saving custom prices:", error);
            } finally {
                setLoading(false);
            }
        };
        const loadCustomPrices = async () => {
            if (!dbRef.current || !userId) return;
            try {
                const userDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'config', 'prices');
                const docSnap = await window.getDoc(userDocRef);
                if (docSnap.exists()) {
                    setCustomPrices(docSnap.data().prices);
                }
            } catch (error) {
                console.error("Error loading custom prices:", error);
            }
        };
        const addLogEntry = async (action, details) => {
            if (!dbRef.current || !userId) return;
            try {
                const logColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'activityLog');
                await window.addDoc(logColRef, {
                    action,
                    details,
                    timestamp: window.Timestamp.now()
                });
            } catch (error) {
                console.error("Error adding log entry:", error);
            }
        };
        const addStudent = async () => {
            if (!dbRef.current || !userId) return;
            if (!newStudent.firstName || !newStudent.lastName || !newStudent.phone) {
                setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, completa todos los campos del alumno.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                return;
            }
            try {
                setLoading(true);
                const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                if (isEditingStudent) {
                    const studentDocRef = window.doc(studentsColRef, editedStudentId);
                    await window.setDoc(studentDocRef, newStudent);
                    setMessageBox({ show: true, title: 'Alumno actualizado', content: 'El alumno se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } else {
                    await window.addDoc(studentsColRef, newStudent);
                    setMessageBox({ show: true, title: 'Alumno añadido', content: 'El nuevo alumno se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                }
                setNewStudent({ firstName: '', lastName: '', phone: '', description: '', status: 'Activo', schedule: [] });
                setIsEditingStudent(false);
                setEditedStudentId(null);
            } catch (error) {
                setMessageBox({ show: true, title: 'Error al guardar el alumno', content: 'Hubo un error al guardar los datos del alumno. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                console.error("Error adding/updating student:", error);
            } finally {
                setLoading(false);
            }
        };
        const editStudent = (studentToEdit) => {
            setNewStudent({ ...studentToEdit, schedule: studentToEdit.schedule || [] });
            setIsEditingStudent(true);
            setEditedStudentId(studentToEdit.id);
        };
        const deleteStudent = (studentId) => {
            setMessageBox({ show: true, title: 'Confirmar eliminación', content: '¿Estás seguro de que quieres eliminar a este alumno? Esta acción es irreversible.', type: 'confirm', onConfirm: async () => { if (!dbRef.current || !userId) return; try { setLoading(true); const studentDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'students', studentId); await window.deleteDoc(studentDocRef); setMessageBox({ show: true, title: 'Alumno eliminado', content: 'El alumno ha sido eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) }); } catch (error) { setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar al alumno. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) }); console.error("Error deleting student:", error); } finally { setLoading(false); } }, onClose: () => setMessageBox({ ...messageBox, show: false }) });
        };
        const sendWhatsApp = (phone) => {
            const formattedPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/${formattedPhone}`;
            window.open(url, '_blank');
        };
        const addPayment = async () => {
            if (!dbRef.current || !userId) return;
            if (!newPayment.date || !newPayment.amount || newPayment.amount <= 0) {
                setMessageBox({ show: true, title: 'Error de validación', content: 'Por favor, ingresa una fecha y un monto válido para el pago.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                return;
            }
            try {
                setLoading(true);
                const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');
                const paymentData = { ...newPayment, amount: parseFloat(newPayment.amount), date: newPayment.date, timestamp: window.Timestamp.fromDate(new Date(newPayment.date)) };
                if (isEditingPayment) {
                    const paymentDocRef = window.doc(paymentsColRef, editedPaymentId);
                    await window.setDoc(paymentDocRef, paymentData);
                    setMessageBox({ show: true, title: 'Pago actualizado', content: 'El pago se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } else {
                    await window.addDoc(paymentsColRef, paymentData);
                    setMessageBox({ show: true, title: 'Pago añadido', content: 'El nuevo pago se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                }
                setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' });
                setIsEditingPayment(false);
                setEditedPaymentId(null);
            } catch (error) {
                setMessageBox({ show: true, title: 'Error al guardar el pago', content: 'Hubo un error al guardar los datos del pago. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                console.error("Error adding/updating payment:", error);
            } finally {
                setLoading(false);
            }
        };
        const editPayment = (paymentToEdit) => {
            setNewPayment({ ...paymentToEdit, amount: paymentToEdit.amount.toString() });
            setIsEditingPayment(true);
            setEditedPaymentId(paymentToEdit.id);
        };
        const deletePayment = (paymentId) => {
            setMessageBox({ show: true, title: 'Confirmar eliminación', content: '¿Estás seguro de que quieres eliminar este pago? Esta acción es irreversible.', type: 'confirm', onConfirm: async () => { if (!dbRef.current || !userId) return; try { setLoading(true); const paymentDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments', paymentId); await window.deleteDoc(paymentDocRef); setMessageBox({ show: true, title: 'Pago eliminado', content: 'El pago ha sido eliminado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) }); } catch (error) { setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar el pago. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) }); console.error("Error deleting payment:", error); } finally { setLoading(false); } }, onClose: () => setMessageBox({ ...messageBox, show: false }) });
        };
        useEffect(() => {
            if (userId && dbRef.current) {
                loadCustomPrices();
                const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                const studentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'students');
                const paymentsColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'clubPayments');
                const logColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'activityLog');
                const classesQuery = window.query(classesColRef);
                const studentsQuery = window.query(studentsColRef);
                const paymentsQuery = window.query(paymentsColRef);
                const logQuery = window.query(logColRef);

                const unsubscribeClasses = window.onSnapshot(classesQuery, (snapshot) => {
                    const classesList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        date: doc.data().date instanceof window.Timestamp ? doc.data().date.toDate().toISOString().split('T')[0] : doc.data().date
                    }));
                    setClasses(classesList);
                });

                const unsubscribeStudents = window.onSnapshot(studentsQuery, (snapshot) => {
                    const studentsList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setStudents(studentsList);
                });

                const unsubscribePayments = window.onSnapshot(paymentsQuery, (snapshot) => {
                    const paymentsList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setPayments(paymentsList);
                });
                
                const unsubscribeLog = window.onSnapshot(logQuery, (snapshot) => {
                    const logList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setActivityLog(logList.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds));
                });

                return () => {
                    unsubscribeClasses();
                    unsubscribeStudents();
                    unsubscribePayments();
                    unsubscribeLog();
                };
            }
        }, [userId, dbRef.current]);

        const addNewClass = async () => {
            if (!dbRef.current || !userId) return;
            try {
                setLoading(true);
                const classesColRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, 'classes');
                
                if (isEditing) {
                    const classDocRef = window.doc(classesColRef, editedClassId);
                    await window.setDoc(classDocRef, {
                        ...newEntry,
                        date: window.Timestamp.fromDate(new Date(newEntry.date)),
                    });
                    await addLogEntry('Clase editada', `Se editó la clase del ${newEntry.date}`);
                    setMessageBox({ show: true, title: 'Clase actualizada', content: 'La clase se ha actualizado exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                } else {
                    await window.addDoc(classesColRef, {
                        ...newEntry,
                        date: window.Timestamp.fromDate(new Date(newEntry.date)),
                    });
                    await addLogEntry('Clase añadida', `Se agregó una clase para ${newEntry.studentCount} alumno(s) el ${newEntry.date}`);
                    setMessageBox({ show: true, title: 'Clase añadida', content: 'La nueva clase se ha añadido exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                }

                setNewEntry({
                    studentCount: 1,
                    studentNames: [''],
                    studentIds: [''],
                    date: new Date().toISOString().split('T')[0],
                    day: daysOfWeek[new Date().getDay()],
                    time: timesOfDay[0],
                    price: customPrices[1] || 0,
                });
                setIsEditing(false);
                setEditedClassId(null);
            } catch (error) {
                setMessageBox({ show: true, title: 'Error al guardar la clase', content: 'Hubo un error al guardar los datos de la clase. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                console.error("Error adding/updating document: ", error);
            } finally {
                setLoading(false);
            }
        };
            
        const editClass = (classToEdit) => {
            setNewEntry({
                ...classToEdit,
                date: classToEdit.date instanceof window.Timestamp ? classToEdit.date.toDate().toISOString().split('T')[0] : classToEdit.date
            });
            setIsEditing(true);
            setEditedClassId(classToEdit.id);
        };

        const deleteClass = (classId) => {
            setMessageBox({
                show: true,
                title: 'Confirmar eliminación',
                content: '¿Estás seguro de que quieres eliminar esta clase? Esta acción es irreversible.',
                type: 'confirm',
                onConfirm: async () => {
                    if (!dbRef.current || !userId) return;
                    try {
                        setLoading(true);
                        const classDocRef = window.doc(dbRef.current, 'artifacts', appId, 'users', userId, 'classes', classId);
                        await window.deleteDoc(classDocRef);
                        await addLogEntry('Clase eliminada', `Se eliminó la clase con ID ${classId}`);
                        setMessageBox({ show: true, title: 'Clase eliminada', content: 'La clase ha sido eliminada exitosamente.', type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    } catch (error) {
                        setMessageBox({ show: true, title: 'Error al eliminar', content: 'Hubo un error al eliminar la clase. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        console.error("Error removing document: ", error);
                    } finally {
                        setLoading(false);
                    }
                },
                onClose: () => setMessageBox({ ...messageBox, show: false })
            });
        };

        const generateReports = async () => {
            if (classes.length === 0) return {};
            
            const reports = classes.reduce((acc, cls) => {
                const date = new Date(cls.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                if (!acc[monthYear]) {
                    acc[monthYear] = { totalIncome: 0, classCount: 0, studentCount: 0 };
                }
                acc[monthYear].totalIncome += cls.price;
                acc[monthYear].classCount += 1;
                acc[monthYear].studentCount += cls.studentCount;
                return acc;
            }, {});

            const annualReport = payments.reduce((acc, payment) => {
                const date = new Date(payment.date);
                const year = date.getFullYear();
                if (!acc[year]) {
                    acc[year] = { totalIncome: 0 };
                }
                acc[year].totalIncome += payment.amount;
                return acc;
            }, {});

            setMonthlyReports(reports);
            setAnnualPaymentsReport(annualReport);
            return { monthlyReports: reports, annualPaymentsReport: annualReport };
        };
            
        useEffect(() => {
            generateReports();
        }, [classes, payments]);
            
        const handlePrintReport = (reportType) => {
            const isMonthly = reportType === 'monthly';
            const elementToPrint = isMonthly ? reportTableRef.current : annualPaymentsReportRef.current;
            const title = isMonthly ? `Reporte Mensual de Clases - ${formatMonthYear(selectedMonthYear)}` : "Reporte Anual de Pagos";
            
            if (elementToPrint) {
                window.jsPDF = jspdf.jsPDF;
                html2canvas(elementToPrint, {
                    backgroundColor: '#1f2937' 
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jsPDF('p', 'mm', 'a4');
                    const imgProps= pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    pdf.text(title, 14, 20);
                    pdf.addImage(imgData, 'PNG', 0, 30, pdfWidth, pdfHeight);
                    pdf.save(`${title.replace(/ /g, '_')}.pdf`);
                });
            }
        };
            
        const handleFilterChange = (e) => {
            setFilterText(e.target.value);
        };

        const filteredClasses = useMemo(() => {
            const term = filterText.toLowerCase();
            if (!term) return classes;
            return classes.filter(cls => 
                cls.studentNames.some(name => name.toLowerCase().includes(term)) ||
                cls.day.toLowerCase().includes(term) ||
                cls.time.toLowerCase().includes(term) ||
                cls.date.toLowerCase().includes(term) ||
                (cls.price && cls.price.toString().includes(term))
            );
        }, [classes, filterText]);
            
        const getPaginatedData = (data) => {
            const startIndex = (currentPage - 1) * classesPerPage;
            const endIndex = startIndex + classesPerPage;
            return data.slice(startIndex, endIndex);
        };
            
        const totalPages = Math.ceil(filteredClasses.length / classesPerPage);
        const currentClasses = getPaginatedData(filteredClasses);

        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        if (jsonData.classes) {
                            setMessageBox({
                                show: true,
                                title: 'Archivo cargado',
                                content: 'El archivo JSON se ha procesado exitosamente. Ahora puedes importar los datos a la base de datos.',
                                type: 'confirm',
                                onConfirm: () => {
                                    importDataToFirestore(jsonData.classes, 'classes');
                                    setMessageBox({ ...messageBox, show: false });
                                },
                                onClose: () => setMessageBox({ ...messageBox, show: false })
                            });
                        } else {
                            setMessageBox({ show: true, title: 'Error de archivo', content: 'El archivo JSON no tiene el formato correcto.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                        }
                    } catch (error) {
                        setMessageBox({ show: true, title: 'Error de archivo', content: 'El archivo no es un JSON válido.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                    }
                };
                reader.readAsText(file);
            }
        };
            
        const importDataToFirestore = async (data, collectionName) => {
            if (!dbRef.current || !userId) {
                setMessageBox({ show: true, title: 'Error de importación', content: 'No se pudo conectar a la base de datos. Por favor, inicia sesión.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
                return;
            }
            setLoading(true);
            const batch = window.writeBatch(dbRef.current);
            const colRef = window.collection(dbRef.current, 'artifacts', appId, 'users', userId, collectionName);
            
            try {
                data.forEach(item => {
                    const newDocRef = window.doc(colRef);
                    batch.set(newDocRef, { ...item, timestamp: window.Timestamp.now() });
                });
                await batch.commit();
                setMessageBox({ show: true, title: 'Importación exitosa', content: `Se han importado ${data.length} registros a Firestore.`, type: 'success', onClose: () => setMessageBox({ ...messageBox, show: false }) });
            } catch (error) {
                console.error("Error writing batch:", error);
                setMessageBox({ show: true, title: 'Error de importación', content: 'Hubo un error al escribir en la base de datos. Inténtalo de nuevo.', type: 'error', onClose: () => setMessageBox({ ...messageBox, show: false }) });
            } finally {
                setLoading(false);
            }
        };

        const getNextDayClasses = useMemo(() => {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const tomorrowDateString = tomorrow.toISOString().split('T')[0];
            const tomorrowDayOfWeek = daysOfWeek[tomorrow.getDay()];

            return classes.filter(cls => cls.date === tomorrowDateString);
        }, [classes]);

        const renderView = () => {
            switch (view) {
                case 'list':
                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">Clases Registradas</h2>
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
                                <input
                                    type="text"
                                    id="filterInput"
                                    value={filterText}
                                    onChange={handleFilterChange}
                                    className="p-3 w-full sm:w-auto border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all"
                                    placeholder="Buscar en clases..."
                                />
                                <div className="flex items-center space-x-2">
                                    <label htmlFor="classesPerPage" className="text-gray-400 text-sm">Mostrar:</label>
                                    <select
                                        id="classesPerPage"
                                        value={classesPerPage}
                                        onChange={(e) => {
                                            setClassesPerPage(Number(e.target.value));
                                            setCurrentPage(1);
                                        }}
                                        className="p-2 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 text-sm"
                                    >
                                        <option value={5}>5</option>
                                        <option value={10}>10</option>
                                        <option value={20}>20</option>
                                        <option value={50}>50</option>
                                    </select>
                                </div>
                            </div>
                            <div className="overflow-x-auto bg-gray-800 rounded-lg shadow-xl border border-gray-700">
                                <table className="min-w-full table-auto">
                                    <thead className="bg-gray-700 text-gray-200 uppercase text-xs">
                                        <tr className="border-b border-gray-600">
                                            <th className="py-3 px-4 text-left font-semibold">Fecha</th>
                                            <th className="py-3 px-4 text-left font-semibold">Día</th>
                                            <th className="py-3 px-4 text-left font-semibold">Hora</th>
                                            <th className="py-3 px-4 text-left font-semibold">Alumnos</th>
                                            <th className="py-3 px-4 text-left font-semibold">Precio</th>
                                            <th className="py-3 px-4 text-left font-semibold">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-700">
                                        {currentClasses.length > 0 ? (
                                            currentClasses.map((cls) => (
                                                <tr key={cls.id} className="hover:bg-gray-700 transition-colors">
                                                    <td className="py-3 px-4 text-sm">{cls.date}</td>
                                                    <td className="py-3 px-4 text-sm">{cls.day}</td>
                                                    <td className="py-3 px-4 text-sm">{cls.time}</td>
                                                    <td className="py-3 px-4 text-sm">
                                                        <div className="flex flex-wrap gap-1">
                                                            {cls.studentNames && cls.studentNames.map((name, studentIndex) => (
                                                                <span key={studentIndex} className="bg-gray-600 text-gray-100 rounded-full px-2 py-0.5 text-xs font-medium inline-flex items-center">
                                                                    {name}
                                                                    <button onClick={() => setReplaceData({ classId: cls.id, studentIndex })} className="ml-1 text-sky-400 hover:text-sky-300"><i className="fas fa-edit text-xs"></i></button>
                                                                    <button onClick={() => removeStudentFromClass(cls.id, studentIndex)} className="ml-1 text-red-400 hover:text-red-300"><i className="fas fa-trash-alt text-xs"></i></button>
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </td>
                                                    <td className="py-3 px-4 text-sm font-semibold text-green-400">{formatPrice(cls.price)}</td>
                                                    <td className="py-3 px-4 text-sm">
                                                        <button onClick={() => editClass(cls)} className="text-gray-400 hover:text-sky-400 transition-colors mr-2">
                                                            <i className="fas fa-edit"></i>
                                                        </button>
                                                        <button onClick={() => deleteClass(cls.id)} className="text-gray-400 hover:text-red-400 transition-colors">
                                                            <i className="fas fa-trash-alt"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="6" className="text-center text-gray-500 py-8 text-sm">
                                                    No hay clases registradas.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-4 flex justify-between items-center text-sm">
                                <p className="text-gray-400">Mostrando {currentClasses.length} de {filteredClasses.length} clases</p>
                                <div className="flex items-center space-x-2">
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                                        disabled={currentPage === 1}
                                        className="px-3 py-1 border border-gray-700 rounded-lg text-gray-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                        Anterior
                                    </button>
                                    <span className="text-gray-300">Página {currentPage} de {totalPages}</span>
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                                        disabled={currentPage === totalPages}
                                        className="px-3 py-1 border border-gray-700 rounded-lg text-gray-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                        Siguiente
                                    </button>
                                </div>
                            </div>
                        </>
                    );
                case 'next_day_classes':
                    const nextDay = new Date();
                    nextDay.setDate(nextDay.getDate() + 1);
                    const nextDayDateString = nextDay.toISOString().split('T')[0];
                    const nextDayName = daysOfWeek[nextDay.getDay()];

                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">Clases para el {nextDayName}, {nextDayDateString}</h2>
                            <div className="overflow-x-auto bg-gray-800 rounded-lg shadow-xl border border-gray-700">
                                <table className="min-w-full table-auto">
                                    <thead className="bg-gray-700 text-gray-200 uppercase text-xs">
                                        <tr className="border-b border-gray-600">
                                            <th className="py-3 px-4 text-left font-semibold">Hora</th>
                                            <th className="py-3 px-4 text-left font-semibold">Alumnos</th>
                                            <th className="py-3 px-4 text-left font-semibold">Precio</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-700">
                                        {getNextDayClasses.length > 0 ? (
                                            getNextDayClasses.map(cls => (
                                                <tr key={cls.id} className="hover:bg-gray-700 transition-colors">
                                                    <td className="py-3 px-4 text-sm">{cls.time}</td>
                                                    <td className="py-3 px-4 text-sm">
                                                        <div className="flex flex-wrap gap-1">
                                                            {cls.studentNames && cls.studentNames.map((name, studentIndex) => (
                                                                <span key={studentIndex} className="bg-gray-600 text-gray-100 rounded-full px-2 py-0.5 text-xs font-medium">
                                                                    {name}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </td>
                                                    <td className="py-3 px-4 text-sm font-semibold text-green-400">{formatPrice(cls.price)}</td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="3" className="text-center text-gray-500 py-8 text-sm">
                                                    No hay clases programadas para mañana.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    );
                case 'monthly_report':
                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">Reporte Mensual</h2>
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
                                <select
                                    value={selectedMonthYear}
                                    onChange={(e) => setSelectedMonthYear(e.target.value)}
                                    className="p-3 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 w-full sm:w-auto"
                                >
                                    <option value="">Seleccionar Mes</option>
                                    {Object.keys(monthlyReports).sort().reverse().map(key => (
                                        <option key={key} value={key}>{formatMonthYear(key)}</option>
                                    ))}
                                </select>
                                {selectedMonthYear && (
                                    <button onClick={() => handlePrintReport('monthly')} className="bg-teal-600 text-white px-5 py-3 rounded-lg hover:bg-teal-700 transition-colors w-full sm:w-auto text-sm">
                                        Descargar PDF <i className="fas fa-download ml-2"></i>
                                    </button>
                                )}
                            </div>
                            {selectedMonthYear && monthlyReports[selectedMonthYear] ? (
                                <div className="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700" ref={reportTableRef}>
                                    <h3 className="text-2xl font-bold mb-4 text-teal-400">Informe de {formatMonthYear(selectedMonthYear)}</h3>
                                    <p className="text-gray-300 text-lg">Clases Totales: <span className="font-bold text-white">{monthlyReports[selectedMonthYear].classCount}</span></p>
                                    <p className="text-gray-300 text-lg">Ingreso Total: <span className="font-bold text-green-400">{formatPrice(monthlyReports[selectedMonthYear].totalIncome)}</span></p>
                                    <p className="text-gray-300 text-lg">Alumnos Totales: <span className="font-bold text-white">{monthlyReports[selectedMonthYear].studentCount}</span></p>
                                </div>
                            ) : (
                                <p className="text-center text-gray-500 p-8">Selecciona un mes para ver el reporte.</p>
                            )}
                        </>
                    );
                case 'annual_report':
                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">Reporte Anual de Pagos al Club</h2>
                            <button onClick={() => handlePrintReport('annual')} className="bg-teal-600 text-white px-5 py-3 rounded-lg hover:bg-teal-700 transition-colors mb-4 text-sm">
                                Descargar PDF <i className="fas fa-download ml-2"></i>
                            </button>
                            <div className="overflow-x-auto bg-gray-800 rounded-lg shadow-xl border border-gray-700" ref={annualPaymentsReportRef}>
                                <table className="min-w-full table-auto">
                                    <thead className="bg-gray-700 text-gray-200 uppercase text-xs">
                                        <tr className="border-b border-gray-600">
                                            <th className="py-3 px-4 text-left font-semibold">Año</th>
                                            <th className="py-3 px-4 text-left font-semibold">Ingreso Total</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-700">
                                        {Object.keys(annualPaymentsReport).length > 0 ? (
                                            Object.keys(annualPaymentsReport).sort().reverse().map(year => (
                                                <tr key={year} className="hover:bg-gray-700 transition-colors">
                                                    <td className="py-3 px-4 text-sm">{year}</td>
                                                    <td className="py-3 px-4 text-green-400 font-bold text-sm">{formatPrice(annualPaymentsReport[year].totalIncome)}</td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="2" className="text-center text-gray-500 py-8 text-sm">
                                                    No hay datos de pagos para el reporte anual.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    );
                case 'add_student':
                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">{isEditingStudent ? "Editar Alumno" : "Añadir Nuevo Alumno"}</h2>
                            <div className="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 grid md:grid-cols-2 gap-6">
                                <div>
                                    <label htmlFor="firstName" className="block text-gray-400 font-semibold mb-2 text-sm">Nombre</label>
                                    <input
                                        type="text"
                                        id="firstName"
                                        value={newStudent.firstName}
                                        onChange={(e) => setNewStudent({ ...newStudent, firstName: e.target.value })}
                                        className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                        placeholder="Ej: Juan"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="lastName" className="block text-gray-400 font-semibold mb-2 text-sm">Apellido</label>
                                    <input
                                        type="text"
                                        id="lastName"
                                        value={newStudent.lastName}
                                        onChange={(e) => setNewStudent({ ...newStudent, lastName: e.target.value })}
                                        className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                        placeholder="Ej: Pérez"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="phone" className="block text-gray-400 font-semibold mb-2 text-sm">Teléfono</label>
                                    <input
                                        type="tel"
                                        id="phone"
                                        value={newStudent.phone}
                                        onChange={(e) => setNewStudent({ ...newStudent, phone: e.target.value })}
                                        className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                        placeholder="Ej: 3815551234"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="description" className="block text-gray-400 font-semibold mb-2 text-sm">Descripción (opcional)</label>
                                    <textarea
                                        id="description"
                                        value={newStudent.description}
                                        onChange={(e) => setNewStudent({ ...newStudent, description: e.target.value })}
                                        className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                        placeholder="Ej: Alumno avanzado, de 16 años"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="status" className="block text-gray-400 font-semibold mb-2 text-sm">Estado</label>
                                    <select
                                        id="status"
                                        value={newStudent.status}
                                        onChange={(e) => setNewStudent({ ...newStudent, status: e.target.value })}
                                        className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 text-sm"
                                    >
                                        <option value="Activo">Activo</option>
                                        <option value="Inactivo">Inactivo</option>
                                        <option value="Potencial">Potencial</option>
                                    </select>
                                </div>
                                <div>
                                    <h3 className="block text-gray-400 font-semibold mb-2 text-sm">Horario de Clases</h3>
                                    <div className="grid grid-cols-2 gap-4 p-3 bg-gray-900 rounded-lg text-sm border border-gray-700">
                                        <select
                                            className="w-full p-2 border border-gray-700 rounded-lg bg-gray-800 text-gray-200"
                                            onChange={(e) => {
                                                const day = e.target.value;
                                                const time = newStudent.schedule.find(s => s.day === day)?.time || '';
                                                setNewStudent(prev => ({
                                                    ...prev,
                                                    schedule: prev.schedule.map(s => s.day === day ? { ...s, time } : s)
                                                }));
                                            }}
                                        >
                                            <option value="">Seleccionar Día</option>
                                            {daysOfWeek.map(day => <option key={day} value={day}>{day}</option>)}
                                        </select>
                                        <select
                                            className="w-full p-2 border border-gray-700 rounded-lg bg-gray-800 text-gray-200"
                                            onChange={(e) => {
                                                const time = e.target.value;
                                                const newSchedule = newStudent.schedule.length > 0 ? [...newStudent.schedule] : [{ day: daysOfWeek[0], time }];
                                                setNewStudent(prev => ({
                                                    ...prev,
                                                    schedule: newSchedule.map(s => s.day === newStudent.schedule[0]?.day ? { ...s, time } : s)
                                                }));
                                            }}
                                        >
                                            <option value="">Seleccionar Hora</option>
                                            {timesOfDay.map(time => <option key={time} value={time}>{time}</option>)}
                                        </select>
                                    </div>
                                    <div className="mt-3 space-y-2">
                                        {newStudent.schedule.map((sch, index) => (
                                            <div key={index} className="flex items-center justify-between p-3 bg-gray-700 rounded-lg text-sm">
                                                <span className="text-xs text-gray-200">{sch.day} - {sch.time}</span>
                                                <button onClick={() => setNewStudent(prev => ({
                                                    ...prev,
                                                    schedule: prev.schedule.filter((_, i) => i !== index)
                                                }))} className="text-red-400 hover:text-red-300">
                                                    <i className="fas fa-times-circle"></i>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    <button
                                        onClick={() => {
                                            const newDay = newStudent.schedule.length > 0 ? daysOfWeek[(daysOfWeek.indexOf(newStudent.schedule[newStudent.schedule.length - 1].day) + 1) % 7] : daysOfWeek[0];
                                            setNewStudent(prev => ({
                                                ...prev,
                                                schedule: [...prev.schedule, { day: newDay, time: '' }]
                                            }));
                                        }}
                                        className="mt-4 w-full py-3 px-5 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                    >
                                        + Agregar Horario
                                    </button>
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end space-x-2">
                                {isEditingStudent && (
                                    <button onClick={() => {
                                        setIsEditingStudent(false);
                                        setEditedStudentId(null);
                                        setNewStudent({ firstName: '', lastName: '', phone: '', description: '', status: 'Activo', schedule: [] });
                                    }} className="px-5 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
                                        Cancelar
                                    </button>
                                )}
                                <button
                                    onClick={addStudent}
                                    className="px-5 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors shadow-md text-sm"
                                >
                                    {isEditingStudent ? "Actualizar Alumno" : "Añadir Alumno"}
                                </button>
                            </div>
                        </>
                    );
                case 'students_list':
                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">Lista de Alumnos</h2>
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
                                <input
                                    type="text"
                                    placeholder="Buscar por nombre, apellido o teléfono..."
                                    value={studentSearch}
                                    onChange={(e) => setStudentSearch(e.target.value)}
                                    className="p-3 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 w-full md:w-1/2 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                />
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="p-3 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 text-sm"
                                >
                                    <option value="Todos">Todos</option>
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                    <option value="Potencial">Potencial</option>
                                </select>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredStudentsList.length > 0 ? (
                                    filteredStudentsList.map((student) => (
                                        <div key={student.id} className="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 flex flex-col justify-between">
                                            <div>
                                                <h3 className="text-xl font-bold text-teal-400">{student.firstName} {student.lastName}</h3>
                                                <p className="text-sm text-gray-400 mt-1"><i className="fas fa-phone mr-2"></i>{student.phone}</p>
                                                <p className="text-xs text-gray-500 mt-2">{student.description}</p>
                                                <div className="mt-4 flex flex-wrap gap-2">
                                                    <span className={`inline-block px-3 py-1 text-xs font-semibold rounded-full ${student.status === 'Activo' ? 'bg-green-600 text-green-100' : student.status === 'Inactivo' ? 'bg-red-600 text-red-100' : 'bg-yellow-600 text-yellow-100'}`}>
                                                        {student.status}
                                                    </span>
                                                    {student.schedule && student.schedule.map((sch, index) => (
                                                        <span key={index} className="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-indigo-600 text-indigo-100">
                                                            {sch.day} - {sch.time}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="mt-6 flex space-x-2">
                                                <button onClick={() => sendWhatsApp(student.phone)} className="flex-1 py-3 px-5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors shadow-md text-sm">
                                                    <i className="fab fa-whatsapp"></i>
                                                </button>
                                                <button onClick={() => editStudent(student)} className="py-3 px-5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors shadow-md text-sm">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => deleteStudent(student.id)} className="py-3 px-5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors shadow-md text-sm">
                                                    <i className="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="col-span-full text-center text-gray-500 p-8 bg-gray-800 rounded-lg shadow-xl">
                                        No se encontraron alumnos.
                                    </div>
                                )}
                            </div>
                        </>
                    );
                case 'club_payments':
                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">{isEditingPayment ? "Editar Pago" : "Añadir Nuevo Pago al Club"}</h2>
                            <div className="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700">
                                <div className="grid md:grid-cols-3 gap-6">
                                    <div>
                                        <label htmlFor="paymentDate" className="block text-gray-400 font-semibold mb-2 text-sm">Fecha</label>
                                        <input
                                            type="date"
                                            id="paymentDate"
                                            value={newPayment.date}
                                            onChange={(e) => setNewPayment({ ...newPayment, date: e.target.value })}
                                            className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="paymentAmount" className="block text-gray-400 font-semibold mb-2 text-sm">Monto</label>
                                        <input
                                            type="number"
                                            id="paymentAmount"
                                            value={newPayment.amount}
                                            onChange={(e) => setNewPayment({ ...newPayment, amount: e.target.value })}
                                            className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                            placeholder="Ej: 10000"
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="paymentDescription" className="block text-gray-400 font-semibold mb-2 text-sm">Descripción</label>
                                        <textarea
                                            id="paymentDescription"
                                            value={newPayment.description}
                                            onChange={(e) => setNewPayment({ ...newPayment, description: e.target.value })}
                                            className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                            placeholder="Ej: Alquiler de cancha"
                                        />
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end space-x-2">
                                    {isEditingPayment && (
                                        <button onClick={() => {
                                            setIsEditingPayment(false);
                                            setEditedPaymentId(null);
                                            setNewPayment({ date: new Date().toISOString().split('T')[0], amount: 0, description: '' });
                                        }} className="px-5 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
                                            Cancelar
                                        </button>
                                    )}
                                    <button
                                        onClick={addPayment}
                                        className="px-5 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors shadow-md text-sm"
                                    >
                                        {isEditingPayment ? "Actualizar Pago" : "Añadir Pago"}
                                    </button>
                                </div>
                            </div>
                            
                            <h3 className="text-xl font-bold mt-8 mb-4 text-white">Historial de Pagos</h3>
                            <div className="bg-gray-800 rounded-lg shadow-xl border border-gray-700 overflow-x-auto">
                                <table className="min-w-full table-auto">
                                    <thead className="bg-gray-700 text-gray-200 uppercase text-xs">
                                        <tr className="border-b border-gray-600">
                                            <th className="py-3 px-4 text-left font-semibold">Fecha</th>
                                            <th className="py-3 px-4 text-left font-semibold">Monto</th>
                                            <th className="py-3 px-4 text-left font-semibold">Descripción</th>
                                            <th className="py-3 px-4 text-left font-semibold">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-700">
                                        {payments.length > 0 ? (
                                            payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(payment => (
                                                <tr key={payment.id} className="hover:bg-gray-700 transition-colors">
                                                    <td className="py-3 px-4 text-sm">{payment.date}</td>
                                                    <td className="py-3 px-4 text-sm text-green-400 font-semibold">{formatPrice(payment.amount)}</td>
                                                    <td className="py-3 px-4 text-sm">{payment.description}</td>
                                                    <td className="py-3 px-4 text-sm">
                                                        <button onClick={() => editPayment(payment)} className="text-gray-400 hover:text-sky-400 transition-colors mr-2">
                                                            <i className="fas fa-edit"></i>
                                                        </button>
                                                        <button onClick={() => deletePayment(payment.id)} className="text-gray-400 hover:text-red-400 transition-colors">
                                                            <i className="fas fa-trash-alt"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="4" className="text-center text-gray-500 py-8 text-sm">No hay pagos registrados.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    );
                case 'activity_log':
                    return (
                        <>
                            <h2 className="text-3xl font-bold mb-6 text-white">Registro de Actividad</h2>
                            <div className="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 max-h-96 overflow-y-auto">
                                {activityLog.length > 0 ? (
                                    <ul className="space-y-4">
                                        {activityLog.map(log => (
                                            <li key={log.id} className="p-4 bg-gray-700 rounded-lg border border-gray-600">
                                                <p className="font-semibold text-gray-100 text-sm">{log.action}</p>
                                                <p className="text-xs text-gray-400">{log.details}</p>
                                                <span className="text-gray-500 text-xs mt-1 block">{formatDate(log.timestamp)}</span>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-center text-gray-500 p-8">No hay actividad reciente.</p>
                                )}
                            </div>
                        </>
                    );
                default:
                    return null;
            }
        };

        if (loading) {
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-900">
                    <div className="flex flex-col items-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-teal-500"></div>
                        <p className="mt-4 text-gray-400">Cargando...</p>
                    </div>
                </div>
            );
        }

        if (!userId) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900">
                    <div className="bg-gray-800 p-10 rounded-xl shadow-lg w-full max-w-sm text-center border border-gray-700">
                        <h2 className="text-3xl font-bold mb-6 text-white">{isSigningUp ? "Registrarme" : "Iniciar Sesión"}</h2>
                        <div className="mb-4 text-left">
                            <label className="block text-gray-400 text-sm font-bold mb-2" htmlFor="email">
                                Email
                            </label>
                            <input
                                className="shadow-md appearance-none border border-gray-700 rounded-lg w-full py-3 px-4 bg-gray-900 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"
                                id="email"
                                type="email"
                                placeholder="email@ejemplo.com"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                disabled={loading}
                            />
                        </div>
                        <div className="mb-6 text-left">
                            <label className="block text-gray-400 text-sm font-bold mb-2" htmlFor="password">
                                Contraseña
                            </label>
                            <input
                                className="shadow-md appearance-none border border-gray-700 rounded-lg w-full py-3 px-4 bg-gray-900 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"
                                id="password"
                                type="password"
                                placeholder="********"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                disabled={loading}
                            />
                            <button onClick={handlePasswordReset} className="mt-2 text-xs text-sky-400 hover:text-sky-300">¿Olvidaste tu contraseña?</button>
                        </div>
                        <div className="flex flex-col space-y-4">
                            <button
                                onClick={isSigningUp ? signUp : signIn}
                                className={`w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors shadow-md ${loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-teal-700'}`}
                                disabled={loading}
                            >
                                {loading ? "Cargando..." : isSigningUp ? "Registrarme" : "Iniciar Sesión"}
                            </button>
                            <button
                                onClick={() => setIsSigningUp(!isSigningUp)}
                                className="w-full text-teal-400 font-bold py-3 px-4 rounded-lg border border-teal-400 hover:bg-teal-900 transition-colors text-sm"
                            >
                                {isSigningUp ? "Ya tengo una cuenta" : "Crear una cuenta"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const renderTopNav = () => (
            <nav className="bg-gray-800 p-4 shadow-xl border-b border-gray-700">
                <div className="container mx-auto flex flex-wrap justify-center sm:justify-between items-center text-sm">
                    <div className="flex flex-wrap justify-center sm:justify-start gap-4 mb-2 sm:mb-0">
                        <button onClick={() => setView('add_class')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'add_class' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-plus-circle mr-2"></i>Añadir Clase
                        </button>
                        <button onClick={() => setView('list')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'list' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-clipboard-list mr-2"></i>Lista de Clases
                        </button>
                        <button onClick={() => setView('next_day_classes')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'next_day_classes' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-calendar-check mr-2"></i>Próx. Día
                        </button>
                        <button onClick={() => setView('add_student')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'add_student' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-user-plus mr-2"></i>Añadir Alumno
                        </button>
                        <button onClick={() => setView('students_list')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'students_list' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-users mr-2"></i>Lista de Alumnos
                        </button>
                        <button onClick={() => setView('monthly_report')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'monthly_report' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-chart-bar mr-2"></i>Reporte Mensual
                        </button>
                        <button onClick={() => setView('annual_report')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'annual_report' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-calendar-alt mr-2"></i>Pagos Anuales
                        </button>
                        <button onClick={() => setView('club_payments')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'club_payments' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-hand-holding-usd mr-2"></i>Pagos Club
                        </button>
                        <button onClick={() => setView('activity_log')} className={`px-4 py-2 rounded-lg transition-colors ${view === 'activity_log' ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}>
                            <i className="fas fa-history mr-2"></i>Registro
                        </button>
                    </div>
                </div>
            </nav>
        );

        return (
            <div className="min-h-screen bg-gray-900 flex flex-col">
                <MessageBox {...messageBox} onClose={() => setMessageBox({ ...messageBox, show: false })} />
                <ReplaceModal 
                    replaceData={replaceData} 
                    setReplaceData={setReplaceData} 
                    students={students} 
                    replaceStudentInClass={replaceStudentInClass}
                />
                
                {/* Header */}
                <header className="bg-gray-800 shadow-lg p-4 border-b-2 border-teal-500 z-10">
                    <div className="container mx-auto flex justify-between items-center">
                        <h1 className="text-3xl font-bold text-teal-400">Padel Manager Pro</h1>
                        <div className="flex items-center space-x-4">
                            <span className="text-sm text-gray-400 hidden md:block">{userEmail}</span>
                            <button onClick={signOutUser} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors shadow-md text-sm">
                                Cerrar Sesión
                            </button>
                        </div>
                    </div>
                </header>
                
                {/* Main Content Area */}
                <main className="flex-1 container mx-auto p-4 md:p-8">
                    {renderTopNav()}
                    <div className="mt-8 bg-gray-800 p-8 rounded-xl shadow-xl border border-gray-700">
                        {view === 'add_class' ? (
                            <>
                                <h2 className="text-3xl font-bold mb-6 text-white">{isEditing ? "Editar Clase" : "Añadir Nueva Clase"}</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                    <div>
                                        <label htmlFor="studentCount" className="block text-gray-400 font-semibold mb-2 text-sm">Cantidad de Alumnos</label>
                                        <select
                                            id="studentCount"
                                            value={newEntry.studentCount}
                                            onChange={(e) => {
                                                const count = Number(e.target.value);
                                                const newNames = Array(count).fill('');
                                                const newIds = Array(count).fill('');
                                                const price = customPrices[count] || 0;
                                                setNewEntry(prev => ({ ...prev, studentCount: count, studentNames: newNames, studentIds: newIds, price }));
                                            }}
                                            className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 text-sm"
                                        >
                                            {peopleOptions.map(option => (
                                                <option key={option} value={option}>{option}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label htmlFor="date" className="block text-gray-400 font-semibold mb-2 text-sm">Fecha</label>
                                        <input
                                            type="date"
                                            id="date"
                                            value={newEntry.date}
                                            onChange={(e) => {
                                                const selectedDate = new Date(e.target.value);
                                                setNewEntry(prev => ({
                                                    ...prev,
                                                    date: e.target.value,
                                                    day: daysOfWeek[selectedDate.getDay()]
                                                }));
                                            }}
                                            className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="day" className="block text-gray-400 font-semibold mb-2 text-sm">Día</label>
                                        <input
                                            type="text"
                                            id="day"
                                            value={newEntry.day}
                                            className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 text-sm"
                                            readOnly
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="time" className="block text-gray-400 font-semibold mb-2 text-sm">Horario</label>
                                        <select
                                            id="time"
                                            value={newEntry.time}
                                            onChange={(e) => setNewEntry(prev => ({ ...prev, time: e.target.value }))}
                                            className="w-full p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 text-sm"
                                        >
                                            {timesOfDay.map(time => (
                                                <option key={time} value={time}>{time}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                    
                                <h3 className="text-xl font-bold mb-4 mt-6 text-white">Alumnos</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                                    {Array.from({ length: newEntry.studentCount }).map((_, index) => (
                                        <AutocompleteStudentInput
                                            key={index}
                                            index={index}
                                            newEntry={newEntry}
                                            setNewEntry={setNewEntry}
                                            students={students}
                                        />
                                    ))}
                                </div>
                                <div className="flex items-center justify-between bg-gray-900 p-4 rounded-lg shadow-inner border border-gray-700">
                                    <span className="font-semibold text-gray-400 text-sm">Precio Estimado:</span>
                                    <span className="text-2xl font-bold text-green-400">{formatPrice(newEntry.price)}</span>
                                </div>
                                <div className="mt-6 flex justify-end space-x-2">
                                    {isEditing && (
                                        <button onClick={() => {
                                            setIsEditing(false);
                                            setEditedClassId(null);
                                            setNewEntry({
                                                studentCount: 1,
                                                studentNames: [''],
                                                studentIds: [''],
                                                date: new Date().toISOString().split('T')[0],
                                                day: daysOfWeek[new Date().getDay()],
                                                time: timesOfDay[0],
                                                price: customPrices[1] || 0,
                                            });
                                        }} className="px-5 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
                                            Cancelar
                                        </button>
                                    )}
                                    <button
                                        onClick={addNewClass}
                                        className="px-5 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors shadow-md text-sm"
                                        disabled={newEntry.studentNames.some(name => !name)}
                                    >
                                        {isEditing ? "Actualizar Clase" : "Añadir Clase"}
                                    </button>
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="mb-6 flex flex-wrap gap-4">
                                    <button onClick={() => setShowConfigModal(true)} className="flex-1 min-w-[120px] bg-gray-700 text-gray-200 py-3 px-5 rounded-lg hover:bg-gray-600 transition-colors shadow-md text-sm">
                                        <i className="fas fa-cog mr-2"></i> Configurar
                                    </button>
                                    <button onClick={() => fileInputRef.current.click()} className="flex-1 min-w-[120px] bg-gray-700 text-gray-200 py-3 px-5 rounded-lg hover:bg-gray-600 transition-colors shadow-md text-sm">
                                        <i className="fas fa-upload mr-2"></i> Subir Archivo
                                    </button>
                                    <input
                                        type="file"
                                        ref={fileInputRef}
                                        onChange={handleFileUpload}
                                        className="hidden"
                                        accept=".json"
                                    />
                                </div>
                                {showConfigModal && (
                                    <div className="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
                                        <div className="bg-gray-800 p-10 rounded-xl shadow-xl w-full max-w-lg">
                                            <h3 className="text-2xl font-bold mb-6 text-teal-400">Configurar Precios de Clases</h3>
                                            <div className="space-y-4">
                                                {peopleOptions.map(count => (
                                                    <div key={count} className="flex items-center justify-between">
                                                        <label htmlFor={`price-${count}`} className="text-gray-400 text-sm">
                                                            {count} {count === 1 ? 'Alumno' : 'Alumnos'}
                                                        </label>
                                                        <input
                                                            type="number"
                                                            id={`price-${count}`}
                                                            value={customPrices[count] || ''}
                                                            onChange={(e) => setCustomPrices({ ...customPrices, [count]: Number(e.target.value) })}
                                                            className="w-1/2 p-3 border border-gray-700 rounded-lg bg-gray-900 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-teal-500 transition-all text-sm"
                                                            placeholder="Precio en ARS"
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="mt-8 flex justify-end space-x-2">
                                                <button onClick={() => {
                                                    setShowConfigModal(false);
                                                    setCustomPrices(defaultClassPrices); 
                                                }} className="px-5 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
                                                    Cancelar
                                                </button>
                                                <button onClick={() => {
                                                    saveCustomPrices();
                                                    setShowConfigModal(false);
                                                }} className="px-5 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors shadow-md text-sm">
                                                    Guardar Cambios
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {renderView()}
                            </>
                        )}
                    </div>
                </main>
                {userId && (
                    <footer className="mt-8 text-center text-gray-500 text-xs pb-4">
                        ID de Usuario: <span className="font-mono">{userId}</span>
                    </footer>
                )}
            </div>
        );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
